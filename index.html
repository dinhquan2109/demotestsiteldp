<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Placement Test Dashboard</title>
    
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob:;
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://accounts.google.com https://apis.google.com https://www.gstatic.com https://ssl.gstatic.com https://esm.sh;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://accounts.google.com;
        font-src 'self' https://fonts.gstatic.com;
        img-src 'self' data: blob: https: https://www.gstatic.com;
        connect-src 'self' https://axllpuaybdzubfmsfkws.supabase.co https://accounts.google.com https://www.googleapis.com https://oauth2.googleapis.com https://gmail.googleapis.com https://cdnjs.cloudflare.com wss:;
        frame-src 'self' https://accounts.google.com https://accounts.google.com/gsi/;
        object-src 'none';
        base-uri 'self';
        form-action 'self';
    ">
    
    <!-- CORS and Security Headers -->
    <meta http-equiv="Cross-Origin-Opener-Policy" content="unsafe-none">
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="unsafe-none">
    <meta http-equiv="Cross-Origin-Resource-Policy" content="cross-origin">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        h1 {
            color: #11998e;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .search-bar {
            display: flex;
            gap: 15px;
            flex-wrap: nowrap;
            align-items: end;
        }

        .search-group {
            flex: 1;
            min-width: 180px;
        }

        .search-actions {
            display: flex;
            gap: 10px;
            align-items: end;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
            font-size: 0.9em;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #11998e;
            box-shadow: 0 0 0 3px rgba(17, 153, 142, 0.1);
        }

        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
            background: white;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: #11998e;
            box-shadow: 0 0 0 3px rgba(17, 153, 142, 0.1);
        }

        .btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            align-self: flex-end;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .table-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        thead {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            border-right: 2px solid rgba(255, 255, 255, 0.3);
        }

        th:last-child {
            border-right: none;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            border-right: 1px solid #f0f0f0;
            vertical-align: top;
        }

        td:last-child {
            border-right: none;
        }

        tbody tr {
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #f0fdf4;
        }

        .score-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .score-low { background: #fee; color: #c33; }
        .score-mid { background: #fff4e6; color: #e67700; }
        .score-high { background: #d1fae5; color: #065f46; }

        .recommended-level {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .level-excellent {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 2px solid #34d399;
        }

        .level-fail {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 2px solid #f87171;
        }

        .level-hsk1-badge {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            border: 1px solid #3b82f6;
        }

        .level-hsk2-badge {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border: 1px solid #f59e0b;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2em;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .answers-cell {
            max-width: 250px;
            max-height: 120px;
            overflow-y: auto;
            font-size: 0.8em;
            line-height: 1.4;
        }

        .answer-item {
            padding: 6px 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        .answer-item:last-child {
            border-bottom: none;
        }

        .answer-label {
            font-weight: 700;
            color: #11998e;
            display: inline-block;
            min-width: 30px;
        }

        .answer-value {
            color: #333;
            word-break: break-word;
        }

        .time-cell {
            white-space: nowrap;
            font-size: 0.9em;
        }

        .send-email-btn {
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .send-email-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
            background: linear-gradient(135deg, #ff5722 0%, #ff7733 100%);
        }

        .send-email-btn:active {
            transform: translateY(0);
        }

        .copy-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-left: 8px;
        }

        .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #5568d3 0%, #6a3f91 100%);
        }

        .copy-btn:active {
            transform: translateY(0);
        }

        .ai-feedback-btn {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #78350f;
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 8px;
            width: 100%;
            justify-content: center;
            text-align: center;
        }

        .ai-feedback-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .ai-feedback-btn:active {
            transform: translateY(0);
        }

        .ai-feedback-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .action-cell {
            white-space: nowrap;
        }

        .action-buttons-wrapper {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .action-buttons-top {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .action-buttons-top .send-email-btn,
        .action-buttons-top .copy-btn,
        .ai-feedback-btn {
            flex: 1;
            min-width: 0;
            text-align: center;
            justify-content: center;
            display: flex;
            align-items: center;
            margin-top: 0;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 0;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            padding: 25px 30px;
            border-bottom: 3px solid #fbbf24;
            border-radius: 15px 15px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 800;
            color: #92400e;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #92400e;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .modal-close:hover {
            background: white;
            color: #78350f;
            transform: rotate(90deg);
        }

        .pdf-export-btn {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-left: 15px;
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
        }

        .pdf-export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
            background: linear-gradient(135deg, #b91c1c 0%, #dc2626 100%);
        }

        .pdf-export-btn:active {
            transform: translateY(0);
        }

        .action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            min-height: 40px;
            text-align: center;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #5568d3 0%, #6a3f91 100%);
        }

        .action-btn:active {
            transform: translateY(0);
        }

        .modal-body {
            padding: 30px;
        }

        .student-info {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #fbbf24;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
        }

        .student-info h3 {
            color: #1e7e5f;
            margin-bottom: 12px;
            font-size: 18px;
        }

        .student-info p {
            color: #555;
            margin: 8px 0;
            font-size: 14px;
        }

        .student-info strong {
            color: #333;
            font-weight: 600;
        }

        .test-result-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #11998e;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
        }

        .test-result-section h3 {
            color: #11998e;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .score-display {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .score-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            text-align: center;
        }

        .score-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            display: inline-block;
            margin-left: 10px;
        }

        .result-details {
            background: rgba(255, 255, 255, 0.9);
            padding: 0;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            gap: 0;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            align-items: stretch;
        }

        .result-item {
            text-align: center;
            padding: 12px 8px;
            border-right: 1px solid #e9ecef;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 70px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            width: 33.333%;
            box-sizing: border-box;
        }

        .result-item:last-child {
            border-right: none;
        }

        .result-item h4 {
            margin: 0 0 6px 0;
            font-size: 12px;
            font-weight: 600;
            color: #2c3e50;
        }

        .result-item p {
            margin: 0;
            font-size: 11px;
            line-height: 1.3;
        }

        .result-item h4 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .status-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            text-transform: uppercase;
            display: inline-block;
        }

        .status-excellent {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 2px solid #34d399;
        }

        .status-fail {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 2px solid #f87171;
        }

        .comment-text, .path-text {
            font-size: 1em;
            line-height: 1.5;
            color: #495057;
            margin: 0;
            font-weight: 500;
        }

        .path-text {
            color: #11998e;
            font-weight: bold;
        }

        .answers-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
            border-left: 4px solid #11998e;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .answers-section.listening {
            border-left: 4px solid #11998e;
        }
        
        .answers-section.reading {
            border-left: 4px solid #11998e;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e7e5f;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title span {
            color: #11998e;
            font-weight: 800;
        }

        .answers-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: flex-start;
        }

        .answer-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 12px;
            transition: transform 0.2s;
            position: relative;
            cursor: pointer;
            white-space: nowrap;
            min-width: 60px;
        }

        .answer-badge:hover {
            transform: scale(1.05);
        }

        .answer-tooltip {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .answer-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #1f2937;
        }

        .answer-badge:hover .answer-tooltip {
            display: block;
        }

        .answer-correct {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #34d399;
        }

        .answer-incorrect {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #f87171;
        }

        .answer-icon {
            margin-left: 6px;
            font-size: 16px;
        }

        .writing-section {
            background: rgba(255, 255, 255, 0.95);
            border: 2.5px solid #fbbf24;
            border-radius: 15px;
            padding: 22px 26px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .writing-section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            pointer-events: none;
        }

        .writing-title {
            font-weight: 800;
            color: #92400e;
            margin-bottom: 14px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            z-index: 1;
        }

        .writing-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            box-shadow: 0 3px 10px rgba(251, 191, 36, 0.4);
        }

        .writing-content {
            color: #78350f;
            line-height: 1.7;
            font-size: 15px;
            position: relative;
            z-index: 1;
        }

        .writing-content p {
            background: rgba(255, 255, 255, 0.5);
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 3px solid #fbbf24;
        }

        .writing-content p:last-child {
            margin-bottom: 0;
        }

        .essay-display {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
        }

        .essay-display h4 {
            color: #1e7e5f;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .essay-text {
            color: #333;
            line-height: 1.8;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #11998e;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #0d7a6f;
        }

        /* Email Modal Styles - Giống như modal tổng quan bài làm */
        .email-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #e5e7eb;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #1e7e5f;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }

        .form-group input:focus {
            outline: none;
            border-color: #11998e;
            box-shadow: 0 0 0 3px rgba(17, 153, 142, 0.1);
        }

        .email-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        .email-actions .btn,
        .email-actions .copy-btn {
            flex: 1;
            max-width: 200px;
            padding: 12px 20px;
            font-size: 14px;
        }

        /* Student info section giống như modal tổng quan */
        .email-student-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid #fbbf24;
        }

        .email-student-info h3 {
            color: #1e7e5f;
            margin-bottom: 12px;
            font-size: 18px;
        }

        .email-student-info p {
            color: #555;
            margin: 8px 0;
            font-size: 14px;
        }

        .email-student-info strong {
            color: #333;
            font-weight: 600;
        }

        /* Test result section giống như modal tổng quan */
        .email-test-result-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid #11998e;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .email-test-result-section h3 {
            color: #11998e;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .email-score-display {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .email-score-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            text-align: center;
        }

        .email-score-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            display: inline-block;
            margin-left: 10px;
        }

        .email-result-details {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .email-result-item {
            text-align: center;
            padding: 10px;
            border-right: 1px solid #e9ecef;
        }

        .email-result-item:last-child {
            border-right: none;
        }

        .email-result-item h4 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .email-status-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            text-transform: uppercase;
            display: inline-block;
        }

        .email-status-excellent {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 2px solid #34d399;
        }

        .email-status-fail {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 2px solid #f87171;
        }

        .email-comment-text, .email-path-text {
            font-size: 1em;
            line-height: 1.5;
            color: #495057;
            margin: 0;
            font-weight: 500;
        }

        .email-path-text {
            color: #11998e;
            font-weight: bold;
        }

        /* Login Modal Styles */
        .login-form {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            text-align: center;
        }

        .login-info {
            margin-bottom: 30px;
        }

        .login-info h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 24px;
        }

        .login-info p {
            color: #6c757d;
            font-size: 16px;
            line-height: 1.6;
        }

        .google-login-container {
            margin: 30px 0;
            display: flex;
            justify-content: center;
        }

        .login-footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .login-footer p {
            color: #6c757d;
            font-size: 14px;
            margin: 0;
        }

        /* User info display */
        .user-info {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-details {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-email {
            font-size: 12px;
            opacity: 0.9;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Hide content when not logged in */
        .content-protected {
            display: none;
        }

        .content-protected.show {
            display: block;
        }

        /* Debug tools styling */
        .email-debug-actions {
            transition: all 0.3s ease;
            max-height: 200px;
            overflow: hidden;
        }

        .email-debug-actions.collapsed {
            max-height: 0;
            overflow: hidden;
            margin-top: 0;
            padding-top: 0;
            border-top: none;
        }

        .debug-toggle {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #6c757d;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            margin-bottom: 8px;
            display: inline-block;
        }

        .debug-toggle:hover {
            background: #e9ecef;
        }

        /* Responsive design for result details */
        @media (max-width: 600px) {
            .result-details {
                flex-direction: column;
            }
            .result-item {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
                width: 100%;
            }
            .result-item:last-child {
                border-bottom: none;
            }
        }

        /* Responsive design for search bar */
        @media (max-width: 768px) {
            .search-bar {
                flex-wrap: wrap;
            }
            .search-group {
                min-width: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Dashboard</h1>
            <div class="user-info" id="userInfo" style="display: none;">
                <div class="user-details">
                    <img id="userAvatar" class="user-avatar" src="" alt="Avatar">
                    <div>
                        <div class="user-name" id="userName"></div>
                        <div class="user-email" id="userEmail"></div>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">🚪 Đăng xuất</button>
            </div>
            <div class="search-bar content-protected">
                <div class="search-group">
                    <label for="searchPhone">Tìm kiếm theo Số điện thoại</label>
                    <input type="text" id="searchPhone" placeholder="Nhập số điện thoại...">
                </div>
                <div class="search-group">
                    <label for="searchEmail">Tìm kiếm theo Email</label>
                    <input type="text" id="searchEmail" placeholder="Nhập email...">
                </div>
                <div class="search-group">
                    <label for="filterAnswers">Trạng thái</label>
                    <select id="filterAnswers" onchange="applyFilter()">
                        <option value="has_answers">Đã hoàn thành</option>
                        <option value="all">Tất cả</option>
                        <option value="no_answers">Chưa hoàn thành</option>
                    </select>
                </div>
                <div class="search-actions">
                    <button class="btn" onclick="searchData()">🔍 Tìm kiếm</button>
                    <button class="btn" onclick="loadAllData()">🔄 Hiển thị tất cả</button>
                </div>
            </div>
        </div>

        <div class="table-container content-protected">
            <div id="loading" class="loading">Đang tải dữ liệu...</div>
            <div id="tableWrapper" style="display:none;">
                <table>
                    <thead>
                        <tr>
                            <th>Thời gian nộp bài</th>
                            <th>Họ và tên</th>
                            <th>Tuổi</th>
                            <th>Số điện thoại</th>
                            <th>Email</th>
                            <th>Điểm</th>
                            <th>Trình độ HSK HV chọn</th>
                            <th>Trình độ đề xuất học</th>
                            <th>Câu trả lời</th>
                            <th>Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="aiFeedbackModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="writing-icon">✍️</span>
                    Nhận xét bài viết
                    <button class="pdf-export-btn" onclick="generateShareLink()">
                        🔗 Copy link
                    </button>
                </div>
                <button class="modal-close" onclick="closeAIFeedbackModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="student-info" id="studentInfo"></div>
                
                <div class="test-result-section" id="testResultSection" style="display:none;">
                    <h3>📊 Kết quả bài test</h3>
                    <div class="score-display">
                        <div class="score-info">
                            <h4>Điểm số: <span class="score-value" id="totalScore">0</span>/30</h4>
                        </div>
                        
                        <div class="result-details">
                            <div class="result-item">
                                <h4>📋 Trạng thái</h4>
                                <span class="status-badge" id="statusBadge">Đang xử lý...</span>
                            </div>
                            
                            <div class="result-item">
                                <h4>📝 Nhận xét</h4>
                                <p class="comment-text" id="commentText">Đang xử lý...</p>
                            </div>
                            
                            <div class="result-item">
                                <h4>📚 Lộ trình học gợi ý</h4>
                                <p class="path-text" id="learningPathText">Đang xử lý...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="answers-section" id="listeningSection" style="display:none;">
                    <div class="section-title">
                        📻 Phần Nghe: <span id="listeningScore">0</span>/5 đúng
                    </div>
                    <div class="answers-grid" id="listeningGrid"></div>
                </div>
                
                <div class="answers-section" id="readingSection" style="display:none;">
                    <div class="section-title">
                        📖 Phần Điền Đáp Án: <span id="readingScore">0</span>/5 đúng
                    </div>
                    <div class="answers-grid" id="readingGrid"></div>
                </div>

                <div class="essay-display" id="essayDisplay" style="display:none;">
                    <h4>📝 Bài viết của học viên:</h4>
                    <div class="essay-text" id="essayText"></div>
                </div>
                <div class="writing-section">
                    <div class="writing-title">
                        <span class="writing-icon">💬</span>
                        Nhận xét bài viết
                    </div>
                    <div id="aiFeedbackContent" class="writing-content"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal tổng quan bài làm HSK2 -->
    <div class="modal-overlay" id="hsk2FeedbackModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="writing-icon">📊</span>
                    Nhận xét tổng quan HSK2
                    <button class="pdf-export-btn" onclick="generateShareLinkHSK2()">
                        🔗 Copy link
                    </button>
                </div>
                <button class="modal-close" onclick="closeHSK2FeedbackModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="student-info" id="hsk2StudentInfo"></div>
                
                <div class="test-result-section" id="hsk2TestResultSection" style="display:none;">
                    <h3>📊 Kết quả bài test HSK2</h3>
                    <div class="score-display">
                        <div class="score-info">
                            <h4>Điểm số: <span class="score-value" id="hsk2TotalScore">0</span>/200</h4>
                        </div>
                        
                        <div class="result-details">
                            <div class="result-item">
                                <h4>📋 Trạng thái</h4>
                                <span class="status-badge" id="hsk2StatusBadge">Đang xử lý...</span>
                            </div>
                            
                            <div class="result-item">
                                <h4>📝 Nhận xét</h4>
                                <p class="comment-text" id="hsk2CommentText">Đang xử lý...</p>
                            </div>
                            
                            <div class="result-item">
                                <h4>📚 Lộ trình học gợi ý</h4>
                                <p class="path-text" id="hsk2LearningPathText">Đang xử lý...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Phần Nghe hiểu (35 câu) -->
                <div class="answers-section" id="hsk2ListeningSection" style="display:none;">
                    <div class="section-title">
                        🎧 Nghe hiểu: <span id="hsk2ListeningScore">0</span>/35 đúng
                    </div>
                    <div class="answers-grid" id="hsk2ListeningGrid"></div>
                </div>
                
                <!-- Phần Đọc hiểu (25 câu) -->
                <div class="answers-section" id="hsk2ReadingSection" style="display:none;">
                    <div class="section-title">
                        📖 Đọc hiểu: <span id="hsk2ReadingScore">0</span>/25 đúng
                    </div>
                    <div class="answers-grid" id="hsk2ReadingGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal gửi email -->
    <div class="modal-overlay" id="emailModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="writing-icon">📧</span>
                    Gửi email kết quả bài test
                </div>
                <button class="modal-close" onclick="closeEmailModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="email-student-info" id="emailStudentInfo">
                    <h3>👤 Thông tin học viên</h3>
                    <p><strong>Họ tên:</strong> <span id="emailStudentName">Đang tải...</span></p>
                    <p><strong>Email:</strong> <span id="emailStudentEmail">Đang tải...</span></p>
                    <p><strong>Số điện thoại:</strong> <span id="emailStudentPhone">Đang tải...</span></p>
                </div>
                
                <div class="email-test-result-section" id="emailTestResultSection" style="display:none;">
                    <h3>📊 Kết quả bài test</h3>
                    <div class="email-score-display">
                        <div class="email-score-info">
                            <h4>Điểm số: <span class="email-score-value" id="emailTotalScore">0</span>/<span id="emailMaxScore">30</span></h4>
                        </div>
                        
                        <div class="email-result-details">
                            <div class="email-result-item">
                                <h4>📋 Trạng thái</h4>
                                <span class="email-status-badge" id="emailStatusBadge">Đang xử lý...</span>
                            </div>
                            
                            <div class="email-result-item">
                                <h4>📝 Nhận xét</h4>
                                <p class="email-comment-text" id="emailCommentText">Đang xử lý...</p>
                            </div>
                            
                            <div class="email-result-item">
                                <h4>📚 Lộ trình học gợi ý</h4>
                                <p class="email-path-text" id="emailLearningPathText">Đang xử lý...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="email-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="emailTo">Email người nhận:</label>
                            <input type="email" id="emailTo" placeholder="Nhập email người nhận..." required>
                        </div>
                        
                        <div class="form-group">
                            <label for="emailFrom">Tên người gửi:</label>
                            <input type="text" id="emailFrom" placeholder="Nhập tên người gửi..." value="ALOHA">
                        </div>
                        
                        <div class="form-group">
                            <label for="emailSubject">Tiêu đề email:</label>
                            <input type="text" id="emailSubject" placeholder="Nhập tiêu đề email..." value="ALOHA TRẢ KẾT QUẢ TEST HSK">
                        </div>
                    </div>
                    
                    <div class="email-actions">
                        <button class="btn" onclick="sendEmailWithTemplate()">
                            Gửi email
                        </button>
                        <button class="copy-btn" onclick="copyEmailTemplate()">
                            Copy nội dung
                        </button>
                    </div>
                    
                    <div class="email-debug-actions collapsed" id="debugTools" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                        <div class="debug-toggle" onclick="toggleDebugTools()">
                            🔧 Debug Tools (click để mở/đóng)
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="copy-btn" onclick="testUnicodeEncoding()" style="background: #e83e8c; font-size: 12px; padding: 6px 12px;">
                                🧪 Test Unicode
                            </button>
                            <button class="copy-btn" onclick="forceReloadGoogleServices()" style="background: #fd7e14; font-size: 12px; padding: 6px 12px;">
                                🔄 Reload APIs
                            </button>
                            <button class="copy-btn" onclick="retryGmailAuth()" style="background: #ffc107; color: #000; font-size: 12px; padding: 6px 12px;">
                                🔄 Thử lại Gmail
                            </button>
                            <button class="copy-btn" onclick="testRedirectURI()" style="background: #17a2b8; font-size: 12px; padding: 6px 12px;">
                                🧪 Test URI
                            </button>
                            <button class="copy-btn" onclick="checkRedirectURI()" style="background: #dc3545; font-size: 12px; padding: 6px 12px;">
                                🔗 Fix 400
                            </button>
                            <button class="copy-btn" onclick="debugGoogleAPIs()" style="background: #6f42c1; font-size: 12px; padding: 6px 12px;">
                                🔍 Debug
                            </button>
                            <button class="copy-btn" onclick="configureGmailAPI()" style="background: #28a745; font-size: 12px; padding: 6px 12px;">
                                ⚙️ Cấu hình
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal đăng nhập -->
    <div class="modal-overlay" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="writing-icon">🔐</span>
                    Đăng nhập để truy cập Dashboard
                </div>
            </div>
            <div class="modal-body">
                <div class="login-form">
                    <div class="login-info">
                        <h3>👋 Chào mừng đến với Dashboard HSK</h3>
                        <p>Vui lòng đăng nhập bằng Google để truy cập hệ thống quản lý bài test HSK.</p>
                    </div>
                    
                    <div class="google-login-container">
                        <div id="g_id_onload"
                             data-client_id="1034144698153-qnh5747mmfku65u52s3mp3narrssbq8n.apps.googleusercontent.com"
                             data-callback="handleCredentialResponse"
                             data-auto_prompt="false">
                        </div>
                        <div class="g_id_signin"
                             data-type="standard"
                             data-size="large"
                             data-theme="outline"
                             data-text="sign_in_with"
                             data-shape="rectangular"
                             data-logo_alignment="left">
                        </div>
                    </div>
                    
                    <div class="login-footer">
                        <p>🔒 Thông tin của bạn được bảo mật và chỉ sử dụng để xác thực truy cập.</p>
                        <button class="btn" onclick="skipAuth()" style="margin-top: 15px; background: #6c757d;">
                            🚀 Bỏ qua xác thực (Development)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://axllpuaybdzubfmsfkws.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4bGxwdWF5YmR6dWJmbXNma3dzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NDMzODgsImV4cCI6MjA3NTMxOTM4OH0.KrjW79ZpnPxu_Lp9mETgKZU-kOLu3oMmWkABqOcDbco";

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        let allData = [];
        let currentUser = null;

        // Google OAuth Configuration
        const GOOGLE_CLIENT_ID = "1034144698153-qnh5747mmfku65u52s3mp3narrssbq8n.apps.googleusercontent.com";
        const GOOGLE_CLIENT_SECRET = "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";
        
        // Get current domain for redirect URI
        const CURRENT_DOMAIN = window.location.origin;
        const REDIRECT_URI = `${CURRENT_DOMAIN}/oauth2callback`;
        
        // Gmail API Configuration
        const GMAIL_SCOPES = 'https://www.googleapis.com/auth/gmail.send';
        let gmailAccessToken = null;

        // Initialize Google OAuth
        function initializeGoogleAuth() {
            if (typeof google !== 'undefined' && google.accounts) {
                try {
                    google.accounts.id.initialize({
                        client_id: GOOGLE_CLIENT_ID,
                        callback: handleCredentialResponse,
                        auto_select: false,
                        cancel_on_tap_outside: true,
                        use_fedcm_for_prompt: false,
                        itp_support: true,
                        ux_mode: 'redirect',
                        redirect_uri: REDIRECT_URI
                    });
                    console.log('Google OAuth initialized successfully with redirect URI:', REDIRECT_URI);
                } catch (error) {
                    console.error('Error initializing Google OAuth:', error);
                    // Retry after delay
                    setTimeout(() => {
                        if (typeof google !== 'undefined' && google.accounts) {
                            try {
                                google.accounts.id.initialize({
                                    client_id: GOOGLE_CLIENT_ID,
                                    callback: handleCredentialResponse,
                                    auto_select: false,
                                    cancel_on_tap_outside: true,
                                    ux_mode: 'redirect',
                                    redirect_uri: REDIRECT_URI
                                });
                                console.log('Google OAuth retry successful');
                            } catch (retryError) {
                                console.error('Google OAuth retry failed:', retryError);
                                showOAuthError();
                            }
                        }
                    }, 2000);
                }
            } else {
                console.error('Google OAuth library not loaded, retrying...');
                setTimeout(initializeGoogleAuth, 1000);
            }
        }

        function showOAuthError() {
            const loginForm = document.querySelector('.login-form');
            if (loginForm) {
                loginForm.innerHTML = `
                    <div class="login-info">
                        <h3>⚠️ Lỗi cấu hình OAuth</h3>
                        <p>Vui lòng kiểm tra cấu hình Google OAuth trong Google Cloud Console:</p>
                        <ul style="text-align: left; margin: 20px 0; padding-left: 20px;">
                            <li>Thêm domain hiện tại vào <strong>Authorized JavaScript origins</strong></li>
                            <li>Kiểm tra Client ID có đúng không</li>
                            <li>Đảm bảo OAuth consent screen đã được cấu hình</li>
                        </ul>
                        <p><strong>Domain hiện tại:</strong> ${window.location.origin}</p>
                        <button class="btn" onclick="location.reload()" style="margin-top: 15px;">
                            🔄 Thử lại
                        </button>
                    </div>
                `;
            }
        }

        // Handle Google OAuth response
        function handleCredentialResponse(response) {
            try {
                // Decode JWT token
                const responsePayload = decodeJwtResponse(response.credential);
                
                // Store user info with access token
                currentUser = {
                    name: responsePayload.name,
                    email: responsePayload.email,
                    picture: responsePayload.picture,
                    sub: responsePayload.sub,
                    accessToken: response.credential // Store credential for potential use
                };
                
                // Save to localStorage
                localStorage.setItem('user', JSON.stringify(currentUser));
                
                // Hide login modal and show content
                document.getElementById('loginModal').classList.remove('show');
                showAuthenticatedContent();
                
                // Load data
                loadAllData();
                
                console.log('Đăng nhập thành công:', currentUser);
                
            } catch (error) {
                console.error('Lỗi xử lý đăng nhập:', error);
                alert('❌ Có lỗi xảy ra khi đăng nhập. Vui lòng thử lại.');
            }
        }

        // Decode JWT response
        function decodeJwtResponse(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        // Show authenticated content
        function showAuthenticatedContent() {
            // Show user info
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userAvatar').src = currentUser.picture;
            
            // Show protected content
            const protectedElements = document.querySelectorAll('.content-protected');
            protectedElements.forEach(element => {
                element.classList.add('show');
            });
        }

        // Hide authenticated content
        function hideAuthenticatedContent() {
            // Hide user info
            document.getElementById('userInfo').style.display = 'none';
            
            // Hide protected content
            const protectedElements = document.querySelectorAll('.content-protected');
            protectedElements.forEach(element => {
                element.classList.remove('show');
            });
        }

        // Logout function
        function logout() {
            currentUser = null;
            localStorage.removeItem('user');
            
            // Hide authenticated content
            hideAuthenticatedContent();
            
            // Show login modal
            document.getElementById('loginModal').classList.add('show');
            
            console.log('Đã đăng xuất');
        }

        // Check if user is already logged in
        function checkAuthStatus() {
            const savedUser = localStorage.getItem('user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showAuthenticatedContent();
                    loadAllData();
                    return true;
                } catch (error) {
                    console.error('Lỗi đọc thông tin người dùng:', error);
                    localStorage.removeItem('user');
                }
            }
            return false;
        }

        // Skip authentication for development
        function skipAuth() {
            currentUser = {
                name: 'Developer User',
                email: 'developer@example.com',
                picture: 'https://via.placeholder.com/40',
                sub: 'dev-user'
            };
            
            // Save to localStorage
            localStorage.setItem('user', JSON.stringify(currentUser));
            
            // Hide login modal and show content
            document.getElementById('loginModal').classList.remove('show');
            showAuthenticatedContent();
            
            // Load data
            loadAllData();
            
            console.log('Skipped authentication for development');
        }

        // Gmail API Functions - Using Google Identity Services
        function initializeGmailAPI() {
            if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                console.log('Google Identity Services loaded successfully');
                return true;
            } else {
                console.warn('Google Identity Services not loaded, retrying in 2 seconds...');
                setTimeout(initializeGmailAPI, 2000);
                return false;
            }
        }

        // Wait for Google Identity Services to load
        function waitForGoogleServices() {
            return new Promise((resolve) => {
                const checkServices = () => {
                    if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                        console.log('Google Identity Services ready');
                        resolve(true);
                    } else {
                        console.log('Waiting for Google Identity Services...');
                        setTimeout(checkServices, 500);
                    }
                };
                checkServices();
            });
        }

        async function requestGmailPermission() {
            try {
                // Wait for Google Identity Services to load
                await waitForGoogleServices();
                
                if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                    return new Promise((resolve, reject) => {
                        try {
                            const tokenClient = google.accounts.oauth2.initTokenClient({
                                client_id: GOOGLE_CLIENT_ID,
                                scope: GMAIL_SCOPES,
                                callback: (response) => {
                                    if (response.access_token) {
                                        gmailAccessToken = response.access_token;
                                        console.log('Gmail access token obtained successfully');
                                        resolve(gmailAccessToken);
                                    } else {
                                        reject(new Error('Không thể lấy access token từ Google Identity Services'));
                                    }
                                },
                                error_callback: (error) => {
                                    console.error('Token client error:', error);
                                    reject(new Error('Lỗi xác thực Gmail: ' + (error.type || error.message || 'Unknown error')));
                                }
                            });
                            
                            // Request access token
                            tokenClient.requestAccessToken();
                        } catch (error) {
                            console.error('Error initializing token client:', error);
                            reject(new Error('Không thể khởi tạo Google Identity Services: ' + error.message));
                        }
                    });
                } else {
                    throw new Error('Google Identity Services chưa được tải. Vui lòng đợi và thử lại.');
                }
            } catch (error) {
                console.error('Error waiting for Google Services:', error);
                throw new Error('Không thể tải Google Identity Services: ' + error.message);
            }
        }

        function isValidEmail(email) {
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const lastChar = email.slice(-1);
            if (lastChar === '.') {
                return false;
            }
            return emailPattern.test(email);
        }

        function getCurrentTimeGMT7() {
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const gmt7 = new Date(utc + (7 * 3600000));
            return gmt7.toISOString().replace('T', ' ').substring(0, 19);
        }

        // Safe base64 encoding for Unicode strings
        function safeBase64Encode(str) {
            try {
                // Method 1: Use TextEncoder (modern browsers)
                if (typeof TextEncoder !== 'undefined') {
                    const utf8Bytes = new TextEncoder().encode(str);
                    return btoa(String.fromCharCode(...utf8Bytes));
                }
                
                // Method 2: Use encodeURIComponent + btoa
                return btoa(unescape(encodeURIComponent(str)));
            } catch (error) {
                console.error('Base64 encoding error:', error);
                // Method 3: Fallback - encode line by line
                const lines = str.split('\n');
                const encodedLines = lines.map(line => {
                    try {
                        return btoa(unescape(encodeURIComponent(line)));
                    } catch (e) {
                        // Last resort: remove non-ASCII characters
                        return btoa(line.replace(/[^\x00-\x7F]/g, '?'));
                    }
                });
                return encodedLines.join('');
            }
        }

        function createEmailMessage(to, subject, body, fromName = 'ALOHA') {
            const boundary = 'boundary_' + Math.random().toString(36).substr(2, 9);
            
            // Encode subject properly for UTF-8
            const encodedSubject = `=?UTF-8?B?${btoa(unescape(encodeURIComponent(subject)))}?=`;
            
            // Encode from name properly
            const encodedFromName = `=?UTF-8?B?${btoa(unescape(encodeURIComponent(fromName)))}?=`;
            
            const raw = [
                `To: ${to}`,
                `From: ${encodedFromName} <${currentUser ? currentUser.email : 'noreply@example.com'}>`,
                `Subject: ${encodedSubject}`,
                'MIME-Version: 1.0',
                `Content-Type: multipart/alternative; boundary="${boundary}"`,
                '',
                `--${boundary}`,
                'Content-Type: text/plain; charset=UTF-8',
                'Content-Transfer-Encoding: 8bit',
                '',
                body.replace(/<[^>]*>/g, ''), // Strip HTML tags for plain text
                '',
                `--${boundary}`,
                'Content-Type: text/html; charset=UTF-8',
                'Content-Transfer-Encoding: 8bit',
                '',
                body,
                '',
                `--${boundary}--`
            ].join('\n');

            // Use safe base64 encoding for Unicode
            const base64 = safeBase64Encode(raw);
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        async function sendEmailViaGmail(to, subject, body, fromName = 'ALOHA') {
            try {
                if (!isValidEmail(to)) {
                    throw new Error('Email không hợp lệ: ' + to);
                }

                // Kiểm tra Google Identity Services đã sẵn sàng
                if (typeof google === 'undefined' || !google.accounts || !google.accounts.oauth2) {
                    throw new Error('Google Identity Services chưa được tải. Vui lòng thử lại sau.');
                }

                // Lấy access token từ Google Sign-In
                if (!gmailAccessToken) {
                    await requestGmailPermission();
                }

                if (!gmailAccessToken) {
                    throw new Error('Không thể lấy quyền truy cập Gmail. Vui lòng đăng nhập lại.');
                }

                // Tạo email message với error handling
                let message;
                try {
                    // Sử dụng tên từ input form (Trung tâm tiếng Trung)
                    const senderName = fromName;
                    message = createEmailMessage(to, subject, body, senderName);
                    console.log('Email message created successfully');
                } catch (error) {
                    console.error('Error creating email message:', error);
                    throw new Error('Không thể tạo nội dung email: ' + error.message);
                }
                
                // Gửi email qua Gmail API với retry logic
                let retryCount = 0;
                const maxRetries = 3;
                
                while (retryCount < maxRetries) {
                    try {
                        const response = await fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages/send', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${gmailAccessToken}`,
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify({
                                raw: message
                            }),
                            mode: 'cors',
                            credentials: 'omit'
                        });

                        if (response.ok) {
                            const result = await response.json();
                            return {
                                success: true,
                                messageId: result.id,
                                time: getCurrentTimeGMT7(),
                                quota: 'Gmail API quota used'
                            };
                        } else {
                            const error = await response.json();
                            if (response.status === 401 && retryCount < maxRetries - 1) {
                                // Token expired, try to refresh
                                gmailAccessToken = null;
                                await requestGmailPermission();
                                retryCount++;
                                continue;
                            }
                            throw new Error(error.error?.message || `HTTP ${response.status}: Gửi email thất bại`);
                        }
                    } catch (fetchError) {
                        if (fetchError.name === 'TypeError' && fetchError.message.includes('CORS')) {
                            throw new Error('Lỗi CORS: Vui lòng kiểm tra cấu hình domain trong Google Cloud Console');
                        }
                        if (retryCount < maxRetries - 1) {
                            retryCount++;
                            await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                            continue;
                        }
                        throw fetchError;
                    }
                }
                
            } catch (error) {
                console.error('Error sending email:', error);
                return {
                    success: false,
                    error: error.message,
                    time: getCurrentTimeGMT7()
                };
            }
        }

        function applyFilter() {
            const filterValue = document.getElementById('filterAnswers').value;
            
            let filteredData = allData;
            
            if (filterValue === 'has_answers') {
                filteredData = allData.filter(item => 
                    item.test_results && item.test_results.length > 0 && item.test_results[0].answers
                );
            } else if (filterValue === 'no_answers') {
                filteredData = allData.filter(item => 
                    !item.test_results || item.test_results.length === 0 || !item.test_results[0].answers
                );
            }
            
            displayData(filteredData);
        }

        function sendEmail(email, fullname, score, level, phone, writingAiComment) {
            // Mở modal gửi email với thông tin học viên
            openEmailModal(email, fullname, score, level, phone, writingAiComment);
        }

        function sendEmailFromRow(rowIndex) {
            // Lấy dữ liệu từ row đã lưu
            const rows = document.querySelectorAll('#dataTable tr');
            if (rowIndex < rows.length) {
                const row = rows[rowIndex];
                const cells = row.querySelectorAll('td');
                if (cells.length >= 6) {
                    const email = cells[4].textContent.trim();
                    const fullname = cells[1].textContent.trim();
                    const score = cells[5].querySelector('.score-badge').textContent.trim();
                    const level = cells[6].textContent.trim();
                    const phone = cells[3].textContent.trim();
                    
                    // Lấy dữ liệu từ data attributes
                    const writingAiComment = row.dataset.writingAiComment || '';
                    let allAnswers = null;
                    let essay = row.dataset.essay || '';
                    
                    try {
                        allAnswers = row.dataset.allAnswers && row.dataset.allAnswers !== '{}' ? JSON.parse(row.dataset.allAnswers) : null;
                    } catch (e) {
                        console.error('Error parsing allAnswers:', e);
                        allAnswers = null;
                    }
                    
                    
                    openEmailModal(email, fullname, score, level, phone, writingAiComment, allAnswers, essay);
                }
            }
        }

        function openEmailModal(email, fullname, score, level, phone, writingAiComment, allAnswers, essay) {
            const modal = document.getElementById('emailModal');
            modal.classList.add('show');
            
            // Điền thông tin mặc định
            document.getElementById('emailTo').value = email || '';
            document.getElementById('emailFrom').value = 'ALOHA';
            document.getElementById('emailSubject').value = `[Quan trọng] ALOHA trả kết quả bài test HSK - ${level}`;
            
            // Hiển thị thông tin học viên
            document.getElementById('emailStudentName').textContent = fullname || 'N/A';
            document.getElementById('emailStudentEmail').textContent = email || 'N/A';
            document.getElementById('emailStudentPhone').textContent = phone || 'N/A';
            
            // Hiển thị kết quả test
            displayEmailTestResult(score, level);
            
            // Lưu thông tin học viên để tạo template
            window.currentStudentData = {
                email: email,
                fullname: fullname,
                score: score,
                level: level,
                phone: phone,
                writingAiComment: writingAiComment,
                allAnswers: allAnswers,
                essay: essay
            };
            
            // Cập nhật preview
            updateEmailPreview();
        }

        function displayEmailTestResult(score, level) {
            if (!score || score === 'N/A' || score === null || score === undefined) {
                document.getElementById('emailTestResultSection').style.display = 'none';
                return;
            }
            
            const numericScore = parseInt(score);
            if (isNaN(numericScore)) {
                document.getElementById('emailTestResultSection').style.display = 'none';
                return;
            }
            
            document.getElementById('emailTotalScore').textContent = numericScore;
            
            // Cập nhật điểm tối đa dựa trên level
            const levelStr = (level || '1').toString().trim();
            const isHSK2 = levelStr === '2' || levelStr.toUpperCase() === 'HSK2' || levelStr.toUpperCase() === 'HSK 2';
            const maxScore = isHSK2 ? 200 : 30;
            document.getElementById('emailMaxScore').textContent = maxScore;
            
            let status, statusClass, comment, learningPath;
            
            // Kiểm tra level để áp dụng tiêu chí đánh giá khác nhau
            if (isHSK2) {
                // Logic đánh giá HSK2 (điểm tối đa 200)
                if (numericScore >= 150) {
                    status = "Đạt";
                    statusClass = "email-status-excellent";
                    comment = "Hiểu và sử dụng được các mẫu câu giao tiếp cơ bản, nắm vững khoảng 300 từ vựng HSK2, có thể nghe – nói – đọc ở mức đơn giản.";
                    learningPath = "HSK3";
                } else {
                    status = "Không đạt";
                    statusClass = "email-status-fail";
                    comment = "Chưa vững từ vựng và cấu trúc ngữ pháp; cần ôn luyện thêm kỹ năng nghe, đọc và phản xạ giao tiếp.";
                    learningPath = "Học lại HSK1-2";
                }
            } else {
                // Tiêu chí cho HSK1 (điểm tối đa 30)
                if (numericScore >= 24) {
                    status = "Đạt";
                    statusClass = "email-status-excellent";
                    comment = "Chúc mừng bạn đã hoàn thành bài test! Điểm số của bạn ở mức cao của HSK1";
                    learningPath = "HSK2 trở lên";
                } else {
                    status = "Chưa đạt";
                    statusClass = "email-status-fail";
                    comment = "Bạn chưa đạt mức cơ bản, cần bắt đầu từ Hán ngữ sơ cấp 1 để làm quen với phát âm và từ vựng nền";
                    learningPath = "HSK1 trở lên";
                }
            }
            
            const statusBadge = document.getElementById('emailStatusBadge');
            statusBadge.textContent = status;
            statusBadge.className = `email-status-badge ${statusClass}`;
            
            document.getElementById('emailCommentText').textContent = comment;
            document.getElementById('emailLearningPathText').textContent = learningPath;
            
            document.getElementById('emailTestResultSection').style.display = 'block';
        }

        function closeEmailModal() {
            document.getElementById('emailModal').classList.remove('show');
        }

        function updateEmailPreview() {
            // Không cần preview nữa
            return;
        }

        function generateEmailTemplate(studentData, senderName) {
            const { fullname, score, level, phone, writingAiComment, allAnswers, essay } = studentData;
            
            // Xác định trạng thái và nhận xét dựa trên điểm và level
            let status, statusText, comment, learningPath;
            
            // Kiểm tra level để áp dụng tiêu chí đánh giá khác nhau
            const levelStr = (level || '1').toString().trim();
            const isHSK2 = levelStr === '2' || levelStr.toUpperCase() === 'HSK2' || levelStr.toUpperCase() === 'HSK 2';
            
            if (isHSK2) {
                // Logic đánh giá HSK2 (điểm tối đa 200)
                if (score !== 'N/A' && score >= 150) {
                    status = "Đạt";
                    statusText = "Chúc mừng!";
                    comment = "Hiểu và sử dụng được các mẫu câu giao tiếp cơ bản, nắm vững khoảng 300 từ vựng HSK2, có thể nghe – nói – đọc ở mức đơn giản.";
                    learningPath = "HSK3";
                } else if (score !== 'N/A') {
                    status = "Không đạt";
                    statusText = "Cần học thêm";
                    comment = "Chưa vững từ vựng và cấu trúc ngữ pháp; cần ôn luyện thêm kỹ năng nghe, đọc và phản xạ giao tiếp.";
                    learningPath = "Học lại HSK1-2";
                } else {
                    status = "Chưa hoàn thành";
                    statusText = "Chưa có kết quả";
                    comment = "Bạn chưa hoàn thành bài test. Vui lòng liên hệ để được hỗ trợ.";
                    learningPath = "Liên hệ tư vấn";
                }
            } else {
                // Tiêu chí cho HSK1 (điểm tối đa 30)
                if (score !== 'N/A' && score >= 24) {
                    status = "Đạt";
                    statusText = "Chúc mừng!";
                    comment = "Bạn đã hoàn thành bài test với kết quả xuất sắc! Điểm số của bạn ở mức cao của HSK1.";
                    learningPath = "HSK2 trở lên";
                } else if (score !== 'N/A') {
                    status = "Chưa đạt";
                    statusText = "Cần học thêm";
                    comment = "Bạn chưa đạt mức cơ bản, cần bắt đầu từ Hán ngữ sơ cấp 1 để làm quen với phát âm và từ vựng nền.";
                    learningPath = "HSK1 trở lên";
                } else {
                    status = "Chưa hoàn thành";
                    statusText = "Chưa có kết quả";
                    comment = "Bạn chưa hoàn thành bài test. Vui lòng liên hệ để được hỗ trợ.";
                    learningPath = "Liên hệ tư vấn";
                }
            }
            
            // Tạo phần Nghe và Điền đáp án
            let listeningSection = '';
            let readingSection = '';
            let essaySection = '';
            
            if (allAnswers) {
                let listeningCorrect = 0;
                let readingCorrect = 0;
                let listeningAnswers = '';
                let readingAnswers = '';
                
                if (isHSK2) {
                    // Đáp án đúng cho HSK2 (60 câu)
                    const correctAnswersHSK2 = {
                        // Phần Nghe hiểu - 35 câu (Q1-Q35, index 0-34)
                        '0': 'false', '1': 'true', '2': 'true', '3': 'false', '4': 'false',
                        '5': 'false', '6': 'false', '7': 'true', '8': 'true', '9': 'true',
                        '10': 'A', '11': 'B', '12': 'C', '13': 'F', '14': 'E',
                        '15': 'D', '16': 'G', '17': 'H', '18': 'I', '19': 'J',
                        '20': 'C', '21': 'A', '22': 'B', '23': 'C', '24': 'B',
                        '25': 'A', '26': 'C', '27': 'C', '28': 'A', '29': 'B',
                        '30': 'B', '31': 'A', '32': 'B', '33': 'A', '34': 'C',
                        
                        // Phần Đọc hiểu - 25 câu (Q36-Q60, index 35-59)
                        '35': 'E', '36': 'B', '37': 'C', '38': 'F', '39': 'A',
                        '40': 'B', '41': 'F', '42': 'D', '43': 'A', '44': 'C',
                        '45': 'false', '46': 'true', '47': 'false', '48': 'false', '49': 'true',
                        '50': 'D', '51': 'C', '52': 'A', '53': 'F', '54': 'B',
                        '55': 'E', '56': 'A', '57': 'C', '58': 'D', '59': 'B'
                    };
                    
                    // Phần Nghe (Q1-Q35, index 0-34) - 6 câu/dòng
                    for (let i = 0; i < 35; i++) {
                        const key = String(i);
                        const userAnswer = allAnswers[key] || 'N/A';
                        const correctAnswer = correctAnswersHSK2[key];
                        const isCorrect = userAnswer === correctAnswer;
                        
                        if (isCorrect) listeningCorrect++;
                        
                        // Thêm <br> sau mỗi 6 câu
                        if (i > 0 && i % 6 === 0) {
                            listeningAnswers += '<br>';
                        }
                        
                        listeningAnswers += `
                            <span class="answer-badge-inline ${isCorrect ? 'answer-correct' : 'answer-incorrect'}">
                                ${i + 1}:${userAnswer}${isCorrect ? '✓' : '✗'}
                            </span>
                        `;
                    }
                    
                    // Phần Đọc (Q36-Q60, index 35-59) - 6 câu/dòng
                    for (let i = 35; i < 60; i++) {
                        const key = String(i);
                        const userAnswer = allAnswers[key] || 'N/A';
                        const correctAnswer = correctAnswersHSK2[key];
                        const isCorrect = userAnswer === correctAnswer;
                        
                        if (isCorrect) readingCorrect++;
                        
                        // Thêm <br> sau mỗi 6 câu (từ câu 36)
                        if (i > 35 && (i - 35) % 6 === 0) {
                            readingAnswers += '<br>';
                        }
                        
                        readingAnswers += `
                            <span class="answer-badge-inline ${isCorrect ? 'answer-correct' : 'answer-incorrect'}">
                                ${i + 1}:${userAnswer}${isCorrect ? '✓' : '✗'}
                            </span>
                        `;
                    }
                } else {
                    // Đáp án đúng cho HSK1
                    const correctAnswers = {
                        '0': 'B',   // Q1
                        '1': 'A',   // Q2
                        '2': 'A',   // Q3
                        '3': 'A',   // Q4
                        '4': 'B',   // Q5
                        '5': '她叫苏苏',   // Q6
                        '6': '她喜欢汉语',   // Q7
                        '7': '不',   // Q8
                        '8': '没有',   // Q9
                        '9': '她现在在中国'    // Q10
                    };
                    
                    // Phần Nghe (Q1-Q5, index 0-4)
                    for (let i = 0; i < 5; i++) {
                        const key = String(i);
                        const userAnswer = allAnswers[key] || 'N/A';
                        const correctAnswer = correctAnswers[key];
                        const isCorrect = userAnswer === correctAnswer;
                        
                        if (isCorrect) listeningCorrect++;
                        
                        listeningAnswers += `
                            <div class="answer-badge ${isCorrect ? 'answer-correct' : 'answer-incorrect'}">
                                ${i + 1}: ${userAnswer} <span class="answer-icon">${isCorrect ? '✓' : '✗'}</span>
                            </div>
                        `;
                    }
                    
                    // Phần Điền Đáp Án (Q6-Q10, index 5-9)
                    for (let i = 5; i < 10; i++) {
                        const key = String(i);
                        const userAnswer = allAnswers[key] || 'N/A';
                        const correctAnswer = correctAnswers[key];
                        const isCorrect = userAnswer === correctAnswer;
                        
                        if (isCorrect) readingCorrect++;
                        
                        readingAnswers += `
                            <div class="answer-badge ${isCorrect ? 'answer-correct' : 'answer-incorrect'}">
                                ${i + 1}: ${userAnswer} <span class="answer-icon">${isCorrect ? '✓' : '✗'}</span>
                            </div>
                        `;
                    }
                }
                
                const listeningTotal = isHSK2 ? 35 : 5;
                const readingTotal = isHSK2 ? 25 : 5;
                const listeningLabel = isHSK2 ? 'Nghe hiểu' : 'Phần Nghe';
                const readingLabel = isHSK2 ? 'Đọc hiểu' : 'Phần Điền Đáp Án';
                
                listeningSection = `
                    <div class="answers-section listening">
                        <div class="section-title">
                            ${listeningLabel}: <span>${listeningCorrect}</span>/${listeningTotal} đúng
                        </div>
                        <div class="${isHSK2 ? 'answers-inline' : 'answers-grid'}">
                            ${listeningAnswers}
                        </div>
                    </div>
                `;
                
                readingSection = `
                    <div class="answers-section reading">
                        <div class="section-title">
                            ${readingLabel}: <span>${readingCorrect}</span>/${readingTotal} đúng
                        </div>
                        <div class="${isHSK2 ? 'answers-inline' : 'answers-grid'}">
                            ${readingAnswers}
                        </div>
                    </div>
                `;
            }
            
            // Phần bài viết (chỉ cho HSK1, HSK2 không có)
            if (!isHSK2 && essay && essay.trim().length > 0) {
                essaySection = `
                    <div class="essay-display">
                        <h4>Bài viết của học viên:</h4>
                        <div class="essay-text">${essay}</div>
                    </div>
                `;
            }
            
            return `<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kết quả bài test HSK</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            min-height: 100vh;
            width: 100%;
            box-sizing: border-box;
        }
        @media (max-width: 768px) {
            body {
                max-width: 100%;
                padding: 15px;
            }
        }
        * {
            box-sizing: border-box;
        }
        .header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 800;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .student-info {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #fbbf24;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .student-info h3 {
            color: #1e7e5f;
            margin-bottom: 12px;
            font-size: 18px;
        }
        .student-info p {
            color: #555;
            margin: 8px 0;
            font-size: 14px;
        }
        .student-info strong {
            color: #333;
            font-weight: 600;
        }
        .test-result-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #11998e;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .test-result-section h3 {
            color: #11998e;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .score-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .score-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            display: inline-block;
            margin-left: 10px;
        }
        .result-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        @media (max-width: 768px) {
            .result-details {
                flex-direction: column;
                gap: 15px;
            }
        }
        .result-item {
            text-align: center;
            padding: 15px;
            border-right: 1px solid #dee2e6;
            flex: 1;
            min-width: 200px;
        }
        .result-item:last-child {
            border-right: none;
        }
        .result-item h4 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 16px;
            font-weight: 700;
        }
        .status-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            text-transform: uppercase;
            display: inline-block;
        }
        .status-excellent {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 2px solid #34d399;
        }
        .status-fail {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 2px solid #f87171;
        }
        .comment-text, .path-text {
            font-size: 1em;
            line-height: 1.5;
            color: #495057;
            margin: 0;
            font-weight: 500;
        }
        .path-text {
            color: #11998e;
            font-weight: bold;
        }
        .answers-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
            border-left: 4px solid #11998e;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .answers-section.listening {
            border-left: 4px solid #11998e;
        }
        
        .answers-section.reading {
            border-left: 4px solid #11998e;
        }
        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e7e5f;
            margin-bottom: 15px;
        }
        .answers-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: flex-start;
        }
        .answers-inline {
            line-height: 2.2;
            font-size: 13px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        @media (max-width: 768px) {
            .answers-inline {
                font-size: 12px;
                line-height: 2.0;
            }
        }
        .answer-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 12px;
            transition: transform 0.2s;
            position: relative;
            cursor: pointer;
            white-space: nowrap;
            min-width: 60px;
        }
        .answer-badge-inline {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 12px;
            margin: 2px;
            white-space: nowrap;
        }
        .answer-correct {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #34d399;
        }
        .answer-incorrect {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #f87171;
        }
        .answer-icon {
            margin-left: 6px;
            font-size: 16px;
        }
        .essay-display {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
        }
        .essay-display h4 {
            color: #1e7e5f;
            margin-bottom: 12px;
            font-size: 16px;
        }
        .essay-text {
            color: #333;
            line-height: 1.8;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .writing-section {
            background: rgba(255, 255, 255, 0.95);
            border: 2.5px solid #fbbf24;
            border-radius: 15px;
            padding: 22px 26px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        .writing-title {
            font-weight: 800;
            color: #92400e;
            margin-bottom: 14px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            z-index: 1;
        }
        .writing-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            box-shadow: 0 3px 10px rgba(251, 191, 36, 0.4);
        }
        .writing-content {
            color: #78350f;
            line-height: 1.7;
            font-size: 15px;
            position: relative;
            z-index: 1;
        }
        .writing-content p {
            background: rgba(255, 255, 255, 0.5);
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 3px solid #fbbf24;
        }
        .writing-content p:last-child {
            margin-bottom: 0;
        }
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            color: #666;
            font-size: 14px;
        }
        @media (max-width: 768px) {
            .result-item {
                padding: 12px 8px;
                min-height: 70px;
            }
            .result-item h4 {
                font-size: 13px;
                margin-bottom: 6px;
            }
            .result-item p {
                font-size: 12px;
            }
        }

        @media (max-width: 600px) {
            body {
                max-width: 100%;
                padding: 10px;
            }
            .result-details {
                flex-direction: column;
            }
            .result-item {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
                min-height: 50px;
                padding: 10px 8px;
            }
            .result-item:last-child {
                border-bottom: none;
            }
            .result-item h4 {
                font-size: 11px;
                margin-bottom: 4px;
            }
            .result-item p {
                font-size: 10px;
            }
            .answers-grid {
                gap: 6px;
            }
            .answer-badge {
                padding: 6px 10px;
                font-size: 11px;
                min-width: 50px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Thông tin bài test</h1>
    </div>
    
    <div class="student-info">
        <h3>Thông tin học viên</h3>
        <p><strong>Họ tên:</strong> ${fullname}</p>
        <p><strong>Email:</strong> ${studentData.email || 'N/A'}</p>
        <p><strong>Số điện thoại:</strong> ${phone || 'N/A'}</p>
    </div>
    
    <div class="test-result-section">
        <h3>Kết quả bài test ${isHSK2 ? 'HSK2' : 'HSK1'}</h3>
        <div class="score-info">
            <h4>Điểm số: <span class="score-value">${score !== 'N/A' ? score : 'N/A'}</span>/${isHSK2 ? '200' : '30'}</h4>
        </div>
        
        <div class="result-details">
            <div class="result-item">
                <h4>Trạng thái</h4>
                <span class="status-badge ${score !== 'N/A' && ((isHSK2 && score >= 150) || (!isHSK2 && score >= 24)) ? 'status-excellent' : 'status-fail'}">${status}</span>
            </div>
            
            <div class="result-item">
                <h4>Nhận xét</h4>
                <p class="comment-text">${comment}</p>
            </div>
            
            <div class="result-item">
                <h4>Lộ trình học gợi ý</h4>
                <p class="path-text">${learningPath}</p>
            </div>
        </div>
    </div>
    
    ${listeningSection}
    
    ${readingSection}
    
    ${essaySection}
    
    ${!isHSK2 ? `
    <div class="writing-section">
        <div class="writing-title">
            Nhận xét bài viết
        </div>
        <div class="writing-content">
            ${writingAiComment ? writingAiComment.replace(/\n/g, '<br>') : '<p>Chưa có nhận xét bài viết.</p>'}
        </div>
    </div>` : ''}
    
</body>
</html>`;
        }

        async function sendEmailWithTemplate() {
            const emailTo = document.getElementById('emailTo').value;
            const emailFrom = document.getElementById('emailFrom').value;
            const emailSubject = document.getElementById('emailSubject').value;
            
            if (!emailTo) {
                alert('❌ Vui lòng nhập email người nhận!');
                return;
            }
            
            const studentData = window.currentStudentData;
            if (!studentData) {
                alert('❌ Không tìm thấy thông tin học viên!');
                return;
            }
            
            // Tạo nội dung email
            const emailBody = generateEmailTemplate(studentData, emailFrom);
            
            // Hiển thị loading
            const sendBtn = document.querySelector('.email-actions .btn');
            const originalText = sendBtn.textContent;
            sendBtn.textContent = '⏳ Đang gửi...';
            sendBtn.disabled = true;
            
            try {
                // Sử dụng tên từ input form (Trung tâm tiếng Trung)
                const senderName = emailFrom;
                
                // Gửi email qua Gmail API
                const result = await sendEmailViaGmail(emailTo, emailSubject, emailBody, senderName);
                
                if (result.success) {
                    alert(`✅ Gửi email thành công!\n\n📧 Gửi đến: ${emailTo}\n📝 Tiêu đề: ${emailSubject}\n🕒 Thời gian: ${result.time}\n\nEmail đã được gửi trực tiếp qua Gmail API.`);
                    
                    // Đóng modal
                    closeEmailModal();
                } else {
                    // Nếu lỗi server_error, thử phương pháp thay thế
                    if (result.error && result.error.includes('server_error')) {
                        const fallbackResult = await sendEmailFallback(emailTo, emailSubject, emailBody, emailFrom);
                        if (fallbackResult.success) {
                            alert(`✅ Gửi email thành công (phương pháp thay thế)!\n\n📧 Gửi đến: ${emailTo}\n📝 Tiêu đề: ${emailSubject}\n🕒 Thời gian: ${fallbackResult.time}`);
                            closeEmailModal();
                        } else {
                            alert(`❌ Gửi email thất bại!\n\nLỗi: ${result.error}\n\nVui lòng sử dụng chức năng "Copy nội dung" để gửi thủ công.`);
                        }
                    } else {
                        alert(`❌ Gửi email thất bại!\n\nLỗi: ${result.error}\n\nVui lòng thử lại hoặc sử dụng chức năng copy để gửi thủ công.`);
                    }
                }
            } catch (error) {
                console.error('Error sending email:', error);
                alert(`❌ Có lỗi xảy ra khi gửi email!\n\nLỗi: ${error.message}\n\nVui lòng thử lại hoặc sử dụng chức năng copy để gửi thủ công.`);
            } finally {
                // Khôi phục button
                sendBtn.textContent = originalText;
                sendBtn.disabled = false;
            }
        }

        // Phương pháp thay thế khi Gmail API bị lỗi
        async function sendEmailFallback(to, subject, body, fromName = 'ALOHA') {
            try {
                // Tạo mailto link với nội dung email
                const mailtoBody = body.replace(/\n/g, '%0A').replace(/ /g, '%20');
                const mailtoLink = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                
                // Mở email client
                window.open(mailtoLink);
                
                return {
                    success: true,
                    method: 'mailto',
                    time: getCurrentTimeGMT7(),
                    message: 'Đã mở ứng dụng email với nội dung đã điền sẵn'
                };
            } catch (error) {
                return {
                    success: false,
                    error: error.message,
                    time: getCurrentTimeGMT7()
                };
            }
        }

        function copyEmailTemplate() {
            const studentData = window.currentStudentData;
            if (!studentData) {
                alert('❌ Không tìm thấy thông tin học viên!');
                return;
            }
            
            const emailFrom = document.getElementById('emailFrom').value;
            const emailTemplate = generateEmailTemplate(studentData, emailFrom);
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(emailTemplate).then(() => {
                    alert('✅ Đã copy nội dung email vào clipboard!');
                }).catch(() => {
                    // Fallback
                    const textArea = document.createElement('textarea');
                    textArea.value = emailTemplate;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('✅ Đã copy nội dung email vào clipboard!');
                });
            } else {
                // Fallback cho trình duyệt cũ
                const textArea = document.createElement('textarea');
                textArea.value = emailTemplate;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('✅ Đã copy nội dung email vào clipboard!');
            }
        }

        // Hàm toggle debug tools
        function toggleDebugTools() {
            const debugTools = document.getElementById('debugTools');
            if (debugTools.classList.contains('collapsed')) {
                debugTools.classList.remove('collapsed');
            } else {
                debugTools.classList.add('collapsed');
            }
        }

        // Test redirect URI
        function testRedirectURI() {
            const currentDomain = window.location.origin;
            const testURIs = [
                REDIRECT_URI,
                currentDomain,
                `${currentDomain}/`,
                `${currentDomain}/index.html`
            ];
            
            let testText = '🧪 TEST REDIRECT URI:\n\n';
            testText += `Domain hiện tại: ${currentDomain}\n`;
            testText += `Redirect URI chính: ${REDIRECT_URI}\n\n`;
            testText += 'Các redirect URI cần thêm vào Google Cloud Console:\n';
            testURIs.forEach((uri, index) => {
                testText += `${index + 1}. ${uri}\n`;
            });
            
            testText += '\n📋 HƯỚNG DẪN:\n';
            testText += '1. Copy các URI trên\n';
            testText += '2. Vào Google Cloud Console\n';
            testText += '3. APIs & Services → Credentials\n';
            testText += '4. Chỉnh sửa OAuth 2.0 Client ID\n';
            testText += '5. Thêm tất cả URI trên vào "Authorized redirect URIs"\n';
            testText += '6. Lưu và thử lại';
            
            alert(testText);
        }

        // Hàm kiểm tra và fix redirect URI
        function checkRedirectURI() {
            const currentDomain = window.location.origin;
            const currentPath = window.location.pathname;
            const fullURL = window.location.href;
            
            const redirectInfo = {
                'Current domain': currentDomain,
                'Current path': currentPath,
                'Full URL': fullURL,
                'Expected redirect URI': REDIRECT_URI,
                'Alternative redirect URI': currentDomain
            };
            
            console.log('🔍 Redirect URI Debug Info:', redirectInfo);
            
            let debugText = '🔍 REDIRECT URI DEBUG:\n\n';
            for (const [key, value] of Object.entries(redirectInfo)) {
                debugText += `${key}: ${value}\n`;
            }
            
            debugText += '\n📋 FIX LỖI 400 BAD REQUEST:\n';
            debugText += '1. Vào Google Cloud Console → APIs & Services → Credentials\n';
            debugText += '2. Chỉnh sửa OAuth 2.0 Client ID\n';
            debugText += '3. Thêm các redirect URIs sau:\n';
            debugText += `   - ${REDIRECT_URI} (CHÍNH)\n`;
            debugText += `   - ${currentDomain}\n`;
            debugText += `   - ${currentDomain}/\n`;
            debugText += `   - ${currentDomain}/index.html\n`;
            debugText += '4. Lưu và thử lại\n\n';
            debugText += '⚠️ LƯU Ý: Redirect URI chính là /oauth2callback\n';
            debugText += 'Đảm bảo chính xác 100%';
            
            alert(debugText);
        }

        // Debug function để kiểm tra trạng thái Google APIs
        function debugGoogleAPIs() {
            const debugInfo = {
                'Google Identity Services': typeof google !== 'undefined' && typeof google.accounts !== 'undefined',
                'Google OAuth2': typeof google !== 'undefined' && typeof google.accounts !== 'undefined' && typeof google.accounts.oauth2 !== 'undefined',
                'Current domain': window.location.origin,
                'Redirect URI': REDIRECT_URI,
                'Gmail access token': gmailAccessToken ? 'Có' : 'Không',
                'User logged in': currentUser ? 'Có' : 'Không'
            };
            
            console.log('🔍 Google APIs Debug Info:', debugInfo);
            
            let debugText = '🔍 GOOGLE APIs DEBUG INFO:\n\n';
            for (const [key, value] of Object.entries(debugInfo)) {
                debugText += `${key}: ${value}\n`;
            }
            
            debugText += '\n📋 HƯỚNG DẪN FIX:\n';
            debugText += '1. Nếu Google Identity Services = false: Refresh trang\n';
            debugText += '2. Nếu Google OAuth2 = false: Kiểm tra CSP headers\n';
            debugText += '3. Nếu Gmail access token = Không: Click "Thử lại Gmail"\n';
            debugText += '4. Nếu User logged in = Không: Đăng nhập lại\n';
            debugText += '5. Nếu vẫn lỗi: Click "🧪 Test URI" để kiểm tra redirect URI\n';
            
            alert(debugText);
        }

        // Test Unicode encoding
        function testUnicodeEncoding() {
            const testText = 'Xin chào! Đây là test tiếng Việt với ký tự đặc biệt: àáạảãâầấậẩẫăằắặẳẵèéẹẻẽêềếệểễìíịỉĩòóọỏõôồốộổỗơờớợởỡùúụủũưừứựửữỳýỵỷỹđ';
            
            try {
                const encoded = safeBase64Encode(testText);
                const decoded = atob(encoded);
                
                alert(`🧪 TEST UNICODE ENCODING:

Test text: ${testText}
Encoded: ${encoded}
Decoded: ${decoded}

✅ Unicode encoding hoạt động bình thường!`);
            } catch (error) {
                alert(`❌ UNICODE ENCODING ERROR:

Lỗi: ${error.message}

Vui lòng sử dụng chức năng "Copy nội dung" để gửi thủ công.`);
            }
        }

        // Force reload Google Services
        function forceReloadGoogleServices() {
            // Clear any cached Google Services
            if (typeof google !== 'undefined') {
                delete window.google;
            }
            
            // Reload Google Identity Services script
            const script = document.querySelector('script[src*="accounts.google.com/gsi/client"]');
            if (script) {
                script.remove();
            }
            
            // Add new script
            const newScript = document.createElement('script');
            newScript.src = 'https://accounts.google.com/gsi/client';
            newScript.async = true;
            newScript.defer = true;
            document.head.appendChild(newScript);
            
            alert('🔄 Đã reload Google Services!\n\nVui lòng đợi 2-3 giây rồi thử lại.');
        }

        // Hàm thử lại Gmail authentication
        function retryGmailAuth() {
            // Reset Gmail access token
            gmailAccessToken = null;
            
            // Clear localStorage
            localStorage.removeItem('user');
            currentUser = null;
            
            // Show instructions
            alert(`🔄 THỬ LẠI GMAIL AUTHENTICATION

Để fix lỗi Gmail, hãy làm theo các bước sau:

1. 🔄 Refresh trang web này
2. 🔐 Đăng nhập lại bằng Google
3. 📧 Thử gửi email lại

Nếu vẫn lỗi:
- Kiểm tra OAuth consent screen trong Google Cloud Console
- Đảm bảo Gmail API đã được bật
- Thử với Google account khác
- Clear browser cache và cookies

Domain hiện tại: ${window.location.origin}
Redirect URI: ${REDIRECT_URI}
            `);
            
            // Auto refresh after 3 seconds
            setTimeout(() => {
                if (confirm('Bạn có muốn refresh trang để thử lại không?')) {
                    window.location.reload();
                }
            }, 3000);
        }

        function configureGmailAPI() {
            const instructions = `
🔧 CẤU HÌNH GMAIL API

Để gửi email trực tiếp từ dashboard, bạn cần:

1. 📋 Tạo Google Cloud Project:
   - Truy cập: https://console.cloud.google.com/
   - Tạo project mới hoặc chọn project hiện có

2. 🔑 Bật Gmail API:
   - Vào "APIs & Services" → "Library"
   - Tìm "Gmail API" và bật nó

3. 🆔 OAuth 2.0 Client ID đã có:
   - Client ID: 1034144698153-qnh5747mmfku65u52s3mp3narrssbq8n.apps.googleusercontent.com
   - Vào "APIs & Services" → "Credentials"
   - Chỉnh sửa OAuth 2.0 Client ID hiện có
   - Authorized JavaScript origins: ${window.location.origin}
   - Authorized redirect URIs: ${window.location.origin}/
   - Thêm redirect URI: ${window.location.origin}
   - Thêm redirect URI: ${window.location.origin}/index.html

4. 🔐 Cấu hình OAuth consent screen:
   - Vào "OAuth consent screen"
   - Chọn "Internal" (nếu dùng Google Workspace)
   - Hoặc "External" và điền thông tin cần thiết
   - Thêm scope: https://www.googleapis.com/auth/gmail.send

5. 🌐 Cấu hình CORS (QUAN TRỌNG):
   - Domain hiện tại: ${window.location.origin}
   - Đảm bảo domain được thêm vào "Authorized JavaScript origins"
   - Kiểm tra CSP headers đã được cấu hình đúng

6. ✅ Test:
   - Refresh trang và thử gửi email
   - Sẽ có popup xác thực Gmail lần đầu
   - Email sẽ được gửi trực tiếp qua Gmail API

📞 Hỗ trợ: Nếu gặp khó khăn, hãy sử dụng chức năng "Copy nội dung" để gửi thủ công.

⚠️ LƯU Ý: Nếu gặp lỗi "server_error":
1. Kiểm tra OAuth consent screen đã được cấu hình đúng
2. Đảm bảo Gmail API đã được bật
3. Kiểm tra domain được thêm vào "Authorized JavaScript origins"
4. Thử đăng nhập lại với Google account khác
5. Sử dụng chức năng "Copy nội dung" để gửi thủ công

🔧 FIX LỖI SERVER_ERROR:
- Vào Google Cloud Console → APIs & Services → OAuth consent screen
- Đảm bảo "Publishing status" là "In production" hoặc "Testing"
- Thêm scope: https://www.googleapis.com/auth/gmail.send
- Kiểm tra "Authorized domains" có chứa domain hiện tại
            `;
            
            alert(instructions);
        }

        function copyRowData(rowData) {
            const text = `
Thời gian nộp bài: ${rowData.submitTime}
Họ và tên: ${rowData.fullname}
Tuổi: ${rowData.age}
Số điện thoại: ${rowData.phone}
Email: ${rowData.email}
Điểm: ${rowData.score}
Cấp độ: ${rowData.level}
Câu trả lời: ${rowData.answersText}
            `.trim();

            navigator.clipboard.writeText(text).then(() => {
                alert('✅ Đã copy dữ liệu!');
            }).catch(err => {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert('✅ Đã copy dữ liệu vào clipboard!');
                } catch (err) {
                    alert('❌ Không thể copy. Vui lòng thử lại.');
                }
                document.body.removeChild(textArea);
            });
        }

        async function showAIFeedback(fullname, email, phone, essay, prompt, allAnswers, writingAiComment, score) {
            const modal = document.getElementById('aiFeedbackModal');
            modal.classList.add('show');
            
            document.getElementById('studentInfo').innerHTML = `
                <h3>👤 Thông tin học viên</h3>
                <p><strong>Họ tên:</strong> ${fullname}</p>
                <p><strong>Email:</strong> ${email}</p>
                <p><strong>Số điện thoại:</strong> ${phone}</p>
            `;
            
            // Hiển thị phần kết quả test với điểm từ database
            displayTestResultFromScore(score);
            
            // Đáp án đúng (index bắt đầu từ 0)
            const correctAnswers = {
                '0': 'B',   // Q1
                '1': 'A',   // Q2
                '2': 'A',   // Q3
                '3': 'A',   // Q4
                '4': 'B',   // Q5
                '5': '她叫苏苏',   // Q6
                '6': '她喜欢汉语',   // Q7
                '7': '不',   // Q8
                '8': '没有',   // Q9
                '9': '她现在在中国'    // Q10
            };
            
            if (allAnswers) {
                const listeningSection = document.getElementById('listeningSection');
                const listeningGrid = document.getElementById('listeningGrid');
                const readingSection = document.getElementById('readingSection');
                const readingGrid = document.getElementById('readingGrid');
                
                listeningSection.style.display = 'block';
                readingSection.style.display = 'block';
                
                listeningGrid.innerHTML = '';
                readingGrid.innerHTML = '';
                
                let listeningCorrect = 0;
                let readingCorrect = 0;
                
                // Phần Nghe (Q1-Q5, index 0-4)
                for (let i = 0; i < 5; i++) {
                    const key = String(i);
                    const userAnswer = allAnswers[key] || 'N/A';
                    const correctAnswer = correctAnswers[key];
                    const isCorrect = userAnswer === correctAnswer;
                    
                    console.log(`Listening Q${i+1}: User=${userAnswer}, Correct=${correctAnswer}, Match=${isCorrect}`);
                    
                    if (isCorrect) listeningCorrect++;
                    
                    const badge = document.createElement('div');
                    badge.className = `answer-badge ${isCorrect ? 'answer-correct' : 'answer-incorrect'}`;
                    badge.innerHTML = `
                        ${i + 1}: ${userAnswer} <span class="answer-icon">${isCorrect ? '✓' : '✗'}</span>
                        <span class="answer-tooltip">Đáp án đúng: ${correctAnswer}</span>
                    `;
                    listeningGrid.appendChild(badge);
                }
                
                // Phần Điền Đáp Án (Q6-Q10, index 5-9)
                for (let i = 5; i < 10; i++) {
                    const key = String(i);
                    const userAnswer = allAnswers[key] || 'N/A';
                    const correctAnswer = correctAnswers[key];
                    const isCorrect = userAnswer === correctAnswer;
                    
                    console.log(`Reading Q${i+1}: User=${userAnswer}, Correct=${correctAnswer}, Match=${isCorrect}`);
                    
                    if (isCorrect) readingCorrect++;
                    
                    const badge = document.createElement('div');
                    badge.className = `answer-badge ${isCorrect ? 'answer-correct' : 'answer-incorrect'}`;
                    badge.innerHTML = `
                        ${i + 1}: ${userAnswer} <span class="answer-icon">${isCorrect ? '✓' : '✗'}</span>
                        <span class="answer-tooltip">Đáp án đúng: ${correctAnswer}</span>
                    `;
                    readingGrid.appendChild(badge);
                }
                
                document.getElementById('listeningScore').textContent = listeningCorrect;
                document.getElementById('readingScore').textContent = readingCorrect;
            }
            
            if (essay && essay.trim().length > 0) {
                document.getElementById('essayDisplay').style.display = 'block';
                document.getElementById('essayText').textContent = essay;
            } else {
                document.getElementById('essayDisplay').style.display = 'none';
            }
            
            const feedbackContent = document.getElementById('aiFeedbackContent');
            
            if (writingAiComment && writingAiComment.trim().length > 0) {
                const paragraphs = writingAiComment.split('\n\n').filter(p => p.trim());
                let formattedHTML = '';
                
                if (paragraphs.length > 0) {
                    paragraphs.forEach(para => {
                        const cleaned = para.trim().replace(/\n/g, '<br>');
                        formattedHTML += `<p>${cleaned}</p>`;
                    });
                } else {
                    formattedHTML = `<p>${writingAiComment.replace(/\n/g, '<br>')}</p>`;
                }
                
                feedbackContent.innerHTML = formattedHTML;
            } else {
                feedbackContent.innerHTML = `
                    <p style="color: #92400e;">
                        <strong>📝 Chưa có nhận xét</strong><br><br>
                        Bài viết của học viên chưa được đánh giá bởi AI.
                    </p>
                `;
            }
        }

        function showAIFeedbackById(dataId) {
            const data = window.studentFeedbackData[dataId];
            if (data) {
                const level = (data.selectedLevel || '1').toString().trim();
                const isHSK2 = level === '2' || level.toUpperCase() === 'HSK2' || level.toUpperCase() === 'HSK 2';
                
                if (isHSK2) {
                    showHSK2Feedback(data.fullname, data.email, data.phone, data.essay, data.prompt, data.allAnswers, data.writingAiComment, data.score);
                } else {
                    showAIFeedback(data.fullname, data.email, data.phone, data.essay, data.prompt, data.allAnswers, data.writingAiComment, data.score);
                }
            } else {
                alert('❌ Không tìm thấy dữ liệu học viên!');
            }
        }

        function displayTestResultFromScore(score) {
            if (!score || score === 'N/A' || score === null || score === undefined) {
                document.getElementById('testResultSection').style.display = 'none';
                return;
            }
            
            const numericScore = parseInt(score);
            if (isNaN(numericScore)) {
                document.getElementById('testResultSection').style.display = 'none';
                return;
            }
            
            document.getElementById('totalScore').textContent = numericScore;
            
            let status, statusClass, comment, learningPath;
            
            if (numericScore >= 24) {
                status = "Đạt";
                statusClass = "status-excellent";
                comment = "Chúc mừng bạn đã hoàn thành bài test! Điểm số của bạn ở mức cao của HSK1";
                learningPath = "HSK2 trở lên";
            } else {
                status = "Chưa đạt";
                statusClass = "status-fail";
                comment = "Bạn chưa đạt mức cơ bản, cần bắt đầu từ Hán ngữ sơ cấp 1 để làm quen với phát âm và từ vựng nền";
                learningPath = "HSK1 trở lên";
            }
            
            const statusBadge = document.getElementById('statusBadge');
            statusBadge.textContent = status;
            statusBadge.className = `status-badge ${statusClass}`;
            
            document.getElementById('commentText').textContent = comment;
            document.getElementById('learningPathText').textContent = learningPath;
            
            document.getElementById('testResultSection').style.display = 'block';
        }

        function displayTestResult(allAnswers) {
            if (!allAnswers) {
                document.getElementById('testResultSection').style.display = 'none';
                return;
            }
            
            // Đáp án đúng
            const correctAnswers = {
                '0': 'B',   // Q1
                '1': 'A',   // Q2
                '2': 'A',   // Q3
                '3': 'A',   // Q4
                '4': 'B',   // Q5
                '5': '她叫苏苏',   // Q6
                '6': '她喜欢汉语',   // Q7
                '7': '不',   // Q8
                '8': '没有',   // Q9
                '9': '她现在在中国'    // Q10
            };
            
            // Tính điểm số
            let totalScore = 0;
            for (let i = 0; i < 10; i++) {
                const key = String(i);
                const userAnswer = allAnswers[key] || '';
                const correctAnswer = correctAnswers[key];
                if (userAnswer === correctAnswer) {
                    totalScore += 3; // Mỗi câu đúng được 3 điểm
                }
            }
            
            // Hiển thị điểm số
            document.getElementById('totalScore').textContent = totalScore;
            
            // Logic đánh giá theo yêu cầu
            let status, statusClass, comment, learningPath;
            
            if (totalScore >= 24) {
                status = "Đạt";
                statusClass = "status-excellent";
                comment = "Chúc mừng bạn đã hoàn thành bài test! Điểm số của bạn ở mức cao của HSK1";
                learningPath = "HSK2 trở lên";
            } else {
                status = "Chưa đạt";
                statusClass = "status-fail";
                comment = "Bạn chưa đạt mức cơ bản, cần bắt đầu từ Hán ngữ sơ cấp 1 để làm quen với phát âm và từ vựng nền";
                learningPath = "HSK1 trở lên";
            }
            
            // Cập nhật giao diện
            const statusBadge = document.getElementById('statusBadge');
            statusBadge.textContent = status;
            statusBadge.className = `status-badge ${statusClass}`;
            
            document.getElementById('commentText').textContent = comment;
            document.getElementById('learningPathText').textContent = learningPath;
            
            // Hiển thị phần kết quả test
            document.getElementById('testResultSection').style.display = 'block';
        }

        function closeAIFeedbackModal() {
            document.getElementById('aiFeedbackModal').classList.remove('show');
        }

        document.getElementById('aiFeedbackModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAIFeedbackModal();
            }
        });

        // Hàm hiển thị tổng quan bài làm HSK2
        function showHSK2Feedback(fullname, email, phone, essay, prompt, allAnswers, writingAiComment, score) {
            // Hiển thị thông tin học viên
            document.getElementById('hsk2StudentInfo').innerHTML = `
                <h3>👤 Thông tin học viên</h3>
                <p><strong>Họ tên:</strong> ${fullname}</p>
                <p><strong>Email:</strong> ${email}</p>
                <p><strong>Số điện thoại:</strong> ${phone}</p>
            `;
            
            // Hiển thị kết quả test nếu có điểm
            displayTestResultFromScoreHSK2(score);
            
            // Đáp án đúng HSK2 (60 câu)
            const correctAnswers = {
                // Phần Nghe hiểu - 35 câu (Q1-Q35, index 0-34)
                '0': 'false', '1': 'true', '2': 'true', '3': 'false', '4': 'false',
                '5': 'false', '6': 'false', '7': 'true', '8': 'true', '9': 'true',
                '10': 'A', '11': 'B', '12': 'C', '13': 'F', '14': 'E',
                '15': 'D', '16': 'G', '17': 'H', '18': 'I', '19': 'J',
                '20': 'C', '21': 'A', '22': 'B', '23': 'C', '24': 'B',
                '25': 'A', '26': 'C', '27': 'C', '28': 'A', '29': 'B',
                '30': 'B', '31': 'A', '32': 'B', '33': 'A', '34': 'C',
                
                // Phần Đọc hiểu - 25 câu (Q36-Q60, index 35-59)
                '35': 'E', '36': 'B', '37': 'C', '38': 'F', '39': 'A',
                '40': 'B', '41': 'F', '42': 'D', '43': 'A', '44': 'C',
                '45': 'false', '46': 'true', '47': 'false', '48': 'false', '49': 'true',
                '50': 'D', '51': 'C', '52': 'A', '53': 'F', '54': 'B',
                '55': 'E', '56': 'A', '57': 'C', '58': 'D', '59': 'B'
            };
            
            if (allAnswers) {
                const listeningSection = document.getElementById('hsk2ListeningSection');
                const listeningGrid = document.getElementById('hsk2ListeningGrid');
                const readingSection = document.getElementById('hsk2ReadingSection');
                const readingGrid = document.getElementById('hsk2ReadingGrid');
                
                listeningSection.style.display = 'block';
                readingSection.style.display = 'block';
                
                listeningGrid.innerHTML = '';
                readingGrid.innerHTML = '';
                
                let listeningCorrect = 0;
                let readingCorrect = 0;
                
                // Phần Nghe hiểu (Q1-Q35, index 0-34)
                for (let i = 0; i < 35; i++) {
                    const key = String(i);
                    const userAnswer = allAnswers[key] || 'N/A';
                    const correctAnswer = correctAnswers[key];
                    const isCorrect = userAnswer === correctAnswer;
                    
                    if (isCorrect) listeningCorrect++;
                    
                    const badge = document.createElement('div');
                    badge.className = `answer-badge ${isCorrect ? 'answer-correct' : 'answer-incorrect'}`;
                    badge.innerHTML = `
                        ${i + 1}: ${userAnswer} <span class="answer-icon">${isCorrect ? '✓' : '✗'}</span>
                        <span class="answer-tooltip">Đáp án đúng: ${correctAnswer}</span>
                    `;
                    listeningGrid.appendChild(badge);
                }
                
                // Phần Đọc hiểu (Q36-Q60, index 35-59)
                for (let i = 35; i < 60; i++) {
                    const key = String(i);
                    const userAnswer = allAnswers[key] || 'N/A';
                    const correctAnswer = correctAnswers[key];
                    const isCorrect = userAnswer === correctAnswer;
                    
                    if (isCorrect) readingCorrect++;
                    
                    const badge = document.createElement('div');
                    badge.className = `answer-badge ${isCorrect ? 'answer-correct' : 'answer-incorrect'}`;
                    badge.innerHTML = `
                        ${i + 1}: ${userAnswer} <span class="answer-icon">${isCorrect ? '✓' : '✗'}</span>
                        <span class="answer-tooltip">Đáp án đúng: ${correctAnswer}</span>
                    `;
                    readingGrid.appendChild(badge);
                }
                
                document.getElementById('hsk2ListeningScore').textContent = listeningCorrect;
                document.getElementById('hsk2ReadingScore').textContent = readingCorrect;
            }
            
            // Hiển thị modal
            const modal = document.getElementById('hsk2FeedbackModal');
            modal.classList.add('show');
        }

        function displayTestResultFromScoreHSK2(score) {
            if (!score || score === 'N/A' || score === null || score === undefined) {
                document.getElementById('hsk2TestResultSection').style.display = 'none';
                return;
            }
            
            const numericScore = parseInt(score);
            if (isNaN(numericScore)) {
                document.getElementById('hsk2TestResultSection').style.display = 'none';
                return;
            }
            
            document.getElementById('hsk2TotalScore').textContent = numericScore;
            
            let status, statusClass, comment, learningPath;
            
            // Logic đánh giá HSK2 (điểm tối đa 200)
            if (numericScore >= 150) {
                status = "Đạt";
                statusClass = "status-excellent";
                comment = "Hiểu và sử dụng được các mẫu câu giao tiếp cơ bản, nắm vững khoảng 300 từ vựng HSK2, có thể nghe – nói – đọc ở mức đơn giản.";
                learningPath = "HSK3";
            } else {
                status = "Không đạt";
                statusClass = "status-fail";
                comment = "Chưa vững từ vựng và cấu trúc ngữ pháp; cần ôn luyện thêm kỹ năng nghe, đọc và phản xạ giao tiếp.";
                learningPath = "Học lại HSK1-2";
            }
            
            const statusBadge = document.getElementById('hsk2StatusBadge');
            statusBadge.textContent = status;
            statusBadge.className = `status-badge ${statusClass}`;
            
            document.getElementById('hsk2CommentText').innerHTML = comment;
            document.getElementById('hsk2LearningPathText').innerHTML = learningPath;
            
            document.getElementById('hsk2TestResultSection').style.display = 'block';
        }

        function closeHSK2FeedbackModal() {
            document.getElementById('hsk2FeedbackModal').classList.remove('show');
        }

        document.getElementById('hsk2FeedbackModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeHSK2FeedbackModal();
            }
        });

        async function generateShareLinkHSK2() {
            try {
                const studentInfo = document.getElementById('hsk2StudentInfo');
                if (!studentInfo) {
                    alert('❌ Không tìm thấy thông tin học viên!');
                    return;
                }
                
                const studentName = studentInfo.querySelector('p:nth-child(2)')?.textContent?.replace('Họ tên: ', '') || 'HocVien';
                const studentEmail = studentInfo.querySelector('p:nth-child(3)')?.textContent?.replace('Email: ', '') || '';
                const studentPhone = studentInfo.querySelector('p:nth-child(4)')?.textContent?.replace('Số điện thoại: ', '') || '';
                
                const listeningSection = document.getElementById('hsk2ListeningSection');
                const readingSection = document.getElementById('hsk2ReadingSection');
                
                let listeningData = null;
                let readingData = null;
                
                // Lấy dữ liệu phần Nghe hiểu
                if (listeningSection && listeningSection.style.display !== 'none') {
                    try {
                        const listeningScore = document.getElementById('hsk2ListeningScore')?.textContent || '0';
                        const listeningGrid = document.getElementById('hsk2ListeningGrid');
                        if (listeningGrid) {
                            const badges = listeningGrid.querySelectorAll('.answer-badge');
                            const answers = Array.from(badges).map(badge => ({
                                text: badge.textContent.trim(),
                                isCorrect: badge.classList.contains('answer-correct')
                            }));
                            // Lưu số câu đúng thay vì điểm số
                            const correctCount = answers.filter(a => a.isCorrect).length;
                            listeningData = { score: correctCount, answers: answers };
                        }
                    } catch (e) {}
                }
                
                // Lấy dữ liệu phần Đọc hiểu
                if (readingSection && readingSection.style.display !== 'none') {
                    try {
                        const readingScore = document.getElementById('hsk2ReadingScore')?.textContent || '0';
                        const readingGrid = document.getElementById('hsk2ReadingGrid');
                        if (readingGrid) {
                            const badges = readingGrid.querySelectorAll('.answer-badge');
                            const answers = Array.from(badges).map(badge => ({
                                text: badge.textContent.trim(),
                                isCorrect: badge.classList.contains('answer-correct')
                            }));
                            // Lưu số câu đúng thay vì điểm số
                            const correctCount = answers.filter(a => a.isCorrect).length;
                            readingData = { score: correctCount, answers: answers };
                        }
                    } catch (e) {}
                }
                
                // Tạo URL với dữ liệu
                const shareData = {
                    type: 'hsk2',
                    student: {
                        name: studentName,
                        email: studentEmail,
                        phone: studentPhone
                    },
                    listening: listeningData,
                    reading: readingData,
                    timestamp: new Date().toISOString()
                };
                
                const encodedData = encodeURIComponent(JSON.stringify(shareData));
                const shareUrl = `${window.location.origin}${window.location.pathname}?share=${encodedData}`;
                
                // Copy vào clipboard
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        alert(`✅ Đã copy link chia sẻ HSK2!\n\n🔗 Link: ${shareUrl}\n\n📋 Link đã được lưu vào clipboard.`);
                    }).catch(() => {
                        // Fallback
                        const textArea = document.createElement('textarea');
                        textArea.value = shareUrl;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        alert(`✅ Đã copy link chia sẻ HSK2!\n\n🔗 Link: ${shareUrl}\n\n📋 Link đã được lưu vào clipboard.`);
                    });
                } else {
                    // Fallback cho trình duyệt cũ
                    const textArea = document.createElement('textarea');
                    textArea.value = shareUrl;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert(`✅ Đã copy link chia sẻ HSK2!\n\n🔗 Link: ${shareUrl}\n\n📋 Link đã được lưu vào clipboard.`);
                }
                
            } catch (error) {
                console.error('Error generating share link:', error);
                alert('❌ Có lỗi xảy ra khi tạo link chia sẻ!\n\nVui lòng thử lại.');
            }
        }

        async function loadAllData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('tableWrapper').style.display = 'none';
            document.getElementById('searchPhone').value = '';
            document.getElementById('searchEmail').value = '';
            document.getElementById('filterAnswers').value = 'has_answers';

            const { data, error } = await supabaseClient
                .from('placement')
                .select(`
                    *,
                    test_results (*)
                `)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error:', error);
                document.getElementById('loading').innerHTML = '<div class="no-results">Lỗi khi tải dữ liệu</div>';
            } else {
                allData = data;
                applyFilter();
            }
        }

        async function searchData() {
            const phone = document.getElementById('searchPhone').value.trim();
            const email = document.getElementById('searchEmail').value.trim();

            if (!phone && !email) {
                alert('Vui lòng nhập số điện thoại hoặc email để tìm kiếm');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('tableWrapper').style.display = 'none';

            let query = supabaseClient
                .from('placement')
                .select(`
                    *,
                    test_results (*)
                `);

            if (phone) {
                query = query.ilike('phone', `%${phone}%`);
            }
            if (email) {
                query = query.ilike('email', `%${email}%`);
            }

            const { data, error } = await query.order('created_at', { ascending: false });

            if (error) {
                console.error('Error:', error);
                document.getElementById('loading').innerHTML = '<div class="no-results">Lỗi khi tìm kiếm dữ liệu</div>';
            } else {
                allData = data;
                applyFilter();
            }
        }

        function displayData(data) {
            const tbody = document.getElementById('dataTable');
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                document.getElementById('loading').innerHTML = '<div class="no-results">Không tìm thấy kết quả</div>';
                document.getElementById('loading').style.display = 'block';
                return;
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('tableWrapper').style.display = 'block';

            data.forEach((item, index) => {
                const row = document.createElement('tr');
                const testResult = item.test_results && item.test_results.length > 0 ? item.test_results[0] : null;
                
                const score = testResult ? testResult.score : 'N/A';
                const level = testResult ? testResult.selected_level : 'N/A';
                const submitTime = testResult ? new Date(testResult.completed_at).toLocaleString('vi-VN') : 'N/A';
                const writingAiComment = testResult ? testResult.writing_ai_comment : null;
                const phone = item.phone;
                
                // Lấy bài viết từ answers
                let writingAnswer = null;
                if (testResult && testResult.answers && testResult.answers['10']) {
                    writingAnswer = testResult.answers['10'];
                }
                
                // Lưu dữ liệu vào data attributes
                row.dataset.writingAiComment = writingAiComment || '';
                row.dataset.allAnswers = testResult && testResult.answers ? JSON.stringify(testResult.answers) : '{}';
                row.dataset.essay = writingAnswer || '';
                row.dataset.selectedLevel = level || 'HSK1';
                
                
                let scoreClass = 'score-low';
                if (score !== 'N/A') {
                    if (score >= 7) scoreClass = 'score-high';
                    else if (score >= 4) scoreClass = 'score-mid';
                }

                let recommendedLevel = '';
                let recommendedClass = '';
                if (score !== 'N/A') {
                    // Kiểm tra trình độ HSK
                    const levelStr = (level || '1').toString().trim();
                    const isHSK2 = levelStr === '2' || levelStr.toUpperCase() === 'HSK2' || levelStr.toUpperCase() === 'HSK 2';
                    
                    if (isHSK2) {
                        // Logic cho HSK2 (điểm tối đa 200)
                        if (score >= 150) {
                            recommendedLevel = '✅ HSK3 trở lên<br><small style="font-size: 0.85em; font-weight: 400;">Hiểu và sử dụng được các mẫu câu giao tiếp cơ bản</small>';
                            recommendedClass = 'level-excellent';
                        } else {
                            recommendedLevel = '📚 Học lại HSK1-2<br><small style="font-size: 0.85em; font-weight: 400;">Chưa vững từ vựng và cấu trúc ngữ pháp</small>';
                            recommendedClass = 'level-fail';
                        }
                    } else {
                        // Logic cho HSK1 (điểm tối đa 30)
                        if (score >= 24 && score <= 30) {
                            recommendedLevel = '✅ HSK2 trở lên<br><small style="font-size: 0.85em; font-weight: 400;">Đạt xuất sắc - Điểm cao HSK1</small>';
                            recommendedClass = 'level-excellent';
                        } else {
                            recommendedLevel = '📚 HSK1 trở lên<br><small style="font-size: 0.85em; font-weight: 400;">Cần học từ cơ bản</small>';
                            recommendedClass = 'level-fail';
                        }
                    }
                } else {
                    recommendedLevel = 'N/A';
                }

                let answersHtml = '<div class="answers-cell">Chưa có câu trả lời</div>';
                let answersText = 'Chưa có câu trả lời';
                let hasWriting = false;
                
                if (testResult && testResult.answers) {
                    const answers = testResult.answers;
                    answersHtml = '<div class="answers-cell">';
                    let answersList = [];
                    
                    for (let key in answers) {
                        const questionNum = parseInt(key) + 1;
                        const answerValue = answers[key];
                        
                        if (parseInt(key) === 10) {
                            hasWriting = true;
                        }
                        
                        answersHtml += `
                            <div class="answer-item">
                                <span class="answer-label">Q${questionNum}:</span>
                                <span class="answer-value">${answerValue}</span>
                            </div>
                        `;
                        answersList.push(`Q${questionNum}: ${answerValue}`);
                    }
                    answersHtml += '</div>';
                    answersText = answersList.join(', ');
                }

                const rowData = {
                    submitTime: submitTime,
                    fullname: item.fullname,
                    age: item.age,
                    phone: item.phone,
                    email: item.email,
                    score: score,
                    level: level,
                    answersText: answersText,
                    writingAiComment: writingAiComment
                };

                let aiFeedbackBtn = '';
                if (hasWriting && writingAnswer && writingAnswer.trim().length > 0) {
                    const dataId = 'student-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    
                    if (!window.studentFeedbackData) {
                        window.studentFeedbackData = {};
                    }
                    
                    window.studentFeedbackData[dataId] = {
                        fullname: item.fullname,
                        email: item.email,
                        phone: item.phone,
                        essay: writingAnswer,
                        prompt: 'Viết đoạn văn 20–30 từ theo chủ đề "Người bạn của tôi – 我的朋友"',
                        allAnswers: testResult ? testResult.answers : null,
                        writingAiComment: writingAiComment,
                        score: score,
                        selectedLevel: level || 'HSK1'
                    };
                    
                    aiFeedbackBtn = `
                        <button class="ai-feedback-btn" onclick="showAIFeedbackById('${dataId}')">
                            ✍️ Tổng quan bài làm
                        </button>
                    `;
                }

                // Highlight HSK2 trong cột trình độ
                const levelStr = level && level !== 'N/A' ? level.toString().trim() : level;
                const isHSK2Row = levelStr === '2' || levelStr.toUpperCase() === 'HSK2' || levelStr.toUpperCase() === 'HSK 2';
                const levelDisplay = isHSK2Row ? 'HSK2' : (levelStr === '1' || levelStr.toUpperCase() === 'HSK1' || levelStr.toUpperCase() === 'HSK 1') ? 'HSK1' : levelStr;
                const levelClass = isHSK2Row ? 'level-hsk2-badge' : 'level-hsk1-badge';
                
                row.innerHTML = `
                    <td class="time-cell">${submitTime}</td>
                    <td>${item.fullname}</td>
                    <td>${item.age}</td>
                    <td>${item.phone}</td>
                    <td>${item.email}</td>
                    <td><span class="score-badge ${scoreClass}">${score}</span></td>
                    <td><span class="${levelClass}" style="padding: 5px 10px; border-radius: 5px; font-weight: 600; display: inline-block;">${levelDisplay}</span></td>
                    <td>${recommendedLevel !== 'N/A' ? `<div class="recommended-level ${recommendedClass}">${recommendedLevel}</div>` : 'N/A'}</td>
                    <td>${answersHtml}</td>
                    <td class="action-cell">
                        <div class="action-buttons-wrapper">
                            <div class="action-buttons-top">
                                <button class="send-email-btn" onclick="sendEmailFromRow(${index})">
                                    📧 Gửi email
                                </button>
                                <button class="copy-btn" onclick='copyRowData(${JSON.stringify(rowData).replace(/'/g, "&#39;")})'>
                                    📋 Copy
                                </button>
                                ${aiFeedbackBtn}
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }


        async function generateShareLink() {
            try {
                const studentInfo = document.getElementById('studentInfo');
                if (!studentInfo) {
                    alert('❌ Không tìm thấy thông tin học viên!');
                    return;
                }
                
                const studentName = studentInfo.querySelector('p:nth-child(2)')?.textContent?.replace('Họ tên: ', '') || 'HocVien';
                const studentEmail = studentInfo.querySelector('p:nth-child(3)')?.textContent?.replace('Email: ', '') || '';
                const studentPhone = studentInfo.querySelector('p:nth-child(4)')?.textContent?.replace('Số điện thoại: ', '') || '';
                
                const listeningSection = document.getElementById('listeningSection');
                const readingSection = document.getElementById('readingSection');
                const essayDisplay = document.getElementById('essayDisplay');
                const aiFeedbackContent = document.getElementById('aiFeedbackContent');
                
                let listeningData = null;
                let readingData = null;
                let essayData = null;
                let feedbackData = null;
                
                if (listeningSection && listeningSection.style.display !== 'none') {
                    try {
                        const listeningScore = document.getElementById('listeningScore')?.textContent || '0';
                        const listeningGrid = document.getElementById('listeningGrid');
                        if (listeningGrid) {
                            const badges = listeningGrid.querySelectorAll('.answer-badge');
                            const answers = Array.from(badges).map(badge => ({
                                text: badge.textContent.trim(),
                                isCorrect: badge.classList.contains('answer-correct')
                            }));
                            listeningData = { score: listeningScore, answers: answers };
                        }
                    } catch (e) {}
                }
                
                if (readingSection && readingSection.style.display !== 'none') {
                    try {
                        const readingScore = document.getElementById('readingScore')?.textContent || '0';
                        const readingGrid = document.getElementById('readingGrid');
                        if (readingGrid) {
                            const badges = readingGrid.querySelectorAll('.answer-badge');
                            const answers = Array.from(badges).map(badge => ({
                                text: badge.textContent.trim(),
                                isCorrect: badge.classList.contains('answer-correct')
                            }));
                            readingData = { score: readingScore, answers: answers };
                        }
                    } catch (e) {}
                }
                
                if (essayDisplay && essayDisplay.style.display !== 'none') {
                    try {
                        const essayText = document.getElementById('essayText')?.textContent || '';
                        if (essayText.trim()) {
                            essayData = essayText;
                        }
                    } catch (e) {}
                }
                
                if (aiFeedbackContent) {
                    try {
                        const feedbackHTML = aiFeedbackContent.innerHTML;
                        const feedbackText = feedbackHTML
                            .replace(/<br\s*\/?>/gi, '\n')
                            .replace(/<p[^>]*>/gi, '')
                            .replace(/<\/p>/gi, '\n\n')
                            .replace(/<[^>]*>/g, '')
                            .trim();
                        if (feedbackText) {
                            feedbackData = feedbackText;
                        }
                    } catch (e) {}
                }
                
                const totalScoreElement = document.getElementById('totalScore');
                const currentScore = totalScoreElement ? totalScoreElement.textContent : null;
                
                const shareData = {
                    student: {
                        name: studentName,
                        email: studentEmail,
                        phone: studentPhone
                    },
                    score: currentScore,
                    listening: listeningData,
                    reading: readingData,
                    essay: essayData,
                    feedback: feedbackData,
                    timestamp: new Date().toISOString()
                };
                
                const jsonString = JSON.stringify(shareData);
                const encodedData = btoa(encodeURIComponent(jsonString));
                
                const currentUrl = window.location.origin + window.location.pathname;
                const shareUrl = `${currentUrl}?view=feedback&data=${encodedData}`;
                
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        alert('✅ Đã copy link thành công!');
                    }).catch((clipError) => {
                        const textArea = document.createElement('textarea');
                        textArea.value = shareUrl;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        
                        alert('✅ Đã copy link thành công!');
                    });
                } else {
                    const textArea = document.createElement('textarea');
                    textArea.value = shareUrl;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    alert('✅ Đã copy link thành công!');
                }
                
            } catch (error) {
                alert(`❌ Có lỗi xảy ra khi tạo link chia sẻ.\n\nChi tiết lỗi: ${error.message}\n\nVui lòng thử lại.`);
            }
        }

        function sendEmailFromModal() {
            try {
                const studentInfo = document.getElementById('studentInfo');
                const studentName = studentInfo.querySelector('p:nth-child(2)')?.textContent?.replace('Họ tên: ', '') || 'Học viên';
                const studentEmail = studentInfo.querySelector('p:nth-child(3)')?.textContent?.replace('Email: ', '') || '';
                
                if (!studentEmail) {
                    alert('❌ Không tìm thấy email học viên!');
                    return;
                }
                
                // Tạo nội dung email
                const emailSubject = `Kết quả bài test HSK - ${studentName}`;
                const emailBody = `Xin chào ${studentName},\n\nĐây là kết quả bài test HSK của bạn.\n\nVui lòng xem chi tiết tại link: ${window.location.href}\n\nTrân trọng!`;
                
                // Tạo mailto link
                const mailtoLink = `mailto:${studentEmail}?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
                
                // Mở email client
                window.open(mailtoLink);
                
                alert(`✅ Đã mở ứng dụng email!\n\nEmail sẽ được gửi đến: ${studentEmail}\n\nNội dung đã được điền sẵn.`);
                
            } catch (error) {
                console.error('Lỗi khi gửi email:', error);
                alert('❌ Có lỗi xảy ra khi gửi email. Vui lòng thử lại.');
            }
        }

        function copyModalData() {
            try {
                const studentInfo = document.getElementById('studentInfo');
                const studentName = studentInfo.querySelector('p:nth-child(2)')?.textContent?.replace('Họ tên: ', '') || 'Học viên';
                const studentEmail = studentInfo.querySelector('p:nth-child(3)')?.textContent?.replace('Email: ', '') || '';
                const studentPhone = studentInfo.querySelector('p:nth-child(4)')?.textContent?.replace('Số điện thoại: ', '') || '';
                
                // Lấy điểm số
                const listeningScore = document.getElementById('listeningScore')?.textContent || '0';
                const readingScore = document.getElementById('readingScore')?.textContent || '0';
                
                // Lấy nhận xét AI
                const aiFeedbackContent = document.getElementById('aiFeedbackContent');
                const feedbackText = aiFeedbackContent ? aiFeedbackContent.textContent : 'Chưa có nhận xét';
                
                // Tạo nội dung copy
                const copyText = `
KẾT QUẢ BÀI TEST HSK
====================

THÔNG TIN HỌC VIÊN:
- Họ và tên: ${studentName}
- Email: ${studentEmail}
- Số điện thoại: ${studentPhone}

KẾT QUẢ BÀI TEST:
- Phần Nghe: ${listeningScore}/5 đúng
- Phần Điền Đáp Án: ${readingScore}/5 đúng

NHẬN XÉT BÀI VIẾT:
${feedbackText}

Ngày xuất báo cáo: ${new Date().toLocaleDateString('vi-VN')}
                `.trim();
                
                // Copy vào clipboard
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(copyText).then(() => {
                        alert('✅ Đã copy dữ liệu vào clipboard!\n\nBạn có thể paste vào bất kỳ đâu để sử dụng.');
                    }).catch(() => {
                        // Fallback
                        const textArea = document.createElement('textarea');
                        textArea.value = copyText;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        alert('✅ Đã copy dữ liệu vào clipboard!');
                    });
                } else {
                    // Fallback cho trình duyệt cũ
                    const textArea = document.createElement('textarea');
                    textArea.value = copyText;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('✅ Đã copy dữ liệu vào clipboard!');
                }
                
            } catch (error) {
                console.error('Lỗi khi copy dữ liệu:', error);
                alert('❌ Có lỗi xảy ra khi copy dữ liệu. Vui lòng thử lại.');
            }
        }

        function displaySharedFeedback(shareData) {
            try {
                // Hiển thị modal
                const modal = document.getElementById('aiFeedbackModal');
                modal.classList.add('show');
                
                // Ẩn nút "Tạo link chia sẻ" khi xem link chia sẻ
                const pdfBtn = document.querySelector('.pdf-export-btn');
                if (pdfBtn) {
                    pdfBtn.style.display = 'none';
                }
                
                // Điền thông tin học viên
                document.getElementById('studentInfo').innerHTML = `
                    <h3>👤 Thông tin học viên</h3>
                    <p><strong>Họ tên:</strong> ${shareData.student.name}</p>
                    <p><strong>Email:</strong> ${shareData.student.email}</p>
                    <p><strong>Số điện thoại:</strong> ${shareData.student.phone}</p>
                `;
                
                // Hiển thị kết quả test nếu có điểm số
                if (shareData.score !== undefined && shareData.score !== null) {
                    displayTestResultFromScore(shareData.score);
                } else if (shareData.listening && shareData.reading) {
                    // Fallback: tính điểm từ câu trả lời nếu không có điểm từ database
                    const allAnswers = {};
                    if (shareData.listening.answers) {
                        shareData.listening.answers.forEach((answer, index) => {
                            allAnswers[index] = answer.text.split(': ')[1] || answer.text;
                        });
                    }
                    if (shareData.reading.answers) {
                        shareData.reading.answers.forEach((answer, index) => {
                            allAnswers[index + 5] = answer.text.split(': ')[1] || answer.text;
                        });
                    }
                    displayTestResult(allAnswers);
                }
                
                // Hiển thị phần Nghe
                if (shareData.listening) {
                    const listeningSection = document.getElementById('listeningSection');
                    const listeningGrid = document.getElementById('listeningGrid');
                    const listeningScore = document.getElementById('listeningScore');
                    
                    listeningSection.style.display = 'block';
                    listeningScore.textContent = shareData.listening.score;
                    listeningGrid.innerHTML = '';
                    
                    shareData.listening.answers.forEach(answer => {
                        const badge = document.createElement('div');
                        badge.className = `answer-badge ${answer.isCorrect ? 'answer-correct' : 'answer-incorrect'}`;
                        badge.innerHTML = `
                            ${answer.text} <span class="answer-icon">${answer.isCorrect ? '✓' : '✗'}</span>
                        `;
                        listeningGrid.appendChild(badge);
                    });
                }
                
                // Hiển thị phần Điền Đáp Án
                if (shareData.reading) {
                    const readingSection = document.getElementById('readingSection');
                    const readingGrid = document.getElementById('readingGrid');
                    const readingScore = document.getElementById('readingScore');
                    
                    readingSection.style.display = 'block';
                    readingScore.textContent = shareData.reading.score;
                    readingGrid.innerHTML = '';
                    
                    shareData.reading.answers.forEach(answer => {
                        const badge = document.createElement('div');
                        badge.className = `answer-badge ${answer.isCorrect ? 'answer-correct' : 'answer-incorrect'}`;
                        badge.innerHTML = `
                            ${answer.text} <span class="answer-icon">${answer.isCorrect ? '✓' : '✗'}</span>
                        `;
                        readingGrid.appendChild(badge);
                    });
                }
                
                // Hiển thị bài viết
                if (shareData.essay) {
                    const essayDisplay = document.getElementById('essayDisplay');
                    const essayText = document.getElementById('essayText');
                    
                    essayDisplay.style.display = 'block';
                    essayText.textContent = shareData.essay;
                }
                
                // Hiển thị nhận xét AI
                if (shareData.feedback) {
                    const feedbackContent = document.getElementById('aiFeedbackContent');
                    const paragraphs = shareData.feedback.split('\n\n').filter(p => p.trim());
                    let formattedHTML = '';
                    
                    if (paragraphs.length > 0) {
                        paragraphs.forEach(para => {
                            const cleaned = para.trim().replace(/\n/g, '<br>');
                            formattedHTML += `<p>${cleaned}</p>`;
                        });
                    } else {
                        formattedHTML = `<p>${shareData.feedback.replace(/\n/g, '<br>')}</p>`;
                    }
                    
                    feedbackContent.innerHTML = formattedHTML;
                }
                
            } catch (error) {
                console.error('Lỗi khi hiển thị feedback:', error);
                alert('❌ Có lỗi khi hiển thị kết quả bài test.');
            }
        }

        function checkForSharedLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const view = urlParams.get('view');
            const data = urlParams.get('data');
            const share = urlParams.get('share');
            
            if (view === 'feedback' && data) {
                try {
                    // Ẩn toàn bộ dashboard
                    document.querySelector('.container').style.display = 'none';
                    
                    // Thay đổi background body
                    document.body.style.background = 'linear-gradient(135deg, #74b9ff 0%, #0984e3 50%, #00b894 100%)';
                    
                    // Decode base64 và xử lý Unicode
                    const decodedData = decodeURIComponent(atob(data));
                    const shareData = JSON.parse(decodedData);
                    displaySharedFeedback(shareData);
                } catch (error) {
                    console.error('Lỗi khi decode dữ liệu:', error);
                    alert('❌ Link chia sẻ không hợp lệ.');
                }
            } else if (share) {
                try {
                    // Ẩn toàn bộ dashboard
                    document.querySelector('.container').style.display = 'none';
                    
                    // Thay đổi background body và reset margin/padding
                    document.body.style.background = 'linear-gradient(135deg, #74b9ff 0%, #0984e3 50%, #00b894 100%)';
                    document.body.style.margin = '0';
                    document.body.style.padding = '0';
                    
                    // Parse dữ liệu share
                    const shareData = JSON.parse(decodeURIComponent(share));
                    
                    // Hiển thị modal tương ứng
                    if (shareData.type === 'hsk2') {
                        // Tạo allAnswers object từ listening và reading data
                        const allAnswers = {};
                        if (shareData.listening && shareData.listening.answers) {
                            shareData.listening.answers.forEach((answer, index) => {
                                // Extract answer from format like "1:true✓" -> "true"
                                const match = answer.text.match(/(\d+):(.+?)[✓✗]/);
                                if (match) {
                                    allAnswers[index] = match[2];
                                }
                            });
                        }
                        if (shareData.reading && shareData.reading.answers) {
                            shareData.reading.answers.forEach((answer, index) => {
                                // Extract answer from format like "36:A✓" -> "A"
                                const match = answer.text.match(/(\d+):(.+?)[✓✗]/);
                                if (match) {
                                    allAnswers[index + 35] = match[2];
                                }
                            });
                        }
                        
                        // Tính điểm tổng từ số câu đúng (mỗi câu = 2 điểm)
                        let totalScore = 0;
                        if (shareData.listening && shareData.listening.score) {
                            totalScore += (parseInt(shareData.listening.score) || 0) * 2;
                        }
                        if (shareData.reading && shareData.reading.score) {
                            totalScore += (parseInt(shareData.reading.score) || 0) * 2;
                        }
                        
                        showHSK2Feedback(
                            shareData.student.name,
                            shareData.student.email,
                            shareData.student.phone,
                            '',
                            '',
                            allAnswers,
                            '',
                            totalScore
                        );
                    }
                } catch (error) {
                    console.error('Lỗi khi parse share data:', error);
                    alert('❌ Link chia sẻ không hợp lệ.');
                }
            }
        }

        // Auto-detect và fix redirect URI issues
        function autoFixRedirectURI() {
            const currentDomain = window.location.origin;
            const currentPath = window.location.pathname;
            
            // Log current URL info
            console.log('🔍 Current URL Info:', {
                origin: currentDomain,
                pathname: currentPath,
                href: window.location.href
            });
            
            // Check if we're on a path that might cause 404
            if (currentPath !== '/' && currentPath !== '/index.html') {
                console.warn('⚠️ Current path might cause 404:', currentPath);
                console.log('💡 Suggestion: Use redirect URI:', currentDomain);
            }
            
            // Log redirect URI for debugging
            console.log('🔗 Redirect URI being used:', REDIRECT_URI);
        }

        // Handle Google OAuth redirect
        function handleOAuthRedirect() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (error) {
                console.error('OAuth error:', error);
                alert('Lỗi xác thực: ' + error);
                return;
            }
            
            if (code) {
                console.log('OAuth code received:', code);
                // Handle the authorization code if needed
                // For now, just clear the URL parameters
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Handle OAuth redirect
            handleOAuthRedirect();
            
            // Auto-fix redirect URI
            autoFixRedirectURI();
            
            // Initialize authentication
            setTimeout(() => {
                initializeGoogleAuth();
                initializeGmailAPI();
            }, 1000);

            // Check if user is already logged in
            if (!checkAuthStatus()) {
                // Show login modal if not authenticated
                document.getElementById('loginModal').classList.add('show');
            }

            document.getElementById('searchPhone').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchData();
            });
            document.getElementById('searchEmail').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchData();
            });

            // Event listeners cho email modal đã được xóa vì không cần preview nữa

            // Đóng modal khi click bên ngoài
            document.getElementById('emailModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeEmailModal();
                }
            });

            // Kiểm tra link chia sẻ
            checkForSharedLink();
            
            // Nếu không có link chia sẻ và đã đăng nhập thì load data
            if (!window.location.search.includes('view=feedback') && currentUser) {
                loadAllData();
            }
        });
    </script>
</body>
</html>
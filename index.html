<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Placement Test Dashboard</title>
    
    <!-- Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob:;
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://accounts.google.com https://apis.google.com https://www.gstatic.com https://ssl.gstatic.com https://esm.sh;
        style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://accounts.google.com;
        font-src 'self' https://fonts.gstatic.com;
        img-src 'self' data: blob: https: https://www.gstatic.com;
        connect-src 'self' https://axllpuaybdzubfmsfkws.supabase.co https://accounts.google.com https://www.googleapis.com https://oauth2.googleapis.com https://gmail.googleapis.com https://cdnjs.cloudflare.com wss:;
        frame-src 'self' https://accounts.google.com https://accounts.google.com/gsi/;
        object-src 'none';
        base-uri 'self';
        form-action 'self';
    ">
    
    <!-- CORS and Security Headers -->
    <meta http-equiv="Cross-Origin-Opener-Policy" content="unsafe-none">
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="unsafe-none">
    <meta http-equiv="Cross-Origin-Resource-Policy" content="cross-origin">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        h1 {
            color: #11998e;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .search-bar {
            display: flex;
            gap: 15px;
            flex-wrap: nowrap;
            align-items: end;
        }

        .search-group {
            flex: 1;
            min-width: 180px;
        }

        .search-actions {
            display: flex;
            gap: 10px;
            align-items: end;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 600;
            font-size: 0.9em;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #11998e;
            box-shadow: 0 0 0 3px rgba(17, 153, 142, 0.1);
        }

        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
            background: white;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: #11998e;
            box-shadow: 0 0 0 3px rgba(17, 153, 142, 0.1);
        }

        .btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            align-self: flex-end;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .table-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        thead {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            border-right: 2px solid rgba(255, 255, 255, 0.3);
        }

        th:last-child {
            border-right: none;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            border-right: 1px solid #f0f0f0;
            vertical-align: top;
        }

        td:last-child {
            border-right: none;
        }

        tbody tr {
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #f0fdf4;
        }

        .score-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .score-low { background: #fee; color: #c33; }
        .score-mid { background: #fff4e6; color: #e67700; }
        .score-high { background: #d1fae5; color: #065f46; }

        .recommended-level {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .level-excellent {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 2px solid #34d399;
        }

        .level-fail {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 2px solid #f87171;
        }

        .level-hsk1-badge {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            border: 1px solid #3b82f6;
        }

        .level-hsk2-badge {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border: 1px solid #f59e0b;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2em;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .answers-cell {
            max-width: 250px;
            max-height: 120px;
            overflow-y: auto;
            font-size: 0.8em;
            line-height: 1.4;
        }

        .answer-item {
            padding: 6px 8px;
            border-bottom: 1px solid #e0e0e0;
        }

        .answer-item:last-child {
            border-bottom: none;
        }

        .answer-label {
            font-weight: 700;
            color: #11998e;
            display: inline-block;
            min-width: 30px;
        }

        .answer-value {
            color: #333;
            word-break: break-word;
        }

        .time-cell {
            white-space: nowrap;
            font-size: 0.9em;
        }

        .send-email-btn {
            background: linear-gradient(135deg, #ff6b35 0%, #ff8c42 100%);
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .send-email-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
            background: linear-gradient(135deg, #ff5722 0%, #ff7733 100%);
        }

        .send-email-btn:active {
            transform: translateY(0);
        }

        .copy-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-left: 8px;
        }

        .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #5568d3 0%, #6a3f91 100%);
        }

        .copy-btn:active {
            transform: translateY(0);
        }

        .ai-feedback-btn {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #78350f;
            padding: 8px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 8px;
            width: 100%;
            justify-content: center;
            text-align: center;
        }

        .ai-feedback-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .ai-feedback-btn:active {
            transform: translateY(0);
        }

        .ai-feedback-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .action-cell {
            white-space: nowrap;
        }

        .action-buttons-wrapper {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .action-buttons-top {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .action-buttons-top .send-email-btn,
        .action-buttons-top .copy-btn,
        .ai-feedback-btn {
            flex: 1;
            min-width: 0;
            text-align: center;
            justify-content: center;
            display: flex;
            align-items: center;
            margin-top: 0;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.show {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 0;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            padding: 25px 30px;
            border-bottom: 3px solid #fbbf24;
            border-radius: 15px 15px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 800;
            color: #92400e;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #92400e;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .modal-close:hover {
            background: white;
            color: #78350f;
            transform: rotate(90deg);
        }

        .pdf-export-btn {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-left: 15px;
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
        }

        .pdf-export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
            background: linear-gradient(135deg, #b91c1c 0%, #dc2626 100%);
        }

        .pdf-export-btn:active {
            transform: translateY(0);
        }

        .action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            min-height: 40px;
            text-align: center;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, #5568d3 0%, #6a3f91 100%);
        }

        .action-btn:active {
            transform: translateY(0);
        }

        .modal-body {
            padding: 30px;
        }

        .student-info {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #fbbf24;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
        }

        .student-info h3 {
            color: #1e7e5f;
            margin-bottom: 12px;
            font-size: 18px;
        }

        .student-info p {
            color: #555;
            margin: 8px 0;
            font-size: 14px;
        }

        .student-info strong {
            color: #333;
            font-weight: 600;
        }

        .test-result-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #11998e;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
        }

        .test-result-section h3 {
            color: #11998e;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .score-display {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .score-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            text-align: center;
        }

        .score-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            display: inline-block;
            margin-left: 10px;
        }

        .result-details {
            background: rgba(255, 255, 255, 0.9);
            padding: 0;
            border-radius: 12px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            gap: 0;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            align-items: stretch;
        }

        .result-item {
            text-align: center;
            padding: 12px 8px;
            border-right: 1px solid #e9ecef;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 70px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            width: 33.333%;
            box-sizing: border-box;
        }

        .result-item:last-child {
            border-right: none;
        }

        .result-item h4 {
            margin: 0 0 6px 0;
            font-size: 12px;
            font-weight: 600;
            color: #2c3e50;
        }

        .result-item p {
            margin: 0;
            font-size: 11px;
            line-height: 1.3;
        }

        .result-item h4 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .status-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            text-transform: uppercase;
            display: inline-block;
        }

        .status-excellent {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 2px solid #34d399;
        }

        .status-fail {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 2px solid #f87171;
        }

        .comment-text, .path-text {
            font-size: 1em;
            line-height: 1.5;
            color: #495057;
            margin: 0;
            font-weight: 500;
        }

        .path-text {
            color: #11998e;
            font-weight: bold;
        }

        .answers-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
            border-left: 4px solid #11998e;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .answers-section.listening {
            border-left: 4px solid #11998e;
        }
        
        .answers-section.reading {
            border-left: 4px solid #11998e;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e7e5f;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title span {
            color: #11998e;
            font-weight: 800;
        }

        .answers-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: flex-start;
        }

        .answer-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 12px;
            transition: transform 0.2s;
            position: relative;
            cursor: pointer;
            white-space: nowrap;
            min-width: 60px;
        }

        .answer-badge:hover {
            transform: scale(1.05);
        }

        .answer-tooltip {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .answer-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #1f2937;
        }

        .answer-badge:hover .answer-tooltip {
            display: block;
        }

        .answer-correct {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #34d399;
        }

        .answer-incorrect {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #f87171;
        }

        .answer-icon {
            margin-left: 6px;
            font-size: 16px;
        }

        .writing-section {
            background: rgba(255, 255, 255, 0.95);
            border: 2.5px solid #fbbf24;
            border-radius: 15px;
            padding: 22px 26px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .writing-section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
            pointer-events: none;
        }

        .writing-title {
            font-weight: 800;
            color: #92400e;
            margin-bottom: 14px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            z-index: 1;
        }

        .writing-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            box-shadow: 0 3px 10px rgba(251, 191, 36, 0.4);
        }

        .writing-content {
            color: #78350f;
            line-height: 1.7;
            font-size: 15px;
            position: relative;
            z-index: 1;
        }

        .writing-content p {
            background: rgba(255, 255, 255, 0.5);
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 3px solid #fbbf24;
        }

        .writing-content p:last-child {
            margin-bottom: 0;
        }

        .essay-display {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
        }

        .essay-display h4 {
            color: #1e7e5f;
            margin-bottom: 12px;
            font-size: 16px;
        }

        .essay-text {
            color: #333;
            line-height: 1.8;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #11998e;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #0d7a6f;
        }

        /* Email Modal Styles - Gi·ªëng nh∆∞ modal t·ªïng quan b√†i l√†m */
        .email-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 2px solid #e5e7eb;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #1e7e5f;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }

        .form-group input:focus {
            outline: none;
            border-color: #11998e;
            box-shadow: 0 0 0 3px rgba(17, 153, 142, 0.1);
        }

        .email-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            justify-content: center;
        }

        .email-actions .btn,
        .email-actions .copy-btn {
            flex: 1;
            max-width: 200px;
            padding: 12px 20px;
            font-size: 14px;
        }

        /* Student info section gi·ªëng nh∆∞ modal t·ªïng quan */
        .email-student-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid #fbbf24;
        }

        .email-student-info h3 {
            color: #1e7e5f;
            margin-bottom: 12px;
            font-size: 18px;
        }

        .email-student-info p {
            color: #555;
            margin: 8px 0;
            font-size: 14px;
        }

        .email-student-info strong {
            color: #333;
            font-weight: 600;
        }

        /* Test result section gi·ªëng nh∆∞ modal t·ªïng quan */
        .email-test-result-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            border-left: 4px solid #11998e;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .email-test-result-section h3 {
            color: #11998e;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .email-score-display {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .email-score-info {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            text-align: center;
        }

        .email-score-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            display: inline-block;
            margin-left: 10px;
        }

        .email-result-details {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
        }

        .email-result-item {
            text-align: center;
            padding: 10px;
            border-right: 1px solid #e9ecef;
        }

        .email-result-item:last-child {
            border-right: none;
        }

        .email-result-item h4 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 16px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .email-status-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            text-transform: uppercase;
            display: inline-block;
        }

        .email-status-excellent {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 2px solid #34d399;
        }

        .email-status-fail {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 2px solid #f87171;
        }

        .email-comment-text, .email-path-text {
            font-size: 1em;
            line-height: 1.5;
            color: #495057;
            margin: 0;
            font-weight: 500;
        }

        .email-path-text {
            color: #11998e;
            font-weight: bold;
        }

        /* Login Modal Styles */
        .login-form {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            text-align: center;
        }

        .login-info {
            margin-bottom: 30px;
        }

        .login-info h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 24px;
        }

        .login-info p {
            color: #6c757d;
            font-size: 16px;
            line-height: 1.6;
        }

        .google-login-container {
            margin: 30px 0;
            display: flex;
            justify-content: center;
        }

        .login-footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .login-footer p {
            color: #6c757d;
            font-size: 14px;
            margin: 0;
        }

        /* User info display */
        .user-info {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-details {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-email {
            font-size: 12px;
            opacity: 0.9;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        /* Hide content when not logged in */
        .content-protected {
            display: none;
        }

        .content-protected.show {
            display: block;
        }

        /* Debug tools styling */
        .email-debug-actions {
            transition: all 0.3s ease;
            max-height: 200px;
            overflow: hidden;
        }

        .email-debug-actions.collapsed {
            max-height: 0;
            overflow: hidden;
            margin-top: 0;
            padding-top: 0;
            border-top: none;
        }

        .debug-toggle {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            color: #6c757d;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            margin-bottom: 8px;
            display: inline-block;
        }

        .debug-toggle:hover {
            background: #e9ecef;
        }

        /* Responsive design for result details */
        @media (max-width: 600px) {
            .result-details {
                flex-direction: column;
            }
            .result-item {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
                width: 100%;
            }
            .result-item:last-child {
                border-bottom: none;
            }
        }

        /* Responsive design for search bar */
        @media (max-width: 768px) {
            .search-bar {
                flex-wrap: wrap;
            }
            .search-group {
                min-width: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Dashboard</h1>
            <div class="user-info" id="userInfo" style="display: none;">
                <div class="user-details">
                    <img id="userAvatar" class="user-avatar" src="" alt="Avatar">
                    <div>
                        <div class="user-name" id="userName"></div>
                        <div class="user-email" id="userEmail"></div>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">üö™ ƒêƒÉng xu·∫•t</button>
            </div>
            <div class="search-bar content-protected">
                <div class="search-group">
                    <label for="searchPhone">T√¨m ki·∫øm theo S·ªë ƒëi·ªán tho·∫°i</label>
                    <input type="text" id="searchPhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i...">
                </div>
                <div class="search-group">
                    <label for="searchEmail">T√¨m ki·∫øm theo Email</label>
                    <input type="text" id="searchEmail" placeholder="Nh·∫≠p email...">
                </div>
                <div class="search-group">
                    <label for="filterAnswers">Tr·∫°ng th√°i</label>
                    <select id="filterAnswers" onchange="applyFilter()">
                        <option value="has_answers">ƒê√£ ho√†n th√†nh</option>
                        <option value="all">T·∫•t c·∫£</option>
                        <option value="no_answers">Ch∆∞a ho√†n th√†nh</option>
                    </select>
                </div>
                <div class="search-actions">
                    <button class="btn" onclick="searchData()">üîç T√¨m ki·∫øm</button>
                    <button class="btn" onclick="loadAllData()">üîÑ Hi·ªÉn th·ªã t·∫•t c·∫£</button>
                </div>
            </div>
        </div>

        <div class="table-container content-protected">
            <div id="loading" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
            <div id="tableWrapper" style="display:none;">
                <table>
                    <thead>
                        <tr>
                            <th>Th·ªùi gian n·ªôp b√†i</th>
                            <th>H·ªç v√† t√™n</th>
                            <th>Tu·ªïi</th>
                            <th>S·ªë ƒëi·ªán tho·∫°i</th>
                            <th>Email</th>
                            <th>ƒêi·ªÉm</th>
                            <th>Tr√¨nh ƒë·ªô HSK HV ch·ªçn</th>
                            <th>Tr√¨nh ƒë·ªô ƒë·ªÅ xu·∫•t h·ªçc</th>
                            <th>C√¢u tr·∫£ l·ªùi</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="aiFeedbackModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="writing-icon">‚úçÔ∏è</span>
                    Nh·∫≠n x√©t b√†i vi·∫øt
                    <button class="pdf-export-btn" onclick="generateShareLink()">
                        üîó Copy link
                    </button>
                </div>
                <button class="modal-close" onclick="closeAIFeedbackModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="student-info" id="studentInfo"></div>
                
                <div class="test-result-section" id="testResultSection" style="display:none;">
                    <h3>üìä K·∫øt qu·∫£ b√†i test</h3>
                    <div class="score-display">
                        <div class="score-info">
                            <h4>ƒêi·ªÉm s·ªë: <span class="score-value" id="totalScore">0</span>/30</h4>
                        </div>
                        
                        <div class="result-details">
                            <div class="result-item">
                                <h4>üìã Tr·∫°ng th√°i</h4>
                                <span class="status-badge" id="statusBadge">ƒêang x·ª≠ l√Ω...</span>
                            </div>
                            
                            <div class="result-item">
                                <h4>üìù Nh·∫≠n x√©t</h4>
                                <p class="comment-text" id="commentText">ƒêang x·ª≠ l√Ω...</p>
                            </div>
                            
                            <div class="result-item">
                                <h4>üìö L·ªô tr√¨nh h·ªçc g·ª£i √Ω</h4>
                                <p class="path-text" id="learningPathText">ƒêang x·ª≠ l√Ω...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="answers-section" id="listeningSection" style="display:none;">
                    <div class="section-title">
                        üìª Ph·∫ßn Nghe: <span id="listeningScore">0</span>/5 ƒë√∫ng
                    </div>
                    <div class="answers-grid" id="listeningGrid"></div>
                </div>
                
                <div class="answers-section" id="readingSection" style="display:none;">
                    <div class="section-title">
                        üìñ Ph·∫ßn ƒêi·ªÅn ƒê√°p √Ån: <span id="readingScore">0</span>/5 ƒë√∫ng
                    </div>
                    <div class="answers-grid" id="readingGrid"></div>
                </div>

                <div class="essay-display" id="essayDisplay" style="display:none;">
                    <h4>üìù B√†i vi·∫øt c·ªßa h·ªçc vi√™n:</h4>
                    <div class="essay-text" id="essayText"></div>
                </div>
                <div class="writing-section">
                    <div class="writing-title">
                        <span class="writing-icon">üí¨</span>
                        Nh·∫≠n x√©t b√†i vi·∫øt
                    </div>
                    <div id="aiFeedbackContent" class="writing-content"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal t·ªïng quan b√†i l√†m HSK2 -->
    <div class="modal-overlay" id="hsk2FeedbackModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="writing-icon">üìä</span>
                    Nh·∫≠n x√©t t·ªïng quan HSK2
                    <button class="pdf-export-btn" onclick="generateShareLinkHSK2()">
                        üîó Copy link
                    </button>
                </div>
                <button class="modal-close" onclick="closeHSK2FeedbackModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="student-info" id="hsk2StudentInfo"></div>
                
                <div class="test-result-section" id="hsk2TestResultSection" style="display:none;">
                    <h3>üìä K·∫øt qu·∫£ b√†i test HSK2</h3>
                    <div class="score-display">
                        <div class="score-info">
                            <h4>ƒêi·ªÉm s·ªë: <span class="score-value" id="hsk2TotalScore">0</span>/200</h4>
                        </div>
                        
                        <div class="result-details">
                            <div class="result-item">
                                <h4>üìã Tr·∫°ng th√°i</h4>
                                <span class="status-badge" id="hsk2StatusBadge">ƒêang x·ª≠ l√Ω...</span>
                            </div>
                            
                            <div class="result-item">
                                <h4>üìù Nh·∫≠n x√©t</h4>
                                <p class="comment-text" id="hsk2CommentText">ƒêang x·ª≠ l√Ω...</p>
                            </div>
                            
                            <div class="result-item">
                                <h4>üìö L·ªô tr√¨nh h·ªçc g·ª£i √Ω</h4>
                                <p class="path-text" id="hsk2LearningPathText">ƒêang x·ª≠ l√Ω...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ph·∫ßn Nghe hi·ªÉu (35 c√¢u) -->
                <div class="answers-section" id="hsk2ListeningSection" style="display:none;">
                    <div class="section-title">
                        üéß Nghe hi·ªÉu: <span id="hsk2ListeningScore">0</span>/35 ƒë√∫ng
                    </div>
                    <div class="answers-grid" id="hsk2ListeningGrid"></div>
                </div>
                
                <!-- Ph·∫ßn ƒê·ªçc hi·ªÉu (25 c√¢u) -->
                <div class="answers-section" id="hsk2ReadingSection" style="display:none;">
                    <div class="section-title">
                        üìñ ƒê·ªçc hi·ªÉu: <span id="hsk2ReadingScore">0</span>/25 ƒë√∫ng
                    </div>
                    <div class="answers-grid" id="hsk2ReadingGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal g·ª≠i email -->
    <div class="modal-overlay" id="emailModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="writing-icon">üìß</span>
                    G·ª≠i email k·∫øt qu·∫£ b√†i test
                </div>
                <button class="modal-close" onclick="closeEmailModal()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="email-student-info" id="emailStudentInfo">
                    <h3>üë§ Th√¥ng tin h·ªçc vi√™n</h3>
                    <p><strong>H·ªç t√™n:</strong> <span id="emailStudentName">ƒêang t·∫£i...</span></p>
                    <p><strong>Email:</strong> <span id="emailStudentEmail">ƒêang t·∫£i...</span></p>
                    <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> <span id="emailStudentPhone">ƒêang t·∫£i...</span></p>
                </div>
                
                <div class="email-test-result-section" id="emailTestResultSection" style="display:none;">
                    <h3>üìä K·∫øt qu·∫£ b√†i test</h3>
                    <div class="email-score-display">
                        <div class="email-score-info">
                            <h4>ƒêi·ªÉm s·ªë: <span class="email-score-value" id="emailTotalScore">0</span>/<span id="emailMaxScore">30</span></h4>
                        </div>
                        
                        <div class="email-result-details">
                            <div class="email-result-item">
                                <h4>üìã Tr·∫°ng th√°i</h4>
                                <span class="email-status-badge" id="emailStatusBadge">ƒêang x·ª≠ l√Ω...</span>
                            </div>
                            
                            <div class="email-result-item">
                                <h4>üìù Nh·∫≠n x√©t</h4>
                                <p class="email-comment-text" id="emailCommentText">ƒêang x·ª≠ l√Ω...</p>
                            </div>
                            
                            <div class="email-result-item">
                                <h4>üìö L·ªô tr√¨nh h·ªçc g·ª£i √Ω</h4>
                                <p class="email-path-text" id="emailLearningPathText">ƒêang x·ª≠ l√Ω...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="email-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="emailTo">Email ng∆∞·ªùi nh·∫≠n:</label>
                            <input type="email" id="emailTo" placeholder="Nh·∫≠p email ng∆∞·ªùi nh·∫≠n..." required>
                        </div>
                        
                        <div class="form-group">
                            <label for="emailFrom">T√™n ng∆∞·ªùi g·ª≠i:</label>
                            <input type="text" id="emailFrom" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi g·ª≠i..." value="ALOHA">
                        </div>
                        
                        <div class="form-group">
                            <label for="emailSubject">Ti√™u ƒë·ªÅ email:</label>
                            <input type="text" id="emailSubject" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ email..." value="ALOHA TR·∫¢ K·∫æT QU·∫¢ TEST HSK">
                        </div>
                    </div>
                    
                    <div class="email-actions">
                        <button class="btn" onclick="sendEmailWithTemplate()">
                            G·ª≠i email
                        </button>
                        <button class="copy-btn" onclick="copyEmailTemplate()">
                            Copy n·ªôi dung
                        </button>
                    </div>
                    
                    <div class="email-debug-actions collapsed" id="debugTools" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e0e0e0;">
                        <div class="debug-toggle" onclick="toggleDebugTools()">
                            üîß Debug Tools (click ƒë·ªÉ m·ªü/ƒë√≥ng)
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="copy-btn" onclick="testUnicodeEncoding()" style="background: #e83e8c; font-size: 12px; padding: 6px 12px;">
                                üß™ Test Unicode
                            </button>
                            <button class="copy-btn" onclick="forceReloadGoogleServices()" style="background: #fd7e14; font-size: 12px; padding: 6px 12px;">
                                üîÑ Reload APIs
                            </button>
                            <button class="copy-btn" onclick="retryGmailAuth()" style="background: #ffc107; color: #000; font-size: 12px; padding: 6px 12px;">
                                üîÑ Th·ª≠ l·∫°i Gmail
                            </button>
                            <button class="copy-btn" onclick="testRedirectURI()" style="background: #17a2b8; font-size: 12px; padding: 6px 12px;">
                                üß™ Test URI
                            </button>
                            <button class="copy-btn" onclick="checkRedirectURI()" style="background: #dc3545; font-size: 12px; padding: 6px 12px;">
                                üîó Fix 400
                            </button>
                            <button class="copy-btn" onclick="debugGoogleAPIs()" style="background: #6f42c1; font-size: 12px; padding: 6px 12px;">
                                üîç Debug
                            </button>
                            <button class="copy-btn" onclick="configureGmailAPI()" style="background: #28a745; font-size: 12px; padding: 6px 12px;">
                                ‚öôÔ∏è C·∫•u h√¨nh
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal ƒëƒÉng nh·∫≠p -->
    <div class="modal-overlay" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <span class="writing-icon">üîê</span>
                    ƒêƒÉng nh·∫≠p ƒë·ªÉ truy c·∫≠p Dashboard
                </div>
            </div>
            <div class="modal-body">
                <div class="login-form">
                    <div class="login-info">
                        <h3>üëã Ch√†o m·ª´ng ƒë·∫øn v·ªõi Dashboard HSK</h3>
                        <p>Vui l√≤ng ƒëƒÉng nh·∫≠p b·∫±ng Google ƒë·ªÉ truy c·∫≠p h·ªá th·ªëng qu·∫£n l√Ω b√†i test HSK.</p>
                    </div>
                    
                    <div class="google-login-container">
                        <div id="g_id_onload"
                             data-client_id="1034144698153-qnh5747mmfku65u52s3mp3narrssbq8n.apps.googleusercontent.com"
                             data-callback="handleCredentialResponse"
                             data-auto_prompt="false">
                        </div>
                        <div class="g_id_signin"
                             data-type="standard"
                             data-size="large"
                             data-theme="outline"
                             data-text="sign_in_with"
                             data-shape="rectangular"
                             data-logo_alignment="left">
                        </div>
                    </div>
                    
                    <div class="login-footer">
                        <p>üîí Th√¥ng tin c·ªßa b·∫°n ƒë∆∞·ª£c b·∫£o m·∫≠t v√† ch·ªâ s·ª≠ d·ª•ng ƒë·ªÉ x√°c th·ª±c truy c·∫≠p.</p>
                        <button class="btn" onclick="skipAuth()" style="margin-top: 15px; background: #6c757d;">
                            üöÄ B·ªè qua x√°c th·ª±c (Development)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://axllpuaybdzubfmsfkws.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF4bGxwdWF5YmR6dWJmbXNma3dzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk3NDMzODgsImV4cCI6MjA3NTMxOTM4OH0.KrjW79ZpnPxu_Lp9mETgKZU-kOLu3oMmWkABqOcDbco";

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

        let allData = [];
        let currentUser = null;

        // Google OAuth Configuration
        const GOOGLE_CLIENT_ID = "1034144698153-qnh5747mmfku65u52s3mp3narrssbq8n.apps.googleusercontent.com";
        const GOOGLE_CLIENT_SECRET = "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";
        
        // Get current domain for redirect URI
        const CURRENT_DOMAIN = window.location.origin;
        const REDIRECT_URI = `${CURRENT_DOMAIN}/oauth2callback`;
        
        // Gmail API Configuration
        const GMAIL_SCOPES = 'https://www.googleapis.com/auth/gmail.send';
        let gmailAccessToken = null;

        // Initialize Google OAuth
        function initializeGoogleAuth() {
            if (typeof google !== 'undefined' && google.accounts) {
                try {
                    google.accounts.id.initialize({
                        client_id: GOOGLE_CLIENT_ID,
                        callback: handleCredentialResponse,
                        auto_select: false,
                        cancel_on_tap_outside: true,
                        use_fedcm_for_prompt: false,
                        itp_support: true,
                        ux_mode: 'redirect',
                        redirect_uri: REDIRECT_URI
                    });
                    console.log('Google OAuth initialized successfully with redirect URI:', REDIRECT_URI);
                } catch (error) {
                    console.error('Error initializing Google OAuth:', error);
                    // Retry after delay
                    setTimeout(() => {
                        if (typeof google !== 'undefined' && google.accounts) {
                            try {
                                google.accounts.id.initialize({
                                    client_id: GOOGLE_CLIENT_ID,
                                    callback: handleCredentialResponse,
                                    auto_select: false,
                                    cancel_on_tap_outside: true,
                                    ux_mode: 'redirect',
                                    redirect_uri: REDIRECT_URI
                                });
                                console.log('Google OAuth retry successful');
                            } catch (retryError) {
                                console.error('Google OAuth retry failed:', retryError);
                                showOAuthError();
                            }
                        }
                    }, 2000);
                }
            } else {
                console.error('Google OAuth library not loaded, retrying...');
                setTimeout(initializeGoogleAuth, 1000);
            }
        }

        function showOAuthError() {
            const loginForm = document.querySelector('.login-form');
            if (loginForm) {
                loginForm.innerHTML = `
                    <div class="login-info">
                        <h3>‚ö†Ô∏è L·ªói c·∫•u h√¨nh OAuth</h3>
                        <p>Vui l√≤ng ki·ªÉm tra c·∫•u h√¨nh Google OAuth trong Google Cloud Console:</p>
                        <ul style="text-align: left; margin: 20px 0; padding-left: 20px;">
                            <li>Th√™m domain hi·ªán t·∫°i v√†o <strong>Authorized JavaScript origins</strong></li>
                            <li>Ki·ªÉm tra Client ID c√≥ ƒë√∫ng kh√¥ng</li>
                            <li>ƒê·∫£m b·∫£o OAuth consent screen ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh</li>
                        </ul>
                        <p><strong>Domain hi·ªán t·∫°i:</strong> ${window.location.origin}</p>
                        <button class="btn" onclick="location.reload()" style="margin-top: 15px;">
                            üîÑ Th·ª≠ l·∫°i
                        </button>
                    </div>
                `;
            }
        }

        // Handle Google OAuth response
        function handleCredentialResponse(response) {
            try {
                // Decode JWT token
                const responsePayload = decodeJwtResponse(response.credential);
                
                // Store user info with access token
                currentUser = {
                    name: responsePayload.name,
                    email: responsePayload.email,
                    picture: responsePayload.picture,
                    sub: responsePayload.sub,
                    accessToken: response.credential // Store credential for potential use
                };
                
                // Save to localStorage
                localStorage.setItem('user', JSON.stringify(currentUser));
                
                // Hide login modal and show content
                document.getElementById('loginModal').classList.remove('show');
                showAuthenticatedContent();
                
                // Load data
                loadAllData();
                
                console.log('ƒêƒÉng nh·∫≠p th√†nh c√¥ng:', currentUser);
                
            } catch (error) {
                console.error('L·ªói x·ª≠ l√Ω ƒëƒÉng nh·∫≠p:', error);
                alert('‚ùå C√≥ l·ªói x·∫£y ra khi ƒëƒÉng nh·∫≠p. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        // Decode JWT response
        function decodeJwtResponse(token) {
            const base64Url = token.split('.')[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(''));
            return JSON.parse(jsonPayload);
        }

        // Show authenticated content
        function showAuthenticatedContent() {
            // Show user info
            document.getElementById('userInfo').style.display = 'flex';
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userAvatar').src = currentUser.picture;
            
            // Show protected content
            const protectedElements = document.querySelectorAll('.content-protected');
            protectedElements.forEach(element => {
                element.classList.add('show');
            });
        }

        // Hide authenticated content
        function hideAuthenticatedContent() {
            // Hide user info
            document.getElementById('userInfo').style.display = 'none';
            
            // Hide protected content
            const protectedElements = document.querySelectorAll('.content-protected');
            protectedElements.forEach(element => {
                element.classList.remove('show');
            });
        }

        // Logout function
        function logout() {
            currentUser = null;
            localStorage.removeItem('user');
            
            // Hide authenticated content
            hideAuthenticatedContent();
            
            // Show login modal
            document.getElementById('loginModal').classList.add('show');
            
            console.log('ƒê√£ ƒëƒÉng xu·∫•t');
        }

        // Check if user is already logged in
        function checkAuthStatus() {
            const savedUser = localStorage.getItem('user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showAuthenticatedContent();
                    loadAllData();
                    return true;
                } catch (error) {
                    console.error('L·ªói ƒë·ªçc th√¥ng tin ng∆∞·ªùi d√πng:', error);
                    localStorage.removeItem('user');
                }
            }
            return false;
        }

        // Skip authentication for development
        function skipAuth() {
            currentUser = {
                name: 'Developer User',
                email: 'developer@example.com',
                picture: 'https://via.placeholder.com/40',
                sub: 'dev-user'
            };
            
            // Save to localStorage
            localStorage.setItem('user', JSON.stringify(currentUser));
            
            // Hide login modal and show content
            document.getElementById('loginModal').classList.remove('show');
            showAuthenticatedContent();
            
            // Load data
            loadAllData();
            
            console.log('Skipped authentication for development');
        }

        // Gmail API Functions - Using Google Identity Services
        function initializeGmailAPI() {
            if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                console.log('Google Identity Services loaded successfully');
                return true;
            } else {
                console.warn('Google Identity Services not loaded, retrying in 2 seconds...');
                setTimeout(initializeGmailAPI, 2000);
                return false;
            }
        }

        // Wait for Google Identity Services to load
        function waitForGoogleServices() {
            return new Promise((resolve) => {
                const checkServices = () => {
                    if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                        console.log('Google Identity Services ready');
                        resolve(true);
                    } else {
                        console.log('Waiting for Google Identity Services...');
                        setTimeout(checkServices, 500);
                    }
                };
                checkServices();
            });
        }

        async function requestGmailPermission() {
            try {
                // Wait for Google Identity Services to load
                await waitForGoogleServices();
                
                if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                    return new Promise((resolve, reject) => {
                        try {
                            const tokenClient = google.accounts.oauth2.initTokenClient({
                                client_id: GOOGLE_CLIENT_ID,
                                scope: GMAIL_SCOPES,
                                callback: (response) => {
                                    if (response.access_token) {
                                        gmailAccessToken = response.access_token;
                                        console.log('Gmail access token obtained successfully');
                                        resolve(gmailAccessToken);
                                    } else {
                                        reject(new Error('Kh√¥ng th·ªÉ l·∫•y access token t·ª´ Google Identity Services'));
                                    }
                                },
                                error_callback: (error) => {
                                    console.error('Token client error:', error);
                                    reject(new Error('L·ªói x√°c th·ª±c Gmail: ' + (error.type || error.message || 'Unknown error')));
                                }
                            });
                            
                            // Request access token
                            tokenClient.requestAccessToken();
                        } catch (error) {
                            console.error('Error initializing token client:', error);
                            reject(new Error('Kh√¥ng th·ªÉ kh·ªüi t·∫°o Google Identity Services: ' + error.message));
                        }
                    });
                } else {
                    throw new Error('Google Identity Services ch∆∞a ƒë∆∞·ª£c t·∫£i. Vui l√≤ng ƒë·ª£i v√† th·ª≠ l·∫°i.');
                }
            } catch (error) {
                console.error('Error waiting for Google Services:', error);
                throw new Error('Kh√¥ng th·ªÉ t·∫£i Google Identity Services: ' + error.message);
            }
        }

        function isValidEmail(email) {
            const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            const lastChar = email.slice(-1);
            if (lastChar === '.') {
                return false;
            }
            return emailPattern.test(email);
        }

        function getCurrentTimeGMT7() {
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const gmt7 = new Date(utc + (7 * 3600000));
            return gmt7.toISOString().replace('T', ' ').substring(0, 19);
        }

        // Safe base64 encoding for Unicode strings
        function safeBase64Encode(str) {
            try {
                // Method 1: Use TextEncoder (modern browsers)
                if (typeof TextEncoder !== 'undefined') {
                    const utf8Bytes = new TextEncoder().encode(str);
                    return btoa(String.fromCharCode(...utf8Bytes));
                }
                
                // Method 2: Use encodeURIComponent + btoa
                return btoa(unescape(encodeURIComponent(str)));
            } catch (error) {
                console.error('Base64 encoding error:', error);
                // Method 3: Fallback - encode line by line
                const lines = str.split('\n');
                const encodedLines = lines.map(line => {
                    try {
                        return btoa(unescape(encodeURIComponent(line)));
                    } catch (e) {
                        // Last resort: remove non-ASCII characters
                        return btoa(line.replace(/[^\x00-\x7F]/g, '?'));
                    }
                });
                return encodedLines.join('');
            }
        }

        function createEmailMessage(to, subject, body, fromName = 'ALOHA') {
            const boundary = 'boundary_' + Math.random().toString(36).substr(2, 9);
            
            // Encode subject properly for UTF-8
            const encodedSubject = `=?UTF-8?B?${btoa(unescape(encodeURIComponent(subject)))}?=`;
            
            // Encode from name properly
            const encodedFromName = `=?UTF-8?B?${btoa(unescape(encodeURIComponent(fromName)))}?=`;
            
            const raw = [
                `To: ${to}`,
                `From: ${encodedFromName} <${currentUser ? currentUser.email : 'noreply@example.com'}>`,
                `Subject: ${encodedSubject}`,
                'MIME-Version: 1.0',
                `Content-Type: multipart/alternative; boundary="${boundary}"`,
                '',
                `--${boundary}`,
                'Content-Type: text/plain; charset=UTF-8',
                'Content-Transfer-Encoding: 8bit',
                '',
                body.replace(/<[^>]*>/g, ''), // Strip HTML tags for plain text
                '',
                `--${boundary}`,
                'Content-Type: text/html; charset=UTF-8',
                'Content-Transfer-Encoding: 8bit',
                '',
                body,
                '',
                `--${boundary}--`
            ].join('\n');

            // Use safe base64 encoding for Unicode
            const base64 = safeBase64Encode(raw);
            return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        }

        async function sendEmailViaGmail(to, subject, body, fromName = 'ALOHA') {
            try {
                if (!isValidEmail(to)) {
                    throw new Error('Email kh√¥ng h·ª£p l·ªá: ' + to);
                }

                // Ki·ªÉm tra Google Identity Services ƒë√£ s·∫µn s√†ng
                if (typeof google === 'undefined' || !google.accounts || !google.accounts.oauth2) {
                    throw new Error('Google Identity Services ch∆∞a ƒë∆∞·ª£c t·∫£i. Vui l√≤ng th·ª≠ l·∫°i sau.');
                }

                // L·∫•y access token t·ª´ Google Sign-In
                if (!gmailAccessToken) {
                    await requestGmailPermission();
                }

                if (!gmailAccessToken) {
                    throw new Error('Kh√¥ng th·ªÉ l·∫•y quy·ªÅn truy c·∫≠p Gmail. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                }

                // T·∫°o email message v·ªõi error handling
                let message;
                try {
                    // S·ª≠ d·ª•ng t√™n t·ª´ input form (Trung t√¢m ti·∫øng Trung)
                    const senderName = fromName;
                    message = createEmailMessage(to, subject, body, senderName);
                    console.log('Email message created successfully');
                } catch (error) {
                    console.error('Error creating email message:', error);
                    throw new Error('Kh√¥ng th·ªÉ t·∫°o n·ªôi dung email: ' + error.message);
                }
                
                // G·ª≠i email qua Gmail API v·ªõi retry logic
                let retryCount = 0;
                const maxRetries = 3;
                
                while (retryCount < maxRetries) {
                    try {
                        const response = await fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages/send', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${gmailAccessToken}`,
                                'Content-Type': 'application/json',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: JSON.stringify({
                                raw: message
                            }),
                            mode: 'cors',
                            credentials: 'omit'
                        });

                        if (response.ok) {
                            const result = await response.json();
                            return {
                                success: true,
                                messageId: result.id,
                                time: getCurrentTimeGMT7(),
                                quota: 'Gmail API quota used'
                            };
                        } else {
                            const error = await response.json();
                            if (response.status === 401 && retryCount < maxRetries - 1) {
                                // Token expired, try to refresh
                                gmailAccessToken = null;
                                await requestGmailPermission();
                                retryCount++;
                                continue;
                            }
                            throw new Error(error.error?.message || `HTTP ${response.status}: G·ª≠i email th·∫•t b·∫°i`);
                        }
                    } catch (fetchError) {
                        if (fetchError.name === 'TypeError' && fetchError.message.includes('CORS')) {
                            throw new Error('L·ªói CORS: Vui l√≤ng ki·ªÉm tra c·∫•u h√¨nh domain trong Google Cloud Console');
                        }
                        if (retryCount < maxRetries - 1) {
                            retryCount++;
                            await new Promise(resolve => setTimeout(resolve, 1000 * retryCount));
                            continue;
                        }
                        throw fetchError;
                    }
                }
                
            } catch (error) {
                console.error('Error sending email:', error);
                return {
                    success: false,
                    error: error.message,
                    time: getCurrentTimeGMT7()
                };
            }
        }

        function applyFilter() {
            const filterValue = document.getElementById('filterAnswers').value;
            
            let filteredData = allData;
            
            if (filterValue === 'has_answers') {
                filteredData = allData.filter(item => 
                    item.test_results && item.test_results.length > 0 && item.test_results[0].answers
                );
            } else if (filterValue === 'no_answers') {
                filteredData = allData.filter(item => 
                    !item.test_results || item.test_results.length === 0 || !item.test_results[0].answers
                );
            }
            
            displayData(filteredData);
        }

        function sendEmail(email, fullname, score, level, phone, writingAiComment) {
            // M·ªü modal g·ª≠i email v·ªõi th√¥ng tin h·ªçc vi√™n
            openEmailModal(email, fullname, score, level, phone, writingAiComment);
        }

        function sendEmailFromRow(rowIndex) {
            // L·∫•y d·ªØ li·ªáu t·ª´ row ƒë√£ l∆∞u
            const rows = document.querySelectorAll('#dataTable tr');
            if (rowIndex < rows.length) {
                const row = rows[rowIndex];
                const cells = row.querySelectorAll('td');
                if (cells.length >= 6) {
                    const email = cells[4].textContent.trim();
                    const fullname = cells[1].textContent.trim();
                    const score = cells[5].querySelector('.score-badge').textContent.trim();
                    const level = cells[6].textContent.trim();
                    const phone = cells[3].textContent.trim();
                    
                    // L·∫•y d·ªØ li·ªáu t·ª´ data attributes
                    const writingAiComment = row.dataset.writingAiComment || '';
                    let allAnswers = null;
                    let essay = row.dataset.essay || '';
                    
                    try {
                        allAnswers = row.dataset.allAnswers && row.dataset.allAnswers !== '{}' ? JSON.parse(row.dataset.allAnswers) : null;
                    } catch (e) {
                        console.error('Error parsing allAnswers:', e);
                        allAnswers = null;
                    }
                    
                    
                    openEmailModal(email, fullname, score, level, phone, writingAiComment, allAnswers, essay);
                }
            }
        }

        function openEmailModal(email, fullname, score, level, phone, writingAiComment, allAnswers, essay) {
            const modal = document.getElementById('emailModal');
            modal.classList.add('show');
            
            // ƒêi·ªÅn th√¥ng tin m·∫∑c ƒë·ªãnh
            document.getElementById('emailTo').value = email || '';
            document.getElementById('emailFrom').value = 'ALOHA';
            document.getElementById('emailSubject').value = `[Quan tr·ªçng] ALOHA tr·∫£ k·∫øt qu·∫£ b√†i test HSK - ${level}`;
            
            // Hi·ªÉn th·ªã th√¥ng tin h·ªçc vi√™n
            document.getElementById('emailStudentName').textContent = fullname || 'N/A';
            document.getElementById('emailStudentEmail').textContent = email || 'N/A';
            document.getElementById('emailStudentPhone').textContent = phone || 'N/A';
            
            // Hi·ªÉn th·ªã k·∫øt qu·∫£ test
            displayEmailTestResult(score, level);
            
            // L∆∞u th√¥ng tin h·ªçc vi√™n ƒë·ªÉ t·∫°o template
            window.currentStudentData = {
                email: email,
                fullname: fullname,
                score: score,
                level: level,
                phone: phone,
                writingAiComment: writingAiComment,
                allAnswers: allAnswers,
                essay: essay
            };
            
            // C·∫≠p nh·∫≠t preview
            updateEmailPreview();
        }

        function displayEmailTestResult(score, level) {
            if (!score || score === 'N/A' || score === null || score === undefined) {
                document.getElementById('emailTestResultSection').style.display = 'none';
                return;
            }
            
            const numericScore = parseInt(score);
            if (isNaN(numericScore)) {
                document.getElementById('emailTestResultSection').style.display = 'none';
                return;
            }
            
            document.getElementById('emailTotalScore').textContent = numericScore;
            
            // C·∫≠p nh·∫≠t ƒëi·ªÉm t·ªëi ƒëa d·ª±a tr√™n level
            const levelStr = (level || '1').toString().trim();
            const isHSK2 = levelStr === '2' || levelStr.toUpperCase() === 'HSK2' || levelStr.toUpperCase() === 'HSK 2';
            const maxScore = isHSK2 ? 200 : 30;
            document.getElementById('emailMaxScore').textContent = maxScore;
            
            let status, statusClass, comment, learningPath;
            
            // Ki·ªÉm tra level ƒë·ªÉ √°p d·ª•ng ti√™u ch√≠ ƒë√°nh gi√° kh√°c nhau
            if (isHSK2) {
                // Logic ƒë√°nh gi√° HSK2 (ƒëi·ªÉm t·ªëi ƒëa 200)
                if (numericScore >= 150) {
                    status = "ƒê·∫°t";
                    statusClass = "email-status-excellent";
                    comment = "Hi·ªÉu v√† s·ª≠ d·ª•ng ƒë∆∞·ª£c c√°c m·∫´u c√¢u giao ti·∫øp c∆° b·∫£n, n·∫Øm v·ªØng kho·∫£ng 300 t·ª´ v·ª±ng HSK2, c√≥ th·ªÉ nghe ‚Äì n√≥i ‚Äì ƒë·ªçc ·ªü m·ª©c ƒë∆°n gi·∫£n.";
                    learningPath = "HSK3";
                } else {
                    status = "Kh√¥ng ƒë·∫°t";
                    statusClass = "email-status-fail";
                    comment = "Ch∆∞a v·ªØng t·ª´ v·ª±ng v√† c·∫•u tr√∫c ng·ªØ ph√°p; c·∫ßn √¥n luy·ªán th√™m k·ªπ nƒÉng nghe, ƒë·ªçc v√† ph·∫£n x·∫° giao ti·∫øp.";
                    learningPath = "H·ªçc l·∫°i HSK1-2";
                }
            } else {
                // Ti√™u ch√≠ cho HSK1 (ƒëi·ªÉm t·ªëi ƒëa 30)
                if (numericScore >= 24) {
                    status = "ƒê·∫°t";
                    statusClass = "email-status-excellent";
                    comment = "Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh b√†i test! ƒêi·ªÉm s·ªë c·ªßa b·∫°n ·ªü m·ª©c cao c·ªßa HSK1";
                    learningPath = "HSK2 tr·ªü l√™n";
                } else {
                    status = "Ch∆∞a ƒë·∫°t";
                    statusClass = "email-status-fail";
                    comment = "B·∫°n ch∆∞a ƒë·∫°t m·ª©c c∆° b·∫£n, c·∫ßn b·∫Øt ƒë·∫ßu t·ª´ H√°n ng·ªØ s∆° c·∫•p 1 ƒë·ªÉ l√†m quen v·ªõi ph√°t √¢m v√† t·ª´ v·ª±ng n·ªÅn";
                    learningPath = "HSK1 tr·ªü l√™n";
                }
            }
            
            const statusBadge = document.getElementById('emailStatusBadge');
            statusBadge.textContent = status;
            statusBadge.className = `email-status-badge ${statusClass}`;
            
            document.getElementById('emailCommentText').textContent = comment;
            document.getElementById('emailLearningPathText').textContent = learningPath;
            
            document.getElementById('emailTestResultSection').style.display = 'block';
        }

        function closeEmailModal() {
            document.getElementById('emailModal').classList.remove('show');
        }

        function updateEmailPreview() {
            // Kh√¥ng c·∫ßn preview n·ªØa
            return;
        }

        function generateEmailTemplate(studentData, senderName) {
            const { fullname, score, level, phone, writingAiComment, allAnswers, essay } = studentData;
            
            // X√°c ƒë·ªãnh tr·∫°ng th√°i v√† nh·∫≠n x√©t d·ª±a tr√™n ƒëi·ªÉm v√† level
            let status, statusText, comment, learningPath;
            
            // Ki·ªÉm tra level ƒë·ªÉ √°p d·ª•ng ti√™u ch√≠ ƒë√°nh gi√° kh√°c nhau
            const levelStr = (level || '1').toString().trim();
            const isHSK2 = levelStr === '2' || levelStr.toUpperCase() === 'HSK2' || levelStr.toUpperCase() === 'HSK 2';
            
            if (isHSK2) {
                // Logic ƒë√°nh gi√° HSK2 (ƒëi·ªÉm t·ªëi ƒëa 200)
                if (score !== 'N/A' && score >= 150) {
                    status = "ƒê·∫°t";
                    statusText = "Ch√∫c m·ª´ng!";
                    comment = "Hi·ªÉu v√† s·ª≠ d·ª•ng ƒë∆∞·ª£c c√°c m·∫´u c√¢u giao ti·∫øp c∆° b·∫£n, n·∫Øm v·ªØng kho·∫£ng 300 t·ª´ v·ª±ng HSK2, c√≥ th·ªÉ nghe ‚Äì n√≥i ‚Äì ƒë·ªçc ·ªü m·ª©c ƒë∆°n gi·∫£n.";
                    learningPath = "HSK3";
                } else if (score !== 'N/A') {
                    status = "Kh√¥ng ƒë·∫°t";
                    statusText = "C·∫ßn h·ªçc th√™m";
                    comment = "Ch∆∞a v·ªØng t·ª´ v·ª±ng v√† c·∫•u tr√∫c ng·ªØ ph√°p; c·∫ßn √¥n luy·ªán th√™m k·ªπ nƒÉng nghe, ƒë·ªçc v√† ph·∫£n x·∫° giao ti·∫øp.";
                    learningPath = "H·ªçc l·∫°i HSK1-2";
                } else {
                    status = "Ch∆∞a ho√†n th√†nh";
                    statusText = "Ch∆∞a c√≥ k·∫øt qu·∫£";
                    comment = "B·∫°n ch∆∞a ho√†n th√†nh b√†i test. Vui l√≤ng li√™n h·ªá ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£.";
                    learningPath = "Li√™n h·ªá t∆∞ v·∫•n";
                }
            } else {
                // Ti√™u ch√≠ cho HSK1 (ƒëi·ªÉm t·ªëi ƒëa 30)
                if (score !== 'N/A' && score >= 24) {
                    status = "ƒê·∫°t";
                    statusText = "Ch√∫c m·ª´ng!";
                    comment = "B·∫°n ƒë√£ ho√†n th√†nh b√†i test v·ªõi k·∫øt qu·∫£ xu·∫•t s·∫Øc! ƒêi·ªÉm s·ªë c·ªßa b·∫°n ·ªü m·ª©c cao c·ªßa HSK1.";
                    learningPath = "HSK2 tr·ªü l√™n";
                } else if (score !== 'N/A') {
                    status = "Ch∆∞a ƒë·∫°t";
                    statusText = "C·∫ßn h·ªçc th√™m";
                    comment = "B·∫°n ch∆∞a ƒë·∫°t m·ª©c c∆° b·∫£n, c·∫ßn b·∫Øt ƒë·∫ßu t·ª´ H√°n ng·ªØ s∆° c·∫•p 1 ƒë·ªÉ l√†m quen v·ªõi ph√°t √¢m v√† t·ª´ v·ª±ng n·ªÅn.";
                    learningPath = "HSK1 tr·ªü l√™n";
                } else {
                    status = "Ch∆∞a ho√†n th√†nh";
                    statusText = "Ch∆∞a c√≥ k·∫øt qu·∫£";
                    comment = "B·∫°n ch∆∞a ho√†n th√†nh b√†i test. Vui l√≤ng li√™n h·ªá ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£.";
                    learningPath = "Li√™n h·ªá t∆∞ v·∫•n";
                }
            }
            
            // T·∫°o ph·∫ßn Nghe v√† ƒêi·ªÅn ƒë√°p √°n
            let listeningSection = '';
            let readingSection = '';
            let essaySection = '';
            
            if (allAnswers) {
                let listeningCorrect = 0;
                let readingCorrect = 0;
                let listeningAnswers = '';
                let readingAnswers = '';
                
                if (isHSK2) {
                    // ƒê√°p √°n ƒë√∫ng cho HSK2 (60 c√¢u)
                    const correctAnswersHSK2 = {
                        // Ph·∫ßn Nghe hi·ªÉu - 35 c√¢u (Q1-Q35, index 0-34)
                        '0': 'false', '1': 'true', '2': 'true', '3': 'false', '4': 'false',
                        '5': 'false', '6': 'false', '7': 'true', '8': 'true', '9': 'true',
                        '10': 'A', '11': 'B', '12': 'C', '13': 'F', '14': 'E',
                        '15': 'D', '16': 'G', '17': 'H', '18': 'I', '19': 'J',
                        '20': 'C', '21': 'A', '22': 'B', '23': 'C', '24': 'B',
                        '25': 'A', '26': 'C', '27': 'C', '28': 'A', '29': 'B',
                        '30': 'B', '31': 'A', '32': 'B', '33': 'A', '34': 'C',
                        
                        // Ph·∫ßn ƒê·ªçc hi·ªÉu - 25 c√¢u (Q36-Q60, index 35-59)
                        '35': 'E', '36': 'B', '37': 'C', '38': 'F', '39': 'A',
                        '40': 'B', '41': 'F', '42': 'D', '43': 'A', '44': 'C',
                        '45': 'false', '46': 'true', '47': 'false', '48': 'false', '49': 'true',
                        '50': 'D', '51': 'C', '52': 'A', '53': 'F', '54': 'B',
                        '55': 'E', '56': 'A', '57': 'C', '58': 'D', '59': 'B'
                    };
                    
                    // Ph·∫ßn Nghe (Q1-Q35, index 0-34) - 6 c√¢u/d√≤ng
                    for (let i = 0; i < 35; i++) {
                        const key = String(i);
                        const userAnswer = allAnswers[key] || 'N/A';
                        const correctAnswer = correctAnswersHSK2[key];
                        const isCorrect = userAnswer === correctAnswer;
                        
                        if (isCorrect) listeningCorrect++;
                        
                        // Th√™m <br> sau m·ªói 6 c√¢u
                        if (i > 0 && i % 6 === 0) {
                            listeningAnswers += '<br>';
                        }
                        
                        listeningAnswers += `
                            <span class="answer-badge-inline ${isCorrect ? 'answer-correct' : 'answer-incorrect'}">
                                ${i + 1}:${userAnswer}${isCorrect ? '‚úì' : '‚úó'}
                            </span>
                        `;
                    }
                    
                    // Ph·∫ßn ƒê·ªçc (Q36-Q60, index 35-59) - 6 c√¢u/d√≤ng
                    for (let i = 35; i < 60; i++) {
                        const key = String(i);
                        const userAnswer = allAnswers[key] || 'N/A';
                        const correctAnswer = correctAnswersHSK2[key];
                        const isCorrect = userAnswer === correctAnswer;
                        
                        if (isCorrect) readingCorrect++;
                        
                        // Th√™m <br> sau m·ªói 6 c√¢u (t·ª´ c√¢u 36)
                        if (i > 35 && (i - 35) % 6 === 0) {
                            readingAnswers += '<br>';
                        }
                        
                        readingAnswers += `
                            <span class="answer-badge-inline ${isCorrect ? 'answer-correct' : 'answer-incorrect'}">
                                ${i + 1}:${userAnswer}${isCorrect ? '‚úì' : '‚úó'}
                            </span>
                        `;
                    }
                } else {
                    // ƒê√°p √°n ƒë√∫ng cho HSK1
                    const correctAnswers = {
                        '0': 'B',   // Q1
                        '1': 'A',   // Q2
                        '2': 'A',   // Q3
                        '3': 'A',   // Q4
                        '4': 'B',   // Q5
                        '5': 'Â•πÂè´ËãèËãè',   // Q6
                        '6': 'Â•πÂñúÊ¨¢Ê±âËØ≠',   // Q7
                        '7': '‰∏ç',   // Q8
                        '8': 'Ê≤°Êúâ',   // Q9
                        '9': 'Â•πÁé∞Âú®Âú®‰∏≠ÂõΩ'    // Q10
                    };
                    
                    // Ph·∫ßn Nghe (Q1-Q5, index 0-4)
                    for (let i = 0; i < 5; i++) {
                        const key = String(i);
                        const userAnswer = allAnswers[key] || 'N/A';
                        const correctAnswer = correctAnswers[key];
                        const isCorrect = userAnswer === correctAnswer;
                        
                        if (isCorrect) listeningCorrect++;
                        
                        listeningAnswers += `
                            <div class="answer-badge ${isCorrect ? 'answer-correct' : 'answer-incorrect'}">
                                ${i + 1}: ${userAnswer} <span class="answer-icon">${isCorrect ? '‚úì' : '‚úó'}</span>
                            </div>
                        `;
                    }
                    
                    // Ph·∫ßn ƒêi·ªÅn ƒê√°p √Ån (Q6-Q10, index 5-9)
                    for (let i = 5; i < 10; i++) {
                        const key = String(i);
                        const userAnswer = allAnswers[key] || 'N/A';
                        const correctAnswer = correctAnswers[key];
                        const isCorrect = userAnswer === correctAnswer;
                        
                        if (isCorrect) readingCorrect++;
                        
                        readingAnswers += `
                            <div class="answer-badge ${isCorrect ? 'answer-correct' : 'answer-incorrect'}">
                                ${i + 1}: ${userAnswer} <span class="answer-icon">${isCorrect ? '‚úì' : '‚úó'}</span>
                            </div>
                        `;
                    }
                }
                
                const listeningTotal = isHSK2 ? 35 : 5;
                const readingTotal = isHSK2 ? 25 : 5;
                const listeningLabel = isHSK2 ? 'Nghe hi·ªÉu' : 'Ph·∫ßn Nghe';
                const readingLabel = isHSK2 ? 'ƒê·ªçc hi·ªÉu' : 'Ph·∫ßn ƒêi·ªÅn ƒê√°p √Ån';
                
                listeningSection = `
                    <div class="answers-section listening">
                        <div class="section-title">
                            ${listeningLabel}: <span>${listeningCorrect}</span>/${listeningTotal} ƒë√∫ng
                        </div>
                        <div class="${isHSK2 ? 'answers-inline' : 'answers-grid'}">
                            ${listeningAnswers}
                        </div>
                    </div>
                `;
                
                readingSection = `
                    <div class="answers-section reading">
                        <div class="section-title">
                            ${readingLabel}: <span>${readingCorrect}</span>/${readingTotal} ƒë√∫ng
                        </div>
                        <div class="${isHSK2 ? 'answers-inline' : 'answers-grid'}">
                            ${readingAnswers}
                        </div>
                    </div>
                `;
            }
            
            // Ph·∫ßn b√†i vi·∫øt (ch·ªâ cho HSK1, HSK2 kh√¥ng c√≥)
            if (!isHSK2 && essay && essay.trim().length > 0) {
                essaySection = `
                    <div class="essay-display">
                        <h4>B√†i vi·∫øt c·ªßa h·ªçc vi√™n:</h4>
                        <div class="essay-text">${essay}</div>
                    </div>
                `;
            }
            
            return `<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K·∫øt qu·∫£ b√†i test HSK</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
            min-height: 100vh;
            width: 100%;
            box-sizing: border-box;
        }
        @media (max-width: 768px) {
            body {
                max-width: 100%;
                padding: 15px;
            }
        }
        * {
            box-sizing: border-box;
        }
        .header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 800;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .student-info {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #fbbf24;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .student-info h3 {
            color: #1e7e5f;
            margin-bottom: 12px;
            font-size: 18px;
        }
        .student-info p {
            color: #555;
            margin: 8px 0;
            font-size: 14px;
        }
        .student-info strong {
            color: #333;
            font-weight: 600;
        }
        .test-result-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #11998e;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .test-result-section h3 {
            color: #11998e;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .score-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .score-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #2c3e50;
            display: inline-block;
            margin-left: 10px;
        }
        .result-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        @media (max-width: 768px) {
            .result-details {
                flex-direction: column;
                gap: 15px;
            }
        }
        .result-item {
            text-align: center;
            padding: 15px;
            border-right: 1px solid #dee2e6;
            flex: 1;
            min-width: 200px;
        }
        .result-item:last-child {
            border-right: none;
        }
        .result-item h4 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 16px;
            font-weight: 700;
        }
        .status-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            text-transform: uppercase;
            display: inline-block;
        }
        .status-excellent {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 2px solid #34d399;
        }
        .status-fail {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 2px solid #f87171;
        }
        .comment-text, .path-text {
            font-size: 1em;
            line-height: 1.5;
            color: #495057;
            margin: 0;
            font-weight: 500;
        }
        .path-text {
            color: #11998e;
            font-weight: bold;
        }
        .answers-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
            border-left: 4px solid #11998e;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .answers-section.listening {
            border-left: 4px solid #11998e;
        }
        
        .answers-section.reading {
            border-left: 4px solid #11998e;
        }
        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #1e7e5f;
            margin-bottom: 15px;
        }
        .answers-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: flex-start;
        }
        .answers-inline {
            line-height: 2.2;
            font-size: 13px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        @media (max-width: 768px) {
            .answers-inline {
                font-size: 12px;
                line-height: 2.0;
            }
        }
        .answer-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 12px;
            transition: transform 0.2s;
            position: relative;
            cursor: pointer;
            white-space: nowrap;
            min-width: 60px;
        }
        .answer-badge-inline {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 12px;
            margin: 2px;
            white-space: nowrap;
        }
        .answer-correct {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #34d399;
        }
        .answer-incorrect {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #f87171;
        }
        .answer-icon {
            margin-left: 6px;
            font-size: 16px;
        }
        .essay-display {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            backdrop-filter: blur(10px);
        }
        .essay-display h4 {
            color: #1e7e5f;
            margin-bottom: 12px;
            font-size: 16px;
        }
        .essay-text {
            color: #333;
            line-height: 1.8;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .writing-section {
            background: rgba(255, 255, 255, 0.95);
            border: 2.5px solid #fbbf24;
            border-radius: 15px;
            padding: 22px 26px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        .writing-title {
            font-weight: 800;
            color: #92400e;
            margin-bottom: 14px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            z-index: 1;
        }
        .writing-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            box-shadow: 0 3px 10px rgba(251, 191, 36, 0.4);
        }
        .writing-content {
            color: #78350f;
            line-height: 1.7;
            font-size: 15px;
            position: relative;
            z-index: 1;
        }
        .writing-content p {
            background: rgba(255, 255, 255, 0.5);
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 3px solid #fbbf24;
        }
        .writing-content p:last-child {
            margin-bottom: 0;
        }
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            color: #666;
            font-size: 14px;
        }
        @media (max-width: 768px) {
            .result-item {
                padding: 12px 8px;
                min-height: 70px;
            }
            .result-item h4 {
                font-size: 13px;
                margin-bottom: 6px;
            }
            .result-item p {
                font-size: 12px;
            }
        }

        @media (max-width: 600px) {
            body {
                max-width: 100%;
                padding: 10px;
            }
            .result-details {
                flex-direction: column;
            }
            .result-item {
                border-right: none;
                border-bottom: 1px solid #e9ecef;
                min-height: 50px;
                padding: 10px 8px;
            }
            .result-item:last-child {
                border-bottom: none;
            }
            .result-item h4 {
                font-size: 11px;
                margin-bottom: 4px;
            }
            .result-item p {
                font-size: 10px;
            }
            .answers-grid {
                gap: 6px;
            }
            .answer-badge {
                padding: 6px 10px;
                font-size: 11px;
                min-width: 50px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Th√¥ng tin b√†i test</h1>
    </div>
    
    <div class="student-info">
        <h3>Th√¥ng tin h·ªçc vi√™n</h3>
        <p><strong>H·ªç t√™n:</strong> ${fullname}</p>
        <p><strong>Email:</strong> ${studentData.email || 'N/A'}</p>
        <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${phone || 'N/A'}</p>
    </div>
    
    <div class="test-result-section">
        <h3>K·∫øt qu·∫£ b√†i test ${isHSK2 ? 'HSK2' : 'HSK1'}</h3>
        <div class="score-info">
            <h4>ƒêi·ªÉm s·ªë: <span class="score-value">${score !== 'N/A' ? score : 'N/A'}</span>/${isHSK2 ? '200' : '30'}</h4>
        </div>
        
        <div class="result-details">
            <div class="result-item">
                <h4>Tr·∫°ng th√°i</h4>
                <span class="status-badge ${score !== 'N/A' && ((isHSK2 && score >= 150) || (!isHSK2 && score >= 24)) ? 'status-excellent' : 'status-fail'}">${status}</span>
            </div>
            
            <div class="result-item">
                <h4>Nh·∫≠n x√©t</h4>
                <p class="comment-text">${comment}</p>
            </div>
            
            <div class="result-item">
                <h4>L·ªô tr√¨nh h·ªçc g·ª£i √Ω</h4>
                <p class="path-text">${learningPath}</p>
            </div>
        </div>
    </div>
    
    ${listeningSection}
    
    ${readingSection}
    
    ${essaySection}
    
    ${!isHSK2 ? `
    <div class="writing-section">
        <div class="writing-title">
            Nh·∫≠n x√©t b√†i vi·∫øt
        </div>
        <div class="writing-content">
            ${writingAiComment ? writingAiComment.replace(/\n/g, '<br>') : '<p>Ch∆∞a c√≥ nh·∫≠n x√©t b√†i vi·∫øt.</p>'}
        </div>
    </div>` : ''}
    
</body>
</html>`;
        }

        async function sendEmailWithTemplate() {
            const emailTo = document.getElementById('emailTo').value;
            const emailFrom = document.getElementById('emailFrom').value;
            const emailSubject = document.getElementById('emailSubject').value;
            
            if (!emailTo) {
                alert('‚ùå Vui l√≤ng nh·∫≠p email ng∆∞·ªùi nh·∫≠n!');
                return;
            }
            
            const studentData = window.currentStudentData;
            if (!studentData) {
                alert('‚ùå Kh√¥ng t√¨m th·∫•y th√¥ng tin h·ªçc vi√™n!');
                return;
            }
            
            // T·∫°o n·ªôi dung email
            const emailBody = generateEmailTemplate(studentData, emailFrom);
            
            // Hi·ªÉn th·ªã loading
            const sendBtn = document.querySelector('.email-actions .btn');
            const originalText = sendBtn.textContent;
            sendBtn.textContent = '‚è≥ ƒêang g·ª≠i...';
            sendBtn.disabled = true;
            
            try {
                // S·ª≠ d·ª•ng t√™n t·ª´ input form (Trung t√¢m ti·∫øng Trung)
                const senderName = emailFrom;
                
                // G·ª≠i email qua Gmail API
                const result = await sendEmailViaGmail(emailTo, emailSubject, emailBody, senderName);
                
                if (result.success) {
                    alert(`‚úÖ G·ª≠i email th√†nh c√¥ng!\n\nüìß G·ª≠i ƒë·∫øn: ${emailTo}\nüìù Ti√™u ƒë·ªÅ: ${emailSubject}\nüïí Th·ªùi gian: ${result.time}\n\nEmail ƒë√£ ƒë∆∞·ª£c g·ª≠i tr·ª±c ti·∫øp qua Gmail API.`);
                    
                    // ƒê√≥ng modal
                    closeEmailModal();
                } else {
                    // N·∫øu l·ªói server_error, th·ª≠ ph∆∞∆°ng ph√°p thay th·∫ø
                    if (result.error && result.error.includes('server_error')) {
                        const fallbackResult = await sendEmailFallback(emailTo, emailSubject, emailBody, emailFrom);
                        if (fallbackResult.success) {
                            alert(`‚úÖ G·ª≠i email th√†nh c√¥ng (ph∆∞∆°ng ph√°p thay th·∫ø)!\n\nüìß G·ª≠i ƒë·∫øn: ${emailTo}\nüìù Ti√™u ƒë·ªÅ: ${emailSubject}\nüïí Th·ªùi gian: ${fallbackResult.time}`);
                            closeEmailModal();
                        } else {
                            alert(`‚ùå G·ª≠i email th·∫•t b·∫°i!\n\nL·ªói: ${result.error}\n\nVui l√≤ng s·ª≠ d·ª•ng ch·ª©c nƒÉng "Copy n·ªôi dung" ƒë·ªÉ g·ª≠i th·ªß c√¥ng.`);
                        }
                    } else {
                        alert(`‚ùå G·ª≠i email th·∫•t b·∫°i!\n\nL·ªói: ${result.error}\n\nVui l√≤ng th·ª≠ l·∫°i ho·∫∑c s·ª≠ d·ª•ng ch·ª©c nƒÉng copy ƒë·ªÉ g·ª≠i th·ªß c√¥ng.`);
                    }
                }
            } catch (error) {
                console.error('Error sending email:', error);
                alert(`‚ùå C√≥ l·ªói x·∫£y ra khi g·ª≠i email!\n\nL·ªói: ${error.message}\n\nVui l√≤ng th·ª≠ l·∫°i ho·∫∑c s·ª≠ d·ª•ng ch·ª©c nƒÉng copy ƒë·ªÉ g·ª≠i th·ªß c√¥ng.`);
            } finally {
                // Kh√¥i ph·ª•c button
                sendBtn.textContent = originalText;
                sendBtn.disabled = false;
            }
        }

        // Ph∆∞∆°ng ph√°p thay th·∫ø khi Gmail API b·ªã l·ªói
        async function sendEmailFallback(to, subject, body, fromName = 'ALOHA') {
            try {
                // T·∫°o mailto link v·ªõi n·ªôi dung email
                const mailtoBody = body.replace(/\n/g, '%0A').replace(/ /g, '%20');
                const mailtoLink = `mailto:${to}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                
                // M·ªü email client
                window.open(mailtoLink);
                
                return {
                    success: true,
                    method: 'mailto',
                    time: getCurrentTimeGMT7(),
                    message: 'ƒê√£ m·ªü ·ª©ng d·ª•ng email v·ªõi n·ªôi dung ƒë√£ ƒëi·ªÅn s·∫µn'
                };
            } catch (error) {
                return {
                    success: false,
                    error: error.message,
                    time: getCurrentTimeGMT7()
                };
            }
        }

        function copyEmailTemplate() {
            const studentData = window.currentStudentData;
            if (!studentData) {
                alert('‚ùå Kh√¥ng t√¨m th·∫•y th√¥ng tin h·ªçc vi√™n!');
                return;
            }
            
            const emailFrom = document.getElementById('emailFrom').value;
            const emailTemplate = generateEmailTemplate(studentData, emailFrom);
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(emailTemplate).then(() => {
                    alert('‚úÖ ƒê√£ copy n·ªôi dung email v√†o clipboard!');
                }).catch(() => {
                    // Fallback
                    const textArea = document.createElement('textarea');
                    textArea.value = emailTemplate;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('‚úÖ ƒê√£ copy n·ªôi dung email v√†o clipboard!');
                });
            } else {
                // Fallback cho tr√¨nh duy·ªát c≈©
                const textArea = document.createElement('textarea');
                textArea.value = emailTemplate;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('‚úÖ ƒê√£ copy n·ªôi dung email v√†o clipboard!');
            }
        }

        // H√†m toggle debug tools
        function toggleDebugTools() {
            const debugTools = document.getElementById('debugTools');
            if (debugTools.classList.contains('collapsed')) {
                debugTools.classList.remove('collapsed');
            } else {
                debugTools.classList.add('collapsed');
            }
        }

        // Test redirect URI
        function testRedirectURI() {
            const currentDomain = window.location.origin;
            const testURIs = [
                REDIRECT_URI,
                currentDomain,
                `${currentDomain}/`,
                `${currentDomain}/index.html`
            ];
            
            let testText = 'üß™ TEST REDIRECT URI:\n\n';
            testText += `Domain hi·ªán t·∫°i: ${currentDomain}\n`;
            testText += `Redirect URI ch√≠nh: ${REDIRECT_URI}\n\n`;
            testText += 'C√°c redirect URI c·∫ßn th√™m v√†o Google Cloud Console:\n';
            testURIs.forEach((uri, index) => {
                testText += `${index + 1}. ${uri}\n`;
            });
            
            testText += '\nüìã H∆Ø·ªöNG D·∫™N:\n';
            testText += '1. Copy c√°c URI tr√™n\n';
            testText += '2. V√†o Google Cloud Console\n';
            testText += '3. APIs & Services ‚Üí Credentials\n';
            testText += '4. Ch·ªânh s·ª≠a OAuth 2.0 Client ID\n';
            testText += '5. Th√™m t·∫•t c·∫£ URI tr√™n v√†o "Authorized redirect URIs"\n';
            testText += '6. L∆∞u v√† th·ª≠ l·∫°i';
            
            alert(testText);
        }

        // H√†m ki·ªÉm tra v√† fix redirect URI
        function checkRedirectURI() {
            const currentDomain = window.location.origin;
            const currentPath = window.location.pathname;
            const fullURL = window.location.href;
            
            const redirectInfo = {
                'Current domain': currentDomain,
                'Current path': currentPath,
                'Full URL': fullURL,
                'Expected redirect URI': REDIRECT_URI,
                'Alternative redirect URI': currentDomain
            };
            
            console.log('üîç Redirect URI Debug Info:', redirectInfo);
            
            let debugText = 'üîç REDIRECT URI DEBUG:\n\n';
            for (const [key, value] of Object.entries(redirectInfo)) {
                debugText += `${key}: ${value}\n`;
            }
            
            debugText += '\nüìã FIX L·ªñI 400 BAD REQUEST:\n';
            debugText += '1. V√†o Google Cloud Console ‚Üí APIs & Services ‚Üí Credentials\n';
            debugText += '2. Ch·ªânh s·ª≠a OAuth 2.0 Client ID\n';
            debugText += '3. Th√™m c√°c redirect URIs sau:\n';
            debugText += `   - ${REDIRECT_URI} (CH√çNH)\n`;
            debugText += `   - ${currentDomain}\n`;
            debugText += `   - ${currentDomain}/\n`;
            debugText += `   - ${currentDomain}/index.html\n`;
            debugText += '4. L∆∞u v√† th·ª≠ l·∫°i\n\n';
            debugText += '‚ö†Ô∏è L∆ØU √ù: Redirect URI ch√≠nh l√† /oauth2callback\n';
            debugText += 'ƒê·∫£m b·∫£o ch√≠nh x√°c 100%';
            
            alert(debugText);
        }

        // Debug function ƒë·ªÉ ki·ªÉm tra tr·∫°ng th√°i Google APIs
        function debugGoogleAPIs() {
            const debugInfo = {
                'Google Identity Services': typeof google !== 'undefined' && typeof google.accounts !== 'undefined',
                'Google OAuth2': typeof google !== 'undefined' && typeof google.accounts !== 'undefined' && typeof google.accounts.oauth2 !== 'undefined',
                'Current domain': window.location.origin,
                'Redirect URI': REDIRECT_URI,
                'Gmail access token': gmailAccessToken ? 'C√≥' : 'Kh√¥ng',
                'User logged in': currentUser ? 'C√≥' : 'Kh√¥ng'
            };
            
            console.log('üîç Google APIs Debug Info:', debugInfo);
            
            let debugText = 'üîç GOOGLE APIs DEBUG INFO:\n\n';
            for (const [key, value] of Object.entries(debugInfo)) {
                debugText += `${key}: ${value}\n`;
            }
            
            debugText += '\nüìã H∆Ø·ªöNG D·∫™N FIX:\n';
            debugText += '1. N·∫øu Google Identity Services = false: Refresh trang\n';
            debugText += '2. N·∫øu Google OAuth2 = false: Ki·ªÉm tra CSP headers\n';
            debugText += '3. N·∫øu Gmail access token = Kh√¥ng: Click "Th·ª≠ l·∫°i Gmail"\n';
            debugText += '4. N·∫øu User logged in = Kh√¥ng: ƒêƒÉng nh·∫≠p l·∫°i\n';
            debugText += '5. N·∫øu v·∫´n l·ªói: Click "üß™ Test URI" ƒë·ªÉ ki·ªÉm tra redirect URI\n';
            
            alert(debugText);
        }

        // Test Unicode encoding
        function testUnicodeEncoding() {
            const testText = 'Xin ch√†o! ƒê√¢y l√† test ti·∫øng Vi·ªát v·ªõi k√Ω t·ª± ƒë·∫∑c bi·ªát: √†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒë';
            
            try {
                const encoded = safeBase64Encode(testText);
                const decoded = atob(encoded);
                
                alert(`üß™ TEST UNICODE ENCODING:

Test text: ${testText}
Encoded: ${encoded}
Decoded: ${decoded}

‚úÖ Unicode encoding ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng!`);
            } catch (error) {
                alert(`‚ùå UNICODE ENCODING ERROR:

L·ªói: ${error.message}

Vui l√≤ng s·ª≠ d·ª•ng ch·ª©c nƒÉng "Copy n·ªôi dung" ƒë·ªÉ g·ª≠i th·ªß c√¥ng.`);
            }
        }

        // Force reload Google Services
        function forceReloadGoogleServices() {
            // Clear any cached Google Services
            if (typeof google !== 'undefined') {
                delete window.google;
            }
            
            // Reload Google Identity Services script
            const script = document.querySelector('script[src*="accounts.google.com/gsi/client"]');
            if (script) {
                script.remove();
            }
            
            // Add new script
            const newScript = document.createElement('script');
            newScript.src = 'https://accounts.google.com/gsi/client';
            newScript.async = true;
            newScript.defer = true;
            document.head.appendChild(newScript);
            
            alert('üîÑ ƒê√£ reload Google Services!\n\nVui l√≤ng ƒë·ª£i 2-3 gi√¢y r·ªìi th·ª≠ l·∫°i.');
        }

        // H√†m th·ª≠ l·∫°i Gmail authentication
        function retryGmailAuth() {
            // Reset Gmail access token
            gmailAccessToken = null;
            
            // Clear localStorage
            localStorage.removeItem('user');
            currentUser = null;
            
            // Show instructions
            alert(`üîÑ TH·ª¨ L·∫†I GMAIL AUTHENTICATION

ƒê·ªÉ fix l·ªói Gmail, h√£y l√†m theo c√°c b∆∞·ªõc sau:

1. üîÑ Refresh trang web n√†y
2. üîê ƒêƒÉng nh·∫≠p l·∫°i b·∫±ng Google
3. üìß Th·ª≠ g·ª≠i email l·∫°i

N·∫øu v·∫´n l·ªói:
- Ki·ªÉm tra OAuth consent screen trong Google Cloud Console
- ƒê·∫£m b·∫£o Gmail API ƒë√£ ƒë∆∞·ª£c b·∫≠t
- Th·ª≠ v·ªõi Google account kh√°c
- Clear browser cache v√† cookies

Domain hi·ªán t·∫°i: ${window.location.origin}
Redirect URI: ${REDIRECT_URI}
            `);
            
            // Auto refresh after 3 seconds
            setTimeout(() => {
                if (confirm('B·∫°n c√≥ mu·ªën refresh trang ƒë·ªÉ th·ª≠ l·∫°i kh√¥ng?')) {
                    window.location.reload();
                }
            }, 3000);
        }

        function configureGmailAPI() {
            const instructions = `
üîß C·∫§U H√åNH GMAIL API

ƒê·ªÉ g·ª≠i email tr·ª±c ti·∫øp t·ª´ dashboard, b·∫°n c·∫ßn:

1. üìã T·∫°o Google Cloud Project:
   - Truy c·∫≠p: https://console.cloud.google.com/
   - T·∫°o project m·ªõi ho·∫∑c ch·ªçn project hi·ªán c√≥

2. üîë B·∫≠t Gmail API:
   - V√†o "APIs & Services" ‚Üí "Library"
   - T√¨m "Gmail API" v√† b·∫≠t n√≥

3. üÜî OAuth 2.0 Client ID ƒë√£ c√≥:
   - Client ID: 1034144698153-qnh5747mmfku65u52s3mp3narrssbq8n.apps.googleusercontent.com
   - V√†o "APIs & Services" ‚Üí "Credentials"
   - Ch·ªânh s·ª≠a OAuth 2.0 Client ID hi·ªán c√≥
   - Authorized JavaScript origins: ${window.location.origin}
   - Authorized redirect URIs: ${window.location.origin}/
   - Th√™m redirect URI: ${window.location.origin}
   - Th√™m redirect URI: ${window.location.origin}/index.html

4. üîê C·∫•u h√¨nh OAuth consent screen:
   - V√†o "OAuth consent screen"
   - Ch·ªçn "Internal" (n·∫øu d√πng Google Workspace)
   - Ho·∫∑c "External" v√† ƒëi·ªÅn th√¥ng tin c·∫ßn thi·∫øt
   - Th√™m scope: https://www.googleapis.com/auth/gmail.send

5. üåê C·∫•u h√¨nh CORS (QUAN TR·ªåNG):
   - Domain hi·ªán t·∫°i: ${window.location.origin}
   - ƒê·∫£m b·∫£o domain ƒë∆∞·ª£c th√™m v√†o "Authorized JavaScript origins"
   - Ki·ªÉm tra CSP headers ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh ƒë√∫ng

6. ‚úÖ Test:
   - Refresh trang v√† th·ª≠ g·ª≠i email
   - S·∫Ω c√≥ popup x√°c th·ª±c Gmail l·∫ßn ƒë·∫ßu
   - Email s·∫Ω ƒë∆∞·ª£c g·ª≠i tr·ª±c ti·∫øp qua Gmail API

üìû H·ªó tr·ª£: N·∫øu g·∫∑p kh√≥ khƒÉn, h√£y s·ª≠ d·ª•ng ch·ª©c nƒÉng "Copy n·ªôi dung" ƒë·ªÉ g·ª≠i th·ªß c√¥ng.

‚ö†Ô∏è L∆ØU √ù: N·∫øu g·∫∑p l·ªói "server_error":
1. Ki·ªÉm tra OAuth consent screen ƒë√£ ƒë∆∞·ª£c c·∫•u h√¨nh ƒë√∫ng
2. ƒê·∫£m b·∫£o Gmail API ƒë√£ ƒë∆∞·ª£c b·∫≠t
3. Ki·ªÉm tra domain ƒë∆∞·ª£c th√™m v√†o "Authorized JavaScript origins"
4. Th·ª≠ ƒëƒÉng nh·∫≠p l·∫°i v·ªõi Google account kh√°c
5. S·ª≠ d·ª•ng ch·ª©c nƒÉng "Copy n·ªôi dung" ƒë·ªÉ g·ª≠i th·ªß c√¥ng

üîß FIX L·ªñI SERVER_ERROR:
- V√†o Google Cloud Console ‚Üí APIs & Services ‚Üí OAuth consent screen
- ƒê·∫£m b·∫£o "Publishing status" l√† "In production" ho·∫∑c "Testing"
- Th√™m scope: https://www.googleapis.com/auth/gmail.send
- Ki·ªÉm tra "Authorized domains" c√≥ ch·ª©a domain hi·ªán t·∫°i
            `;
            
            alert(instructions);
        }

        function copyRowData(rowData) {
            const text = `
Th·ªùi gian n·ªôp b√†i: ${rowData.submitTime}
H·ªç v√† t√™n: ${rowData.fullname}
Tu·ªïi: ${rowData.age}
S·ªë ƒëi·ªán tho·∫°i: ${rowData.phone}
Email: ${rowData.email}
ƒêi·ªÉm: ${rowData.score}
C·∫•p ƒë·ªô: ${rowData.level}
C√¢u tr·∫£ l·ªùi: ${rowData.answersText}
            `.trim();

            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ ƒê√£ copy d·ªØ li·ªáu!');
            }).catch(err => {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert('‚úÖ ƒê√£ copy d·ªØ li·ªáu v√†o clipboard!');
                } catch (err) {
                    alert('‚ùå Kh√¥ng th·ªÉ copy. Vui l√≤ng th·ª≠ l·∫°i.');
                }
                document.body.removeChild(textArea);
            });
        }

        async function showAIFeedback(fullname, email, phone, essay, prompt, allAnswers, writingAiComment, score) {
            const modal = document.getElementById('aiFeedbackModal');
            modal.classList.add('show');
            
            document.getElementById('studentInfo').innerHTML = `
                <h3>üë§ Th√¥ng tin h·ªçc vi√™n</h3>
                <p><strong>H·ªç t√™n:</strong> ${fullname}</p>
                <p><strong>Email:</strong> ${email}</p>
                <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${phone}</p>
            `;
            
            // Hi·ªÉn th·ªã ph·∫ßn k·∫øt qu·∫£ test v·ªõi ƒëi·ªÉm t·ª´ database
            displayTestResultFromScore(score);
            
            // ƒê√°p √°n ƒë√∫ng (index b·∫Øt ƒë·∫ßu t·ª´ 0)
            const correctAnswers = {
                '0': 'B',   // Q1
                '1': 'A',   // Q2
                '2': 'A',   // Q3
                '3': 'A',   // Q4
                '4': 'B',   // Q5
                '5': 'Â•πÂè´ËãèËãè',   // Q6
                '6': 'Â•πÂñúÊ¨¢Ê±âËØ≠',   // Q7
                '7': '‰∏ç',   // Q8
                '8': 'Ê≤°Êúâ',   // Q9
                '9': 'Â•πÁé∞Âú®Âú®‰∏≠ÂõΩ'    // Q10
            };
            
            if (allAnswers) {
                const listeningSection = document.getElementById('listeningSection');
                const listeningGrid = document.getElementById('listeningGrid');
                const readingSection = document.getElementById('readingSection');
                const readingGrid = document.getElementById('readingGrid');
                
                listeningSection.style.display = 'block';
                readingSection.style.display = 'block';
                
                listeningGrid.innerHTML = '';
                readingGrid.innerHTML = '';
                
                let listeningCorrect = 0;
                let readingCorrect = 0;
                
                // Ph·∫ßn Nghe (Q1-Q5, index 0-4)
                for (let i = 0; i < 5; i++) {
                    const key = String(i);
                    const userAnswer = allAnswers[key] || 'N/A';
                    const correctAnswer = correctAnswers[key];
                    const isCorrect = userAnswer === correctAnswer;
                    
                    console.log(`Listening Q${i+1}: User=${userAnswer}, Correct=${correctAnswer}, Match=${isCorrect}`);
                    
                    if (isCorrect) listeningCorrect++;
                    
                    const badge = document.createElement('div');
                    badge.className = `answer-badge ${isCorrect ? 'answer-correct' : 'answer-incorrect'}`;
                    badge.innerHTML = `
                        ${i + 1}: ${userAnswer} <span class="answer-icon">${isCorrect ? '‚úì' : '‚úó'}</span>
                        <span class="answer-tooltip">ƒê√°p √°n ƒë√∫ng: ${correctAnswer}</span>
                    `;
                    listeningGrid.appendChild(badge);
                }
                
                // Ph·∫ßn ƒêi·ªÅn ƒê√°p √Ån (Q6-Q10, index 5-9)
                for (let i = 5; i < 10; i++) {
                    const key = String(i);
                    const userAnswer = allAnswers[key] || 'N/A';
                    const correctAnswer = correctAnswers[key];
                    const isCorrect = userAnswer === correctAnswer;
                    
                    console.log(`Reading Q${i+1}: User=${userAnswer}, Correct=${correctAnswer}, Match=${isCorrect}`);
                    
                    if (isCorrect) readingCorrect++;
                    
                    const badge = document.createElement('div');
                    badge.className = `answer-badge ${isCorrect ? 'answer-correct' : 'answer-incorrect'}`;
                    badge.innerHTML = `
                        ${i + 1}: ${userAnswer} <span class="answer-icon">${isCorrect ? '‚úì' : '‚úó'}</span>
                        <span class="answer-tooltip">ƒê√°p √°n ƒë√∫ng: ${correctAnswer}</span>
                    `;
                    readingGrid.appendChild(badge);
                }
                
                document.getElementById('listeningScore').textContent = listeningCorrect;
                document.getElementById('readingScore').textContent = readingCorrect;
            }
            
            if (essay && essay.trim().length > 0) {
                document.getElementById('essayDisplay').style.display = 'block';
                document.getElementById('essayText').textContent = essay;
            } else {
                document.getElementById('essayDisplay').style.display = 'none';
            }
            
            const feedbackContent = document.getElementById('aiFeedbackContent');
            
            if (writingAiComment && writingAiComment.trim().length > 0) {
                const paragraphs = writingAiComment.split('\n\n').filter(p => p.trim());
                let formattedHTML = '';
                
                if (paragraphs.length > 0) {
                    paragraphs.forEach(para => {
                        const cleaned = para.trim().replace(/\n/g, '<br>');
                        formattedHTML += `<p>${cleaned}</p>`;
                    });
                } else {
                    formattedHTML = `<p>${writingAiComment.replace(/\n/g, '<br>')}</p>`;
                }
                
                feedbackContent.innerHTML = formattedHTML;
            } else {
                feedbackContent.innerHTML = `
                    <p style="color: #92400e;">
                        <strong>üìù Ch∆∞a c√≥ nh·∫≠n x√©t</strong><br><br>
                        B√†i vi·∫øt c·ªßa h·ªçc vi√™n ch∆∞a ƒë∆∞·ª£c ƒë√°nh gi√° b·ªüi AI.
                    </p>
                `;
            }
        }

        function showAIFeedbackById(dataId) {
            const data = window.studentFeedbackData[dataId];
            if (data) {
                const level = (data.selectedLevel || '1').toString().trim();
                const isHSK2 = level === '2' || level.toUpperCase() === 'HSK2' || level.toUpperCase() === 'HSK 2';
                
                if (isHSK2) {
                    showHSK2Feedback(data.fullname, data.email, data.phone, data.essay, data.prompt, data.allAnswers, data.writingAiComment, data.score);
                } else {
                    showAIFeedback(data.fullname, data.email, data.phone, data.essay, data.prompt, data.allAnswers, data.writingAiComment, data.score);
                }
            } else {
                alert('‚ùå Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu h·ªçc vi√™n!');
            }
        }

        function displayTestResultFromScore(score) {
            if (!score || score === 'N/A' || score === null || score === undefined) {
                document.getElementById('testResultSection').style.display = 'none';
                return;
            }
            
            const numericScore = parseInt(score);
            if (isNaN(numericScore)) {
                document.getElementById('testResultSection').style.display = 'none';
                return;
            }
            
            document.getElementById('totalScore').textContent = numericScore;
            
            let status, statusClass, comment, learningPath;
            
            if (numericScore >= 24) {
                status = "ƒê·∫°t";
                statusClass = "status-excellent";
                comment = "Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh b√†i test! ƒêi·ªÉm s·ªë c·ªßa b·∫°n ·ªü m·ª©c cao c·ªßa HSK1";
                learningPath = "HSK2 tr·ªü l√™n";
            } else {
                status = "Ch∆∞a ƒë·∫°t";
                statusClass = "status-fail";
                comment = "B·∫°n ch∆∞a ƒë·∫°t m·ª©c c∆° b·∫£n, c·∫ßn b·∫Øt ƒë·∫ßu t·ª´ H√°n ng·ªØ s∆° c·∫•p 1 ƒë·ªÉ l√†m quen v·ªõi ph√°t √¢m v√† t·ª´ v·ª±ng n·ªÅn";
                learningPath = "HSK1 tr·ªü l√™n";
            }
            
            const statusBadge = document.getElementById('statusBadge');
            statusBadge.textContent = status;
            statusBadge.className = `status-badge ${statusClass}`;
            
            document.getElementById('commentText').textContent = comment;
            document.getElementById('learningPathText').textContent = learningPath;
            
            document.getElementById('testResultSection').style.display = 'block';
        }

        function displayTestResult(allAnswers) {
            if (!allAnswers) {
                document.getElementById('testResultSection').style.display = 'none';
                return;
            }
            
            // ƒê√°p √°n ƒë√∫ng
            const correctAnswers = {
                '0': 'B',   // Q1
                '1': 'A',   // Q2
                '2': 'A',   // Q3
                '3': 'A',   // Q4
                '4': 'B',   // Q5
                '5': 'Â•πÂè´ËãèËãè',   // Q6
                '6': 'Â•πÂñúÊ¨¢Ê±âËØ≠',   // Q7
                '7': '‰∏ç',   // Q8
                '8': 'Ê≤°Êúâ',   // Q9
                '9': 'Â•πÁé∞Âú®Âú®‰∏≠ÂõΩ'    // Q10
            };
            
            // T√≠nh ƒëi·ªÉm s·ªë
            let totalScore = 0;
            for (let i = 0; i < 10; i++) {
                const key = String(i);
                const userAnswer = allAnswers[key] || '';
                const correctAnswer = correctAnswers[key];
                if (userAnswer === correctAnswer) {
                    totalScore += 3; // M·ªói c√¢u ƒë√∫ng ƒë∆∞·ª£c 3 ƒëi·ªÉm
                }
            }
            
            // Hi·ªÉn th·ªã ƒëi·ªÉm s·ªë
            document.getElementById('totalScore').textContent = totalScore;
            
            // Logic ƒë√°nh gi√° theo y√™u c·∫ßu
            let status, statusClass, comment, learningPath;
            
            if (totalScore >= 24) {
                status = "ƒê·∫°t";
                statusClass = "status-excellent";
                comment = "Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh b√†i test! ƒêi·ªÉm s·ªë c·ªßa b·∫°n ·ªü m·ª©c cao c·ªßa HSK1";
                learningPath = "HSK2 tr·ªü l√™n";
            } else {
                status = "Ch∆∞a ƒë·∫°t";
                statusClass = "status-fail";
                comment = "B·∫°n ch∆∞a ƒë·∫°t m·ª©c c∆° b·∫£n, c·∫ßn b·∫Øt ƒë·∫ßu t·ª´ H√°n ng·ªØ s∆° c·∫•p 1 ƒë·ªÉ l√†m quen v·ªõi ph√°t √¢m v√† t·ª´ v·ª±ng n·ªÅn";
                learningPath = "HSK1 tr·ªü l√™n";
            }
            
            // C·∫≠p nh·∫≠t giao di·ªán
            const statusBadge = document.getElementById('statusBadge');
            statusBadge.textContent = status;
            statusBadge.className = `status-badge ${statusClass}`;
            
            document.getElementById('commentText').textContent = comment;
            document.getElementById('learningPathText').textContent = learningPath;
            
            // Hi·ªÉn th·ªã ph·∫ßn k·∫øt qu·∫£ test
            document.getElementById('testResultSection').style.display = 'block';
        }

        function closeAIFeedbackModal() {
            document.getElementById('aiFeedbackModal').classList.remove('show');
        }

        document.getElementById('aiFeedbackModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAIFeedbackModal();
            }
        });

        // H√†m hi·ªÉn th·ªã t·ªïng quan b√†i l√†m HSK2
        function showHSK2Feedback(fullname, email, phone, essay, prompt, allAnswers, writingAiComment, score) {
            // Hi·ªÉn th·ªã th√¥ng tin h·ªçc vi√™n
            document.getElementById('hsk2StudentInfo').innerHTML = `
                <h3>üë§ Th√¥ng tin h·ªçc vi√™n</h3>
                <p><strong>H·ªç t√™n:</strong> ${fullname}</p>
                <p><strong>Email:</strong> ${email}</p>
                <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${phone}</p>
            `;
            
            // Hi·ªÉn th·ªã k·∫øt qu·∫£ test n·∫øu c√≥ ƒëi·ªÉm
            displayTestResultFromScoreHSK2(score);
            
            // ƒê√°p √°n ƒë√∫ng HSK2 (60 c√¢u)
            const correctAnswers = {
                // Ph·∫ßn Nghe hi·ªÉu - 35 c√¢u (Q1-Q35, index 0-34)
                '0': 'false', '1': 'true', '2': 'true', '3': 'false', '4': 'false',
                '5': 'false', '6': 'false', '7': 'true', '8': 'true', '9': 'true',
                '10': 'A', '11': 'B', '12': 'C', '13': 'F', '14': 'E',
                '15': 'D', '16': 'G', '17': 'H', '18': 'I', '19': 'J',
                '20': 'C', '21': 'A', '22': 'B', '23': 'C', '24': 'B',
                '25': 'A', '26': 'C', '27': 'C', '28': 'A', '29': 'B',
                '30': 'B', '31': 'A', '32': 'B', '33': 'A', '34': 'C',
                
                // Ph·∫ßn ƒê·ªçc hi·ªÉu - 25 c√¢u (Q36-Q60, index 35-59)
                '35': 'E', '36': 'B', '37': 'C', '38': 'F', '39': 'A',
                '40': 'B', '41': 'F', '42': 'D', '43': 'A', '44': 'C',
                '45': 'false', '46': 'true', '47': 'false', '48': 'false', '49': 'true',
                '50': 'D', '51': 'C', '52': 'A', '53': 'F', '54': 'B',
                '55': 'E', '56': 'A', '57': 'C', '58': 'D', '59': 'B'
            };
            
            if (allAnswers) {
                const listeningSection = document.getElementById('hsk2ListeningSection');
                const listeningGrid = document.getElementById('hsk2ListeningGrid');
                const readingSection = document.getElementById('hsk2ReadingSection');
                const readingGrid = document.getElementById('hsk2ReadingGrid');
                
                listeningSection.style.display = 'block';
                readingSection.style.display = 'block';
                
                listeningGrid.innerHTML = '';
                readingGrid.innerHTML = '';
                
                let listeningCorrect = 0;
                let readingCorrect = 0;
                
                // Ph·∫ßn Nghe hi·ªÉu (Q1-Q35, index 0-34)
                for (let i = 0; i < 35; i++) {
                    const key = String(i);
                    const userAnswer = allAnswers[key] || 'N/A';
                    const correctAnswer = correctAnswers[key];
                    const isCorrect = userAnswer === correctAnswer;
                    
                    if (isCorrect) listeningCorrect++;
                    
                    const badge = document.createElement('div');
                    badge.className = `answer-badge ${isCorrect ? 'answer-correct' : 'answer-incorrect'}`;
                    badge.innerHTML = `
                        ${i + 1}: ${userAnswer} <span class="answer-icon">${isCorrect ? '‚úì' : '‚úó'}</span>
                        <span class="answer-tooltip">ƒê√°p √°n ƒë√∫ng: ${correctAnswer}</span>
                    `;
                    listeningGrid.appendChild(badge);
                }
                
                // Ph·∫ßn ƒê·ªçc hi·ªÉu (Q36-Q60, index 35-59)
                for (let i = 35; i < 60; i++) {
                    const key = String(i);
                    const userAnswer = allAnswers[key] || 'N/A';
                    const correctAnswer = correctAnswers[key];
                    const isCorrect = userAnswer === correctAnswer;
                    
                    if (isCorrect) readingCorrect++;
                    
                    const badge = document.createElement('div');
                    badge.className = `answer-badge ${isCorrect ? 'answer-correct' : 'answer-incorrect'}`;
                    badge.innerHTML = `
                        ${i + 1}: ${userAnswer} <span class="answer-icon">${isCorrect ? '‚úì' : '‚úó'}</span>
                        <span class="answer-tooltip">ƒê√°p √°n ƒë√∫ng: ${correctAnswer}</span>
                    `;
                    readingGrid.appendChild(badge);
                }
                
                document.getElementById('hsk2ListeningScore').textContent = listeningCorrect;
                document.getElementById('hsk2ReadingScore').textContent = readingCorrect;
            }
            
            // Hi·ªÉn th·ªã modal
            const modal = document.getElementById('hsk2FeedbackModal');
            modal.classList.add('show');
        }

        function displayTestResultFromScoreHSK2(score) {
            if (!score || score === 'N/A' || score === null || score === undefined) {
                document.getElementById('hsk2TestResultSection').style.display = 'none';
                return;
            }
            
            const numericScore = parseInt(score);
            if (isNaN(numericScore)) {
                document.getElementById('hsk2TestResultSection').style.display = 'none';
                return;
            }
            
            document.getElementById('hsk2TotalScore').textContent = numericScore;
            
            let status, statusClass, comment, learningPath;
            
            // Logic ƒë√°nh gi√° HSK2 (ƒëi·ªÉm t·ªëi ƒëa 200)
            if (numericScore >= 150) {
                status = "ƒê·∫°t";
                statusClass = "status-excellent";
                comment = "Hi·ªÉu v√† s·ª≠ d·ª•ng ƒë∆∞·ª£c c√°c m·∫´u c√¢u giao ti·∫øp c∆° b·∫£n, n·∫Øm v·ªØng kho·∫£ng 300 t·ª´ v·ª±ng HSK2, c√≥ th·ªÉ nghe ‚Äì n√≥i ‚Äì ƒë·ªçc ·ªü m·ª©c ƒë∆°n gi·∫£n.";
                learningPath = "HSK3";
            } else {
                status = "Kh√¥ng ƒë·∫°t";
                statusClass = "status-fail";
                comment = "Ch∆∞a v·ªØng t·ª´ v·ª±ng v√† c·∫•u tr√∫c ng·ªØ ph√°p; c·∫ßn √¥n luy·ªán th√™m k·ªπ nƒÉng nghe, ƒë·ªçc v√† ph·∫£n x·∫° giao ti·∫øp.";
                learningPath = "H·ªçc l·∫°i HSK1-2";
            }
            
            const statusBadge = document.getElementById('hsk2StatusBadge');
            statusBadge.textContent = status;
            statusBadge.className = `status-badge ${statusClass}`;
            
            document.getElementById('hsk2CommentText').innerHTML = comment;
            document.getElementById('hsk2LearningPathText').innerHTML = learningPath;
            
            document.getElementById('hsk2TestResultSection').style.display = 'block';
        }

        function closeHSK2FeedbackModal() {
            document.getElementById('hsk2FeedbackModal').classList.remove('show');
        }

        document.getElementById('hsk2FeedbackModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeHSK2FeedbackModal();
            }
        });

        async function generateShareLinkHSK2() {
            try {
                const studentInfo = document.getElementById('hsk2StudentInfo');
                if (!studentInfo) {
                    alert('‚ùå Kh√¥ng t√¨m th·∫•y th√¥ng tin h·ªçc vi√™n!');
                    return;
                }
                
                const studentName = studentInfo.querySelector('p:nth-child(2)')?.textContent?.replace('H·ªç t√™n: ', '') || 'HocVien';
                const studentEmail = studentInfo.querySelector('p:nth-child(3)')?.textContent?.replace('Email: ', '') || '';
                const studentPhone = studentInfo.querySelector('p:nth-child(4)')?.textContent?.replace('S·ªë ƒëi·ªán tho·∫°i: ', '') || '';
                
                const listeningSection = document.getElementById('hsk2ListeningSection');
                const readingSection = document.getElementById('hsk2ReadingSection');
                
                let listeningData = null;
                let readingData = null;
                
                // L·∫•y d·ªØ li·ªáu ph·∫ßn Nghe hi·ªÉu
                if (listeningSection && listeningSection.style.display !== 'none') {
                    try {
                        const listeningScore = document.getElementById('hsk2ListeningScore')?.textContent || '0';
                        const listeningGrid = document.getElementById('hsk2ListeningGrid');
                        if (listeningGrid) {
                            const badges = listeningGrid.querySelectorAll('.answer-badge');
                            const answers = Array.from(badges).map(badge => ({
                                text: badge.textContent.trim(),
                                isCorrect: badge.classList.contains('answer-correct')
                            }));
                            // L∆∞u s·ªë c√¢u ƒë√∫ng thay v√¨ ƒëi·ªÉm s·ªë
                            const correctCount = answers.filter(a => a.isCorrect).length;
                            listeningData = { score: correctCount, answers: answers };
                        }
                    } catch (e) {}
                }
                
                // L·∫•y d·ªØ li·ªáu ph·∫ßn ƒê·ªçc hi·ªÉu
                if (readingSection && readingSection.style.display !== 'none') {
                    try {
                        const readingScore = document.getElementById('hsk2ReadingScore')?.textContent || '0';
                        const readingGrid = document.getElementById('hsk2ReadingGrid');
                        if (readingGrid) {
                            const badges = readingGrid.querySelectorAll('.answer-badge');
                            const answers = Array.from(badges).map(badge => ({
                                text: badge.textContent.trim(),
                                isCorrect: badge.classList.contains('answer-correct')
                            }));
                            // L∆∞u s·ªë c√¢u ƒë√∫ng thay v√¨ ƒëi·ªÉm s·ªë
                            const correctCount = answers.filter(a => a.isCorrect).length;
                            readingData = { score: correctCount, answers: answers };
                        }
                    } catch (e) {}
                }
                
                // T·∫°o URL v·ªõi d·ªØ li·ªáu
                const shareData = {
                    type: 'hsk2',
                    student: {
                        name: studentName,
                        email: studentEmail,
                        phone: studentPhone
                    },
                    listening: listeningData,
                    reading: readingData,
                    timestamp: new Date().toISOString()
                };
                
                const encodedData = encodeURIComponent(JSON.stringify(shareData));
                const shareUrl = `${window.location.origin}${window.location.pathname}?share=${encodedData}`;
                
                // Copy v√†o clipboard
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        alert(`‚úÖ ƒê√£ copy link chia s·∫ª HSK2!\n\nüîó Link: ${shareUrl}\n\nüìã Link ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o clipboard.`);
                    }).catch(() => {
                        // Fallback
                        const textArea = document.createElement('textarea');
                        textArea.value = shareUrl;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        alert(`‚úÖ ƒê√£ copy link chia s·∫ª HSK2!\n\nüîó Link: ${shareUrl}\n\nüìã Link ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o clipboard.`);
                    });
                } else {
                    // Fallback cho tr√¨nh duy·ªát c≈©
                    const textArea = document.createElement('textarea');
                    textArea.value = shareUrl;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert(`‚úÖ ƒê√£ copy link chia s·∫ª HSK2!\n\nüîó Link: ${shareUrl}\n\nüìã Link ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o clipboard.`);
                }
                
            } catch (error) {
                console.error('Error generating share link:', error);
                alert('‚ùå C√≥ l·ªói x·∫£y ra khi t·∫°o link chia s·∫ª!\n\nVui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        async function loadAllData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('tableWrapper').style.display = 'none';
            document.getElementById('searchPhone').value = '';
            document.getElementById('searchEmail').value = '';
            document.getElementById('filterAnswers').value = 'has_answers';

            const { data, error } = await supabaseClient
                .from('placement')
                .select(`
                    *,
                    test_results (*)
                `)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error:', error);
                document.getElementById('loading').innerHTML = '<div class="no-results">L·ªói khi t·∫£i d·ªØ li·ªáu</div>';
            } else {
                allData = data;
                applyFilter();
            }
        }

        async function searchData() {
            const phone = document.getElementById('searchPhone').value.trim();
            const email = document.getElementById('searchEmail').value.trim();

            if (!phone && !email) {
                alert('Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i ho·∫∑c email ƒë·ªÉ t√¨m ki·∫øm');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('tableWrapper').style.display = 'none';

            let query = supabaseClient
                .from('placement')
                .select(`
                    *,
                    test_results (*)
                `);

            if (phone) {
                query = query.ilike('phone', `%${phone}%`);
            }
            if (email) {
                query = query.ilike('email', `%${email}%`);
            }

            const { data, error } = await query.order('created_at', { ascending: false });

            if (error) {
                console.error('Error:', error);
                document.getElementById('loading').innerHTML = '<div class="no-results">L·ªói khi t√¨m ki·∫øm d·ªØ li·ªáu</div>';
            } else {
                allData = data;
                applyFilter();
            }
        }

        function displayData(data) {
            const tbody = document.getElementById('dataTable');
            tbody.innerHTML = '';

            if (!data || data.length === 0) {
                document.getElementById('loading').innerHTML = '<div class="no-results">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</div>';
                document.getElementById('loading').style.display = 'block';
                return;
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('tableWrapper').style.display = 'block';

            data.forEach((item, index) => {
                const row = document.createElement('tr');
                const testResult = item.test_results && item.test_results.length > 0 ? item.test_results[0] : null;
                
                const score = testResult ? testResult.score : 'N/A';
                const level = testResult ? testResult.selected_level : 'N/A';
                const submitTime = testResult ? new Date(testResult.completed_at).toLocaleString('vi-VN') : 'N/A';
                const writingAiComment = testResult ? testResult.writing_ai_comment : null;
                const phone = item.phone;
                
                // L·∫•y b√†i vi·∫øt t·ª´ answers
                let writingAnswer = null;
                if (testResult && testResult.answers && testResult.answers['10']) {
                    writingAnswer = testResult.answers['10'];
                }
                
                // L∆∞u d·ªØ li·ªáu v√†o data attributes
                row.dataset.writingAiComment = writingAiComment || '';
                row.dataset.allAnswers = testResult && testResult.answers ? JSON.stringify(testResult.answers) : '{}';
                row.dataset.essay = writingAnswer || '';
                row.dataset.selectedLevel = level || 'HSK1';
                
                
                let scoreClass = 'score-low';
                if (score !== 'N/A') {
                    if (score >= 7) scoreClass = 'score-high';
                    else if (score >= 4) scoreClass = 'score-mid';
                }

                let recommendedLevel = '';
                let recommendedClass = '';
                if (score !== 'N/A') {
                    // Ki·ªÉm tra tr√¨nh ƒë·ªô HSK
                    const levelStr = (level || '1').toString().trim();
                    const isHSK2 = levelStr === '2' || levelStr.toUpperCase() === 'HSK2' || levelStr.toUpperCase() === 'HSK 2';
                    
                    if (isHSK2) {
                        // Logic cho HSK2 (ƒëi·ªÉm t·ªëi ƒëa 200)
                        if (score >= 150) {
                            recommendedLevel = '‚úÖ HSK3 tr·ªü l√™n<br><small style="font-size: 0.85em; font-weight: 400;">Hi·ªÉu v√† s·ª≠ d·ª•ng ƒë∆∞·ª£c c√°c m·∫´u c√¢u giao ti·∫øp c∆° b·∫£n</small>';
                            recommendedClass = 'level-excellent';
                        } else {
                            recommendedLevel = 'üìö H·ªçc l·∫°i HSK1-2<br><small style="font-size: 0.85em; font-weight: 400;">Ch∆∞a v·ªØng t·ª´ v·ª±ng v√† c·∫•u tr√∫c ng·ªØ ph√°p</small>';
                            recommendedClass = 'level-fail';
                        }
                    } else {
                        // Logic cho HSK1 (ƒëi·ªÉm t·ªëi ƒëa 30)
                        if (score >= 24 && score <= 30) {
                            recommendedLevel = '‚úÖ HSK2 tr·ªü l√™n<br><small style="font-size: 0.85em; font-weight: 400;">ƒê·∫°t xu·∫•t s·∫Øc - ƒêi·ªÉm cao HSK1</small>';
                            recommendedClass = 'level-excellent';
                        } else {
                            recommendedLevel = 'üìö HSK1 tr·ªü l√™n<br><small style="font-size: 0.85em; font-weight: 400;">C·∫ßn h·ªçc t·ª´ c∆° b·∫£n</small>';
                            recommendedClass = 'level-fail';
                        }
                    }
                } else {
                    recommendedLevel = 'N/A';
                }

                let answersHtml = '<div class="answers-cell">Ch∆∞a c√≥ c√¢u tr·∫£ l·ªùi</div>';
                let answersText = 'Ch∆∞a c√≥ c√¢u tr·∫£ l·ªùi';
                let hasWriting = false;
                
                if (testResult && testResult.answers) {
                    const answers = testResult.answers;
                    answersHtml = '<div class="answers-cell">';
                    let answersList = [];
                    
                    for (let key in answers) {
                        const questionNum = parseInt(key) + 1;
                        const answerValue = answers[key];
                        
                        if (parseInt(key) === 10) {
                            hasWriting = true;
                        }
                        
                        answersHtml += `
                            <div class="answer-item">
                                <span class="answer-label">Q${questionNum}:</span>
                                <span class="answer-value">${answerValue}</span>
                            </div>
                        `;
                        answersList.push(`Q${questionNum}: ${answerValue}`);
                    }
                    answersHtml += '</div>';
                    answersText = answersList.join(', ');
                }

                const rowData = {
                    submitTime: submitTime,
                    fullname: item.fullname,
                    age: item.age,
                    phone: item.phone,
                    email: item.email,
                    score: score,
                    level: level,
                    answersText: answersText,
                    writingAiComment: writingAiComment
                };

                let aiFeedbackBtn = '';
                if (hasWriting && writingAnswer && writingAnswer.trim().length > 0) {
                    const dataId = 'student-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    
                    if (!window.studentFeedbackData) {
                        window.studentFeedbackData = {};
                    }
                    
                    window.studentFeedbackData[dataId] = {
                        fullname: item.fullname,
                        email: item.email,
                        phone: item.phone,
                        essay: writingAnswer,
                        prompt: 'Vi·∫øt ƒëo·∫°n vƒÉn 20‚Äì30 t·ª´ theo ch·ªß ƒë·ªÅ "Ng∆∞·ªùi b·∫°n c·ªßa t√¥i ‚Äì ÊàëÁöÑÊúãÂèã"',
                        allAnswers: testResult ? testResult.answers : null,
                        writingAiComment: writingAiComment,
                        score: score,
                        selectedLevel: level || 'HSK1'
                    };
                    
                    aiFeedbackBtn = `
                        <button class="ai-feedback-btn" onclick="showAIFeedbackById('${dataId}')">
                            ‚úçÔ∏è T·ªïng quan b√†i l√†m
                        </button>
                    `;
                }

                // Highlight HSK2 trong c·ªôt tr√¨nh ƒë·ªô
                const levelStr = level && level !== 'N/A' ? level.toString().trim() : level;
                const isHSK2Row = levelStr === '2' || levelStr.toUpperCase() === 'HSK2' || levelStr.toUpperCase() === 'HSK 2';
                const levelDisplay = isHSK2Row ? 'HSK2' : (levelStr === '1' || levelStr.toUpperCase() === 'HSK1' || levelStr.toUpperCase() === 'HSK 1') ? 'HSK1' : levelStr;
                const levelClass = isHSK2Row ? 'level-hsk2-badge' : 'level-hsk1-badge';
                
                row.innerHTML = `
                    <td class="time-cell">${submitTime}</td>
                    <td>${item.fullname}</td>
                    <td>${item.age}</td>
                    <td>${item.phone}</td>
                    <td>${item.email}</td>
                    <td><span class="score-badge ${scoreClass}">${score}</span></td>
                    <td><span class="${levelClass}" style="padding: 5px 10px; border-radius: 5px; font-weight: 600; display: inline-block;">${levelDisplay}</span></td>
                    <td>${recommendedLevel !== 'N/A' ? `<div class="recommended-level ${recommendedClass}">${recommendedLevel}</div>` : 'N/A'}</td>
                    <td>${answersHtml}</td>
                    <td class="action-cell">
                        <div class="action-buttons-wrapper">
                            <div class="action-buttons-top">
                                <button class="send-email-btn" onclick="sendEmailFromRow(${index})">
                                    üìß G·ª≠i email
                                </button>
                                <button class="copy-btn" onclick='copyRowData(${JSON.stringify(rowData).replace(/'/g, "&#39;")})'>
                                    üìã Copy
                                </button>
                                ${aiFeedbackBtn}
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }


        async function generateShareLink() {
            try {
                const studentInfo = document.getElementById('studentInfo');
                if (!studentInfo) {
                    alert('‚ùå Kh√¥ng t√¨m th·∫•y th√¥ng tin h·ªçc vi√™n!');
                    return;
                }
                
                const studentName = studentInfo.querySelector('p:nth-child(2)')?.textContent?.replace('H·ªç t√™n: ', '') || 'HocVien';
                const studentEmail = studentInfo.querySelector('p:nth-child(3)')?.textContent?.replace('Email: ', '') || '';
                const studentPhone = studentInfo.querySelector('p:nth-child(4)')?.textContent?.replace('S·ªë ƒëi·ªán tho·∫°i: ', '') || '';
                
                const listeningSection = document.getElementById('listeningSection');
                const readingSection = document.getElementById('readingSection');
                const essayDisplay = document.getElementById('essayDisplay');
                const aiFeedbackContent = document.getElementById('aiFeedbackContent');
                
                let listeningData = null;
                let readingData = null;
                let essayData = null;
                let feedbackData = null;
                
                if (listeningSection && listeningSection.style.display !== 'none') {
                    try {
                        const listeningScore = document.getElementById('listeningScore')?.textContent || '0';
                        const listeningGrid = document.getElementById('listeningGrid');
                        if (listeningGrid) {
                            const badges = listeningGrid.querySelectorAll('.answer-badge');
                            const answers = Array.from(badges).map(badge => ({
                                text: badge.textContent.trim(),
                                isCorrect: badge.classList.contains('answer-correct')
                            }));
                            listeningData = { score: listeningScore, answers: answers };
                        }
                    } catch (e) {}
                }
                
                if (readingSection && readingSection.style.display !== 'none') {
                    try {
                        const readingScore = document.getElementById('readingScore')?.textContent || '0';
                        const readingGrid = document.getElementById('readingGrid');
                        if (readingGrid) {
                            const badges = readingGrid.querySelectorAll('.answer-badge');
                            const answers = Array.from(badges).map(badge => ({
                                text: badge.textContent.trim(),
                                isCorrect: badge.classList.contains('answer-correct')
                            }));
                            readingData = { score: readingScore, answers: answers };
                        }
                    } catch (e) {}
                }
                
                if (essayDisplay && essayDisplay.style.display !== 'none') {
                    try {
                        const essayText = document.getElementById('essayText')?.textContent || '';
                        if (essayText.trim()) {
                            essayData = essayText;
                        }
                    } catch (e) {}
                }
                
                if (aiFeedbackContent) {
                    try {
                        const feedbackHTML = aiFeedbackContent.innerHTML;
                        const feedbackText = feedbackHTML
                            .replace(/<br\s*\/?>/gi, '\n')
                            .replace(/<p[^>]*>/gi, '')
                            .replace(/<\/p>/gi, '\n\n')
                            .replace(/<[^>]*>/g, '')
                            .trim();
                        if (feedbackText) {
                            feedbackData = feedbackText;
                        }
                    } catch (e) {}
                }
                
                const totalScoreElement = document.getElementById('totalScore');
                const currentScore = totalScoreElement ? totalScoreElement.textContent : null;
                
                const shareData = {
                    student: {
                        name: studentName,
                        email: studentEmail,
                        phone: studentPhone
                    },
                    score: currentScore,
                    listening: listeningData,
                    reading: readingData,
                    essay: essayData,
                    feedback: feedbackData,
                    timestamp: new Date().toISOString()
                };
                
                const jsonString = JSON.stringify(shareData);
                const encodedData = btoa(encodeURIComponent(jsonString));
                
                const currentUrl = window.location.origin + window.location.pathname;
                const shareUrl = `${currentUrl}?view=feedback&data=${encodedData}`;
                
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(shareUrl).then(() => {
                        alert('‚úÖ ƒê√£ copy link th√†nh c√¥ng!');
                    }).catch((clipError) => {
                        const textArea = document.createElement('textarea');
                        textArea.value = shareUrl;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        
                        alert('‚úÖ ƒê√£ copy link th√†nh c√¥ng!');
                    });
                } else {
                    const textArea = document.createElement('textarea');
                    textArea.value = shareUrl;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    alert('‚úÖ ƒê√£ copy link th√†nh c√¥ng!');
                }
                
            } catch (error) {
                alert(`‚ùå C√≥ l·ªói x·∫£y ra khi t·∫°o link chia s·∫ª.\n\nChi ti·∫øt l·ªói: ${error.message}\n\nVui l√≤ng th·ª≠ l·∫°i.`);
            }
        }

        function sendEmailFromModal() {
            try {
                const studentInfo = document.getElementById('studentInfo');
                const studentName = studentInfo.querySelector('p:nth-child(2)')?.textContent?.replace('H·ªç t√™n: ', '') || 'H·ªçc vi√™n';
                const studentEmail = studentInfo.querySelector('p:nth-child(3)')?.textContent?.replace('Email: ', '') || '';
                
                if (!studentEmail) {
                    alert('‚ùå Kh√¥ng t√¨m th·∫•y email h·ªçc vi√™n!');
                    return;
                }
                
                // T·∫°o n·ªôi dung email
                const emailSubject = `K·∫øt qu·∫£ b√†i test HSK - ${studentName}`;
                const emailBody = `Xin ch√†o ${studentName},\n\nƒê√¢y l√† k·∫øt qu·∫£ b√†i test HSK c·ªßa b·∫°n.\n\nVui l√≤ng xem chi ti·∫øt t·∫°i link: ${window.location.href}\n\nTr√¢n tr·ªçng!`;
                
                // T·∫°o mailto link
                const mailtoLink = `mailto:${studentEmail}?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
                
                // M·ªü email client
                window.open(mailtoLink);
                
                alert(`‚úÖ ƒê√£ m·ªü ·ª©ng d·ª•ng email!\n\nEmail s·∫Ω ƒë∆∞·ª£c g·ª≠i ƒë·∫øn: ${studentEmail}\n\nN·ªôi dung ƒë√£ ƒë∆∞·ª£c ƒëi·ªÅn s·∫µn.`);
                
            } catch (error) {
                console.error('L·ªói khi g·ª≠i email:', error);
                alert('‚ùå C√≥ l·ªói x·∫£y ra khi g·ª≠i email. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        function copyModalData() {
            try {
                const studentInfo = document.getElementById('studentInfo');
                const studentName = studentInfo.querySelector('p:nth-child(2)')?.textContent?.replace('H·ªç t√™n: ', '') || 'H·ªçc vi√™n';
                const studentEmail = studentInfo.querySelector('p:nth-child(3)')?.textContent?.replace('Email: ', '') || '';
                const studentPhone = studentInfo.querySelector('p:nth-child(4)')?.textContent?.replace('S·ªë ƒëi·ªán tho·∫°i: ', '') || '';
                
                // L·∫•y ƒëi·ªÉm s·ªë
                const listeningScore = document.getElementById('listeningScore')?.textContent || '0';
                const readingScore = document.getElementById('readingScore')?.textContent || '0';
                
                // L·∫•y nh·∫≠n x√©t AI
                const aiFeedbackContent = document.getElementById('aiFeedbackContent');
                const feedbackText = aiFeedbackContent ? aiFeedbackContent.textContent : 'Ch∆∞a c√≥ nh·∫≠n x√©t';
                
                // T·∫°o n·ªôi dung copy
                const copyText = `
K·∫æT QU·∫¢ B√ÄI TEST HSK
====================

TH√îNG TIN H·ªåC VI√äN:
- H·ªç v√† t√™n: ${studentName}
- Email: ${studentEmail}
- S·ªë ƒëi·ªán tho·∫°i: ${studentPhone}

K·∫æT QU·∫¢ B√ÄI TEST:
- Ph·∫ßn Nghe: ${listeningScore}/5 ƒë√∫ng
- Ph·∫ßn ƒêi·ªÅn ƒê√°p √Ån: ${readingScore}/5 ƒë√∫ng

NH·∫¨N X√âT B√ÄI VI·∫æT:
${feedbackText}

Ng√†y xu·∫•t b√°o c√°o: ${new Date().toLocaleDateString('vi-VN')}
                `.trim();
                
                // Copy v√†o clipboard
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(copyText).then(() => {
                        alert('‚úÖ ƒê√£ copy d·ªØ li·ªáu v√†o clipboard!\n\nB·∫°n c√≥ th·ªÉ paste v√†o b·∫•t k·ª≥ ƒë√¢u ƒë·ªÉ s·ª≠ d·ª•ng.');
                    }).catch(() => {
                        // Fallback
                        const textArea = document.createElement('textarea');
                        textArea.value = copyText;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        alert('‚úÖ ƒê√£ copy d·ªØ li·ªáu v√†o clipboard!');
                    });
                } else {
                    // Fallback cho tr√¨nh duy·ªát c≈©
                    const textArea = document.createElement('textarea');
                    textArea.value = copyText;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('‚úÖ ƒê√£ copy d·ªØ li·ªáu v√†o clipboard!');
                }
                
            } catch (error) {
                console.error('L·ªói khi copy d·ªØ li·ªáu:', error);
                alert('‚ùå C√≥ l·ªói x·∫£y ra khi copy d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }

        function displaySharedFeedback(shareData) {
            try {
                // Hi·ªÉn th·ªã modal
                const modal = document.getElementById('aiFeedbackModal');
                modal.classList.add('show');
                
                // ·∫®n n√∫t "T·∫°o link chia s·∫ª" khi xem link chia s·∫ª
                const pdfBtn = document.querySelector('.pdf-export-btn');
                if (pdfBtn) {
                    pdfBtn.style.display = 'none';
                }
                
                // ƒêi·ªÅn th√¥ng tin h·ªçc vi√™n
                document.getElementById('studentInfo').innerHTML = `
                    <h3>üë§ Th√¥ng tin h·ªçc vi√™n</h3>
                    <p><strong>H·ªç t√™n:</strong> ${shareData.student.name}</p>
                    <p><strong>Email:</strong> ${shareData.student.email}</p>
                    <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${shareData.student.phone}</p>
                `;
                
                // Hi·ªÉn th·ªã k·∫øt qu·∫£ test n·∫øu c√≥ ƒëi·ªÉm s·ªë
                if (shareData.score !== undefined && shareData.score !== null) {
                    displayTestResultFromScore(shareData.score);
                } else if (shareData.listening && shareData.reading) {
                    // Fallback: t√≠nh ƒëi·ªÉm t·ª´ c√¢u tr·∫£ l·ªùi n·∫øu kh√¥ng c√≥ ƒëi·ªÉm t·ª´ database
                    const allAnswers = {};
                    if (shareData.listening.answers) {
                        shareData.listening.answers.forEach((answer, index) => {
                            allAnswers[index] = answer.text.split(': ')[1] || answer.text;
                        });
                    }
                    if (shareData.reading.answers) {
                        shareData.reading.answers.forEach((answer, index) => {
                            allAnswers[index + 5] = answer.text.split(': ')[1] || answer.text;
                        });
                    }
                    displayTestResult(allAnswers);
                }
                
                // Hi·ªÉn th·ªã ph·∫ßn Nghe
                if (shareData.listening) {
                    const listeningSection = document.getElementById('listeningSection');
                    const listeningGrid = document.getElementById('listeningGrid');
                    const listeningScore = document.getElementById('listeningScore');
                    
                    listeningSection.style.display = 'block';
                    listeningScore.textContent = shareData.listening.score;
                    listeningGrid.innerHTML = '';
                    
                    shareData.listening.answers.forEach(answer => {
                        const badge = document.createElement('div');
                        badge.className = `answer-badge ${answer.isCorrect ? 'answer-correct' : 'answer-incorrect'}`;
                        badge.innerHTML = `
                            ${answer.text} <span class="answer-icon">${answer.isCorrect ? '‚úì' : '‚úó'}</span>
                        `;
                        listeningGrid.appendChild(badge);
                    });
                }
                
                // Hi·ªÉn th·ªã ph·∫ßn ƒêi·ªÅn ƒê√°p √Ån
                if (shareData.reading) {
                    const readingSection = document.getElementById('readingSection');
                    const readingGrid = document.getElementById('readingGrid');
                    const readingScore = document.getElementById('readingScore');
                    
                    readingSection.style.display = 'block';
                    readingScore.textContent = shareData.reading.score;
                    readingGrid.innerHTML = '';
                    
                    shareData.reading.answers.forEach(answer => {
                        const badge = document.createElement('div');
                        badge.className = `answer-badge ${answer.isCorrect ? 'answer-correct' : 'answer-incorrect'}`;
                        badge.innerHTML = `
                            ${answer.text} <span class="answer-icon">${answer.isCorrect ? '‚úì' : '‚úó'}</span>
                        `;
                        readingGrid.appendChild(badge);
                    });
                }
                
                // Hi·ªÉn th·ªã b√†i vi·∫øt
                if (shareData.essay) {
                    const essayDisplay = document.getElementById('essayDisplay');
                    const essayText = document.getElementById('essayText');
                    
                    essayDisplay.style.display = 'block';
                    essayText.textContent = shareData.essay;
                }
                
                // Hi·ªÉn th·ªã nh·∫≠n x√©t AI
                if (shareData.feedback) {
                    const feedbackContent = document.getElementById('aiFeedbackContent');
                    const paragraphs = shareData.feedback.split('\n\n').filter(p => p.trim());
                    let formattedHTML = '';
                    
                    if (paragraphs.length > 0) {
                        paragraphs.forEach(para => {
                            const cleaned = para.trim().replace(/\n/g, '<br>');
                            formattedHTML += `<p>${cleaned}</p>`;
                        });
                    } else {
                        formattedHTML = `<p>${shareData.feedback.replace(/\n/g, '<br>')}</p>`;
                    }
                    
                    feedbackContent.innerHTML = formattedHTML;
                }
                
            } catch (error) {
                console.error('L·ªói khi hi·ªÉn th·ªã feedback:', error);
                alert('‚ùå C√≥ l·ªói khi hi·ªÉn th·ªã k·∫øt qu·∫£ b√†i test.');
            }
        }

        function checkForSharedLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const view = urlParams.get('view');
            const data = urlParams.get('data');
            const share = urlParams.get('share');
            
            if (view === 'feedback' && data) {
                try {
                    // ·∫®n to√†n b·ªô dashboard
                    document.querySelector('.container').style.display = 'none';
                    
                    // Thay ƒë·ªïi background body
                    document.body.style.background = 'linear-gradient(135deg, #74b9ff 0%, #0984e3 50%, #00b894 100%)';
                    
                    // Decode base64 v√† x·ª≠ l√Ω Unicode
                    const decodedData = decodeURIComponent(atob(data));
                    const shareData = JSON.parse(decodedData);
                    displaySharedFeedback(shareData);
                } catch (error) {
                    console.error('L·ªói khi decode d·ªØ li·ªáu:', error);
                    alert('‚ùå Link chia s·∫ª kh√¥ng h·ª£p l·ªá.');
                }
            } else if (share) {
                try {
                    // ·∫®n to√†n b·ªô dashboard
                    document.querySelector('.container').style.display = 'none';
                    
                    // Thay ƒë·ªïi background body v√† reset margin/padding
                    document.body.style.background = 'linear-gradient(135deg, #74b9ff 0%, #0984e3 50%, #00b894 100%)';
                    document.body.style.margin = '0';
                    document.body.style.padding = '0';
                    
                    // Parse d·ªØ li·ªáu share
                    const shareData = JSON.parse(decodeURIComponent(share));
                    
                    // Hi·ªÉn th·ªã modal t∆∞∆°ng ·ª©ng
                    if (shareData.type === 'hsk2') {
                        // T·∫°o allAnswers object t·ª´ listening v√† reading data
                        const allAnswers = {};
                        if (shareData.listening && shareData.listening.answers) {
                            shareData.listening.answers.forEach((answer, index) => {
                                // Extract answer from format like "1:true‚úì" -> "true"
                                const match = answer.text.match(/(\d+):(.+?)[‚úì‚úó]/);
                                if (match) {
                                    allAnswers[index] = match[2];
                                }
                            });
                        }
                        if (shareData.reading && shareData.reading.answers) {
                            shareData.reading.answers.forEach((answer, index) => {
                                // Extract answer from format like "36:A‚úì" -> "A"
                                const match = answer.text.match(/(\d+):(.+?)[‚úì‚úó]/);
                                if (match) {
                                    allAnswers[index + 35] = match[2];
                                }
                            });
                        }
                        
                        // T√≠nh ƒëi·ªÉm t·ªïng t·ª´ s·ªë c√¢u ƒë√∫ng (m·ªói c√¢u = 2 ƒëi·ªÉm)
                        let totalScore = 0;
                        if (shareData.listening && shareData.listening.score) {
                            totalScore += (parseInt(shareData.listening.score) || 0) * 2;
                        }
                        if (shareData.reading && shareData.reading.score) {
                            totalScore += (parseInt(shareData.reading.score) || 0) * 2;
                        }
                        
                        showHSK2Feedback(
                            shareData.student.name,
                            shareData.student.email,
                            shareData.student.phone,
                            '',
                            '',
                            allAnswers,
                            '',
                            totalScore
                        );
                    }
                } catch (error) {
                    console.error('L·ªói khi parse share data:', error);
                    alert('‚ùå Link chia s·∫ª kh√¥ng h·ª£p l·ªá.');
                }
            }
        }

        // Auto-detect v√† fix redirect URI issues
        function autoFixRedirectURI() {
            const currentDomain = window.location.origin;
            const currentPath = window.location.pathname;
            
            // Log current URL info
            console.log('üîç Current URL Info:', {
                origin: currentDomain,
                pathname: currentPath,
                href: window.location.href
            });
            
            // Check if we're on a path that might cause 404
            if (currentPath !== '/' && currentPath !== '/index.html') {
                console.warn('‚ö†Ô∏è Current path might cause 404:', currentPath);
                console.log('üí° Suggestion: Use redirect URI:', currentDomain);
            }
            
            // Log redirect URI for debugging
            console.log('üîó Redirect URI being used:', REDIRECT_URI);
        }

        // Handle Google OAuth redirect
        function handleOAuthRedirect() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (error) {
                console.error('OAuth error:', error);
                alert('L·ªói x√°c th·ª±c: ' + error);
                return;
            }
            
            if (code) {
                console.log('OAuth code received:', code);
                // Handle the authorization code if needed
                // For now, just clear the URL parameters
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Handle OAuth redirect
            handleOAuthRedirect();
            
            // Auto-fix redirect URI
            autoFixRedirectURI();
            
            // Initialize authentication
            setTimeout(() => {
                initializeGoogleAuth();
                initializeGmailAPI();
            }, 1000);

            // Check if user is already logged in
            if (!checkAuthStatus()) {
                // Show login modal if not authenticated
                document.getElementById('loginModal').classList.add('show');
            }

            document.getElementById('searchPhone').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchData();
            });
            document.getElementById('searchEmail').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') searchData();
            });

            // Event listeners cho email modal ƒë√£ ƒë∆∞·ª£c x√≥a v√¨ kh√¥ng c·∫ßn preview n·ªØa

            // ƒê√≥ng modal khi click b√™n ngo√†i
            document.getElementById('emailModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeEmailModal();
                }
            });

            // Ki·ªÉm tra link chia s·∫ª
            checkForSharedLink();
            
            // N·∫øu kh√¥ng c√≥ link chia s·∫ª v√† ƒë√£ ƒëƒÉng nh·∫≠p th√¨ load data
            if (!window.location.search.includes('view=feedback') && currentUser) {
                loadAllData();
            }
        });
    </script>
</body>
</html>